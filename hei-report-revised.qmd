---
title: "How Do Household Energy Transitions Work?"
author: 
  - Jill Baumgartner (Co-PI)
  - Sam Harper (Co-PI)
  - On behalf of the Beijing Household Energy Transitions Team
date: today
#format: 
#  html:
#    toc: true
#    number-sections: true

format: 
 pdf:
   # pdf-engine: latexmk
   # pdf-engine-opt: -xelatex
   toc: true
   keep-tex: true
   number-sections: true
   number-depth: 3
   include-in-header:
      - text: |
         \usepackage{wrapfig}
         \usepackage{colortbl}
          \makeatletter
          \renewenvironment{table}%
            {\renewcommand\familydefault\sfdefault
             \@float{table}}
            {\end@float}
          \renewenvironment{figure}%
            {\renewcommand\familydefault\sfdefault
             \@float{figure}}
            {\end@float}
          \makeatother
         \usepackage{changes}
   geometry: 
      - right=1in
      - left=1in
   fig-pos: H
bibliography: hei-report.bib
csl: environmental-health-perspectives.csl
---
```{r packages, echo=FALSE, message = FALSE, warning = FALSE}
library(here)
library(osfr)
library(tidyverse)
library(kableExtra)
library(modelsummary)
library(readxl)
library(marginaleffects)
library(tinytable)
library(tidymodels)
```

```{r functions, echo=F, message=F, warning=F}
source(here("code/functions", "process-columns.R"))
```

```{r master_data, include = FALSE, cache = TRUE, echo=FALSE}
# read in master data
bhet_master_data <- osf_retrieve_node("vxur5")
bhet_master_data %>%
  osf_ls_files("Master Dataset (Seasons 1-4)",
               pattern = "csv") %>%
  osf_download(path = here("data-clean"),
               conflicts = "overwrite")
```

## Abstract {.unnumbered .unlisted}

### Introduction {.unnumbered .unlisted}

Since 2015, thousands of villages across Beijing and northern China have been treated by a Coal Ban and Heat Pump (CBHP) subsidy policy that banned household coal burning and subsidized the cost of replacement with electric heaters and electricity. Whether this large-scale policy was successful in improving air quality and health remains an important and unresolved question. We estimated the effects of the CBHP policy on air quality and cardiopulmonary health in Beijing villages, and quantified how much of the policy’s effects on health were mediated by changes in air pollution and indoor temperature. 

### Methods {.unnumbered .unlisted}

In winter 2018-19 we enrolled 1003 participants in 50 Beijing villages that were eligible for, but not currently treated by, the CBHP policy and followed them over four consecutive winter data collection waves. In waves 1, 2 and 4, we administered questionnaires and measured participants’ anthropometrics, blood pressure (BP), airway inflammation (FeNO), and 24-h personal exposure to fine particulate matter (PM~2.5~). Fasting whole blood samples were obtained at clinic visits in waves 1 and 2 for analysis of glucose, lipid profile, and markers of inflammation and oxidative stress. Wintertime outdoor PM~2.5~ was measured in all 4 waves, and wintertime indoor temperature and PM~2.5~ were measured in waves 2, 3 and 4. The PM~2.5~ filters were analyzed for mass and chemical composition, which were used for source apportionment. To estimate the impacts of the policy we used a difference-in-differences design that accommodated the staggered rollout of the CBHP policy. We used 'extended' two-way fixed effects models and marginal effects to quantify the effect of the policy on air pollution and health. We further evaluated whether villages treated by the policy in different years respond differently to the policy, and if any of the observed health impacts of the policy were mediated through changes in air pollution or home (indoor) temperature.

### Results {.unnumbered .unlisted}

At baseline (wave 1), mean participant age was 60 y (SD=9.2), 60% were female, and most (63%) worked in agriculture. Geometric mean personal exposures to PM~2.5~ were twice as high as outdoor PM~2.5~ (72 versus 36 µg/m^3^), and the main source contributors were local and transported dust, regional and domestic coal and biomass burning, and aerosols that form through secondary formation. By waves 2, 3, and 4 there were a cumulative total of 10, 17, and 20 (out of 50 total) villages exposed to the CBHP policy. Uptake and adherence to the policy was high: among villages treated in wave 2, the proportion of households using heat pumps and coal heaters, respectively, changed from 3% and 97% in wave 1 to 94% and 3% in wave 4, with similar transitions in villages exposed to the policy in later waves. Marginal effects derived from multivariable extended two-way fixed effects models showed that exposure to the policy increased indoor temperature by 1-2°C and reduced indoor seasonal PM~2.5~ by approximately 36 µg/m^3^. Exposure to the policy also reduced contributions to PM~2.5~ from solid fuel sources,  including household coal burning, and improved blood pressure (~1.5 mmHg lower systolic and diastolic) and self-reported respiratory symptoms (~7 percentage point reduction in any symptoms). There was notable heterogeneity in effects across treatment cohorts, with larger benefits to indoor PM~2.5~ and health in villages treated in earlier relative to later years. In the mediation analysis, indoor PM~2.5~ and indoor temperature explained most of the total effect of the policy on systolic BP and roughly half of the total effect on diastolic BP, but did not explain improvements in self-reported respiratory symptoms. The policy did not show evidence of meaningful effects on outdoor or personal exposure to PM~2.5~, or on biomarkers of inflammation and oxidative stress. 

### Conclusions {.unnumbered .unlisted}

In this comprehensive field-based assessment of a real-world household energy policy in Beijing, we observed high fidelity and compliance with the CBHP policy. Exposure to the policy reduced blood pressure and self-reported chronic respiratory symptoms, and the effects for blood pressure were mediated by reductions in indoor PM~2.5~ and improvements in home temperature, providing empirical evidence that clean energy policies can provide population health benefits. 

\newpage

# Introduction

China is deploying an ambitious policy to transition up to 70% of households in northern China from residential coal heating to electric or gas “clean” space heating, including a large-scale roll out across rural and peri-urban Beijing, referred to in this document as China’s Coal Ban and Heat Pump (CBHP) subsidy policy. To meet this target the Beijing municipal government announced a two-pronged program that designates coal-restricted areas and simultaneously offers subsidies to night-time electricity rates and for the purchase and installation of electric-powered heat pumps to replace traditional coal-heating stoves. The policy was piloted in 2015 and, starting in 2016, was rolled out on a village-by-village basis. The variability in when the policy was applied to each village allowed us to treat the roll-out of the program as a quasi-randomized intervention and evaluate its impacts on air quality and health. Household air pollution is a well-established risk factor for adverse health outcomes over the entire lifecourse, yet there is no consensus that clean energy interventions can improve these health outcomes based on evidence from randomized trials [@lai2024]. Households may be differentially affected by the CBHP due to factors such as financial constraints and user preferences, and there is uncertainty about whether and how the policy may affect indoor and outdoor air pollution, as well as heating behaviors and health outcomes.

# Background

## Context for the policy

Beijing has a temperate continental monsoon climate that is characterized by cold, dry winters and hot, humid summers. Access to central heating is limited to urban areas and thus most peri-urban and rural households have historically heated their homes using coal heaters and biomass *kangs* (a traditional Chinese energy technology that integrates at least four different home functions including cooking, a bed for sleeping, space heating, and home ventilation). Household coal burning was a major contributor to indoor and outdoor air pollution in northern China, especially in winter. Prior to the CBHP policy, over 100 million rural households consumed ~200 million tons of coal to meet more than 80% of northern China’s residential space heating demand [@cdcgr2023], which contributed to roughly 30% of wintertime air pollution [@gbdmaps2016]. In 2013, coal combustion from industrial, electricity, and residential heating sources was the single largest estimated contributor to population exposure to PM~2.5~ in China and responsible for an estimated 366,000 annual premature deaths [@gbdmaps2016]. 

Banning residential coal burning and providing homes with clean heating alternatives through the CBHP policy was considered a potentially important intervention to improve rural development, reduce local and regional PM~2.5~, and mitigate air pollution-related health impacts. A number of clean heating options, including electric heat pumps, gas heaters, and electric resistance heaters with thermal storage, were widely promoted by the Chinese government [@cdcgr2023]. By 2021, over 36 million households in northern China were treated by the CBHP policy and an estimated 21 million additional households are expected to be treated by 2025. Whether this large-scale energy policy yielded air quality and health benefits remains a critical and unresolved question. 

## Prior evidence on household energy interventions and air pollution 

Household energy interventions, mostly cooking-related, that replace traditional solid fuel stoves with more efficient and less-polluting alternatives have been implemented and studied extensively in countries including China over the past several decades. While the introduction of cleaner household stoves is expected to reduce air pollution, their real-world effectiveness in achieving health-relevant air pollution reductions is unclear [@quansah2017]. In particular, the indoor and local air quality benefits of large-scale household energy programs like the CBHP subsidy policy have been rarely empirically investigated, especially at a sub-city spatial resolution. In Ireland, county-level residential coal bans in the 1990s were associated with 40-70% decreases in black smoke concentrations in ban-affected areas [@dockery2013]. In Australia, a wood-burning stove exchange lowered daily wintertime PM~10~ from 44 to 27 µg/m^3^ [@johnston2013], and clean energy policies in New Zealand were associated with 11-36% reductions in winter PM~10~ [@scott2011]. The few evaluations of the CBHP policy reported small decreases in outdoor PM~2.5~ (-7 to -2.4 µg/m^3^) in municipalities or prefectures treated by the policy compared with untreated neighboring regions [@niu2024; @song2023; @tan2023; @yu2021], and a recent modeling study estimated 36% lower personal exposure to PM~2.5~ based on household-reported changes in fuel use [@meng2023]. However, none of these studies included field-based measurements of air pollution or personal exposures, which are known to differ considerably from from modelled estimates based on assumptions of emissions reductions [@thompson2019], and few accounted for secular changes in air quality over time, limiting any conclusions about the causal effect of the policy on air quality.

## Prior evidence on clean energy interventions and cardiovascular outcomes

Most previous health assessments of household energy interventions have focused on cookstoves rather than heating technologies, though in many settings cookstoves are also used for space heating. Randomized trials of less polluting cookstoves generally indicate a cardiovascular benefit. In older Guatemalan women, a chimney stove intervention lowered exposure to air pollution and reduced the occurrence of nonspecific ST-segment depression [@mccracken2011]. Randomized trials in Guatemala, Nigeria, and Ghana also showed reductions in blood pressure (systolic range: -3.7 to -1.3 mmHg) in women assigned to gas, ethanol, or improved combustion biomass stoves. In contrast, recent single country (Peru) and large multi-country (Household Air Pollution Intervention Network, HAPIN) trials found no benefit of LPG stoves on blood pressure [@ye2022; @checkley2021] despite much larger reductions (~66% lower) in exposure to PM~2.5~ and black carbon than what was observed in trials showing a BP benefit of intervention [@johnson2022].

The few population-based evaluations of residential energy policies also suggest a cardio-respiratory benefit of clean energy transition. Residential wood-burning bans were associated with reductions in cardiovascular hospitalizations (-7%) in California [@yap2015] and with reduced cardiovascular (-17.9%) and respiratory (−22.8%) mortality in Australia [@johnston2013], though neither study fully controlled for  secular changes in health that were unrelated to the policy. Most relevant to our study are two quasi-experimental assessments of coal replacement policies. In Ireland, reductions in respiratory not but cardiovascular mortality were observed following a coal ban [@dockery2013]. A multi-city study of Chinese adults in cities where the CBHP policy was piloted compared with adults in cities not in the pilot observed small decreases in chronic lung diseases (-3.0 to -1.1%) but no change in physician-diagnosed cardiovascular diseases, potentially due to the short (one-year) post-policy evaluation period or confounding by other unmeasured city-wide air quality or health-related policies [@wen2023]. 

Though household air pollution is a well-established health risk factor, which energy interventions can reduce air pollution exposures, improve health, and are scalable and sustainable remains a critical and unanswered question. In a recent Official American Thoracic Society Statement, for example, the committee did not reach a consensus that household energy interventions (including gas, ethanol, solar, and improved biomass cookstoves) improved health outcomes (including respiratory symptoms and blood pressure), with 55% saying no and 45% saying yes [@lai2024]. 

## Evaluating the mechanisms through which policies may affect health outcomes. 

With several exceptions [@alexander2018; @gould2023; @mccracken2007; @mccracken2011], decades of household energy intervention studies have shown limited or no health benefit, which demonstrates the complexity of evaluating interventions on exposures like cooking or space heating that are central to daily life [@ezzati2017; @lai2024]. Energy interventions and policies, particularly those implemented at the household- or village-scales, can produce multiple behavioral, environmental, and health-related changes, making it important to investigate the mechanisms through which such policies exert their health impacts or lack of impacts [@dominici2014]. The health benefits achievable with transition from traditional coal stoves to a new electric home heating system, for example, may be influenced by factors including outdoor air quality [@lai2019], the desirability and usage patterns of new and traditional stoves [@ezzati2017], indoor temperature [@lewington2012], or behaviors including physical activity [@lindemann2017]. Only recently were such mediating factors considered in health assessments of household energy interventions, and rarely in a comprehensive or formalized way [@rosenthal2018]. Understanding such mechanisms can provide valuable insights into the success (or failure) of clean energy programs or policies like the CBHP in meeting their air quality and health targets, and may answer questions that can inform the design of more effective future energy interventions [@lai2024]. For example, is there successful uptake of the intervention or policy? Does the policy lead to heating behavior changes that result in colder homes which may offset any cardiovascular-enhancing effects of improved air quality? Answers to these questions are facilitated by the analysis of mediating pathways, a key aim of this study.

# Specific Aims and Overarching Approach

We used three data collection waves in winter 2018/19, winter 2019/20, and winter 2021/22, as well as a partial wave in winter 2020/21 to advance the following aims:

1. Estimate how much of the CBHP policy’s overall effect on health, including respiratory symptoms and cardiovascular outcomes (blood pressure, blood inflammatory and oxidative stress markers), can be attributed to its impact on changes in PM~2.5~;

2. Quantify the impact of the policy on outdoor air quality and personal air pollution exposures, and specifically the source contribution from household coal burning;

3. Quantify the contribution of changes in the chemical composition of PM~2.5~ from different sources to the overall effect on health outcomes.


# Study Design and Methods

## Study area 

Beijing is the capital of China (pop. 21.9 million in 2020) and covers a large geographic area (~16,000 km^2^) that includes a highly developed and densely-populated urban core that is surrounded by several satellite towns and thousands of peri-urban and rural villages in the periphery. Beijing winters begin in early November and tend to be cold, dry, and windy, with the lowest temperatures most often occurring in January (-3°C, on average), thus requiring space heating [@an2021]. Most urban areas of Beijing are connected to a central heating grid that supplies home heating from central locations, whereas rural and many peri-urban areas have historically relied on individual space heating units that, prior to 2015, were largely fueled by unprocessed coal [@duan2014].  

## Location and participant recruitment and enrolment

Between December 2018 and January 2019 we recruited 50 villages across 4 administrative districts (Fangshan, Huairou, Mentougou, and Miyun) in the Beijing municipality in northern China. The villages predominately used coal for heating at the time of enrollment and were eligible for but not currently participating in the CBHP policy. Roughly half of the villages were expected to enter into the policy during our study \comment{EC 10c} (@fig-cbhp-map). We used local guides in each village to help determine a roster of households that were not vacant during the winter months, from which we randomly selected households to recruit for participation. 


```{r, out.width = "90%"}
#| echo: FALSE
#| label: fig-cbhp-map
#| fig-cap: "Map of village implementation of CBHP policy. Each circle represents one recruited village. The colors of the circles indicate the year the villages were exposed to the household energy transition policy."

knitr::include_graphics(here("images", 
  "village-map.png"))
```

We recruited approximately 20 households in each village and, in each household, obtained a household roster. Our\comment{EC 2c} tablet-based survey incorporated a randomization tool than randomly ordered household occupants listed on the roster. We recruited a participant in each household by starting at the top of the randomly ordered list until an eligible participant was identified. Household members were eligible to participate if they were over 40 years old, lived in the study villages, were not planning to move out of the village in the next year, and were not on current immunotherapy or treatment with corticosteroids. Research staff introduced the study and its measurements to an eligible adult in each household and answered any questions related to the study. In follow-up visits to the study villages, staff first approached households with participants from an earlier wave. If previous participants were not at home or refused to participate, staff first tried to randomly recruit the next eligible participant listed on the randomized household roster. If\comment{EC 2d} there was not another eligible or willing participant in the same household, we randomly selected and recruited a participant from a new household using the same process for household and participant selection described above. All participants provided written informed consent prior to joining the study. The study protocols were approved by research ethics boards at Peking University (IRB00001052-18090), Peking Union Medical College Hospital (HS-3184) and McGill University (A08-E53-18B).

## Data Collection Overview

We conducted study measurements over four consecutive waves of data collection in winter 2018-19, 2019-20, 2020-21, and 2021-22 (referred to hereafter as Wave 1 [w1], w2, w3 and w4, respectively). Field data collection was conducted by ~20 trained staff members who traveled to participants’ homes to conduct tablet-based household and individual questionnaires, measure participant blood pressure, and distribute temperature sensors (for measurement of indoor temperature and stove use) and air pollution monitors in all 50 study villages in w1, w2, and w4. Anthropometrics (height, weight, and waist circumference), measurement of airway inflammation, and whole blood samples were obtained no more than a month later at a village clinic in w1 and w2. In w3, which was during the height of the COVID-19 pandemic, we limited household measurements to indoor air quality and sensor-based measurement of indoor temperature and stove use in 41 villages, including all 17 treated villages and 24 untreated villages, prior to COVID-19-related travel restrictions that halted field data collection. In w4, which also occurred during the COVID-19 pandemic, we returned to conducting individual-level assessments. However, unlike in w1 and w2, anthropometric measurements and airway inflammation were assessed in participant homes rather than clinics to avoid group contact, and blood samples were not collected. Outdoor (community) air pollution was measured throughout the study period.
 
### Air Pollution  

#### Outdoor air pollution 

In each village, two sensors for particulate matter air pollution were set up to measure outdoor (community) PM~2.5~ at different locations in each village. One sensor was placed near the center of the village, and the other was placed no less than 500m away from the centrally-located sensor. Sensors were placed at least 1.5m above the ground and not in a location within sight of a visible point source of PM~2.5~. 

We collected filter-based community PM~2.5~ samples to calibrate the sensor-based PM~2.5~ measurements as well as to conduct analysis of chemical composition for source apportionment. Ultrasonic Personal Aerosol Samplers (UPAS, Access Sensor Technologies, Fort Collins, CO, USA) were used to collect filter-based PM~2.5~ samples with a flow rate of 1.0 L/min [@volckens2017]. Samplers housed 37mm PTFE filters (VWR, 2.0µm pore size) and were equipped with a cyclone inlet with a 2.5µm cut point designed to perform under the sampling flow rate. For community measurements, a UPAS was co-located with each PM~2.5~ sensor in each village in rotation. Every week, the used filters were removed and replaced with a new filter. In total, we successfully collected 126, 371, and 289 filter-based, community outdoor PM~2.5~ samples in w1, w2, and w4, respectively. Field blank filters were collected at a rate of ~10%, subject to the same field conditions as samples. To support post-sampling determination of organic carbon (OC) and elemental carbon (EC) fractions of PM~2.5~ mass, quartz filters were co-located with a subset of Teflon filter samples collected outdoors. Quartz filter-based PM~2.5~ samples were collected using UPAS operating with a flow rate of 1.0 L/min. UPASs housed 37 mm quartz filters (VWR, 2.0-µm pore size) and were equipped with a cyclone inlet with a 2.5µm cut point designed to perform under the corresponding sampling flow rate. All quartz fiber filters were baked at 550 °C for a minimum of 8 h to remove organic impurities prior to sample collection. PM~2.5~ samples collected on quartz filters were analyzed using established thermo-optical methods for quantifying elemental carbon (EC) and organic carbon (OC) to, then, calibrate the colorimetric analysis of EC and OC on Teflon filters. In w2, 23 quartz-based outdoor PM~2.5~ samples and 3 field blanks were collected. In w4, 11 quartz-based outdoor PM~2.5~ samples and 3 field blanks were collected. 

For PM~2.5~ sensor calibration and quality control, all PM sensors were co-located with a reference-grade PM~2.5~ instrument (Model 5030 Synchronized Hybrid Ambient Realtime Particulate (SHARP) Monitor, Thermo Fisher Scientific, United States) on the rooftop of a building at Peking University campus and/or the Tapered Element Oscillating Microbalance (TEOM, Thermo Scientific™ 1405 TEOM™) at the Chinese Academy of Sciences University campus for 7 to 10 days before and after each field wave (@fig-calibration). Sensor-measured PM~2.5~ concentrations were highly correlated with those measured by the reference instruments (Spearman correlation coefficients (rho) >0.75 in each pre- and post-calibration).

```{r fig-calibration, echo=F, message = F, out.width = "80%"}
#| label: fig-calibration
#| fig-cap: "Calibration of real-time sensors against a reference monitor at University of the Chinese Academy of Sciences."

knitr::include_graphics(here("images",
  "sensor-calibration.png"))
```

#### Indoor PM~2.5~

In the second, third, and fourth data collection waves we randomly selected six households from the 20 recruited in each village to measure indoor concentrations of PM~2.5~. In w4, we aimed to monitor indoor PM~2.5~ in the same households where we measured indoor PM~2.5~ in w2. If a household dropped out of the project or declined indoor PM~2.5~ monitoring, we then recruited another household already enrolled in this study to measure indoor PM~2.5~. In total, indoor measurements were conducted in 300 households in both w2 and w4 and 246 households in w3 (@tbl-pm-sample).

```{r, message=F, warning=F}
#| echo: FALSE
#| label: tbl-pm-sample
#| tbl-cap: "Household recruitment for overall and indoor air quality measurements."
#| eval: TRUE

options(knitr.kable.NA = "\\")
tx <- tibble(
  p = factor(rep(c("New recruitment",
  "Wave 1 households", "Wave 2 households",
  "Total recruitment"),2), levels = c("New recruitment",
  "Wave 1 households", "Wave 2 households",
  "Total recruitment")),
  g = c(1,1,1,1,2,2,2,2),
  s1 = c(977,NA,NA,977, 0,NA,NA,0),
  s2 = c(196,866,NA, 1062, 300, 0,NA, 300),
  s4 = c(68, 780, 162, 1010, 52, 0, 248, 300)
)
tx2 <- tx %>% pivot_wider(names_from = g,
  values_from = c(s1, s2, s4), 
  names_vary = "slowest") %>%
  mutate(s3_2 = c(0,0,246,246)) %>%
  relocate(p,s1_1,s2_1,s4_1,s1_2,s2_2,s3_2,s4_2)

colnames(tx2) <- c("Sample", "Wave 1", "Wave 2", "Wave 4", 
    "Wave 1", "Wave 2", "Wave 3", "Wave 4")

tt(tx2) |>
 format_tt(replace = "-") |>
 group_tt(
  j = list(
     " " = 1,
     "Overall" = 2:4,
     "Indoor" = 5:8))

# kable(tx2, 
#   col.names = c("Sample", "Wave 1", "Wave 2", "Wave 4", 
#     "Wave 1", "Wave 2", "Wave 3", "Wave 4")) %>%
#   # "latex", booktabs = T) %>%
#   kable_styling() %>%
#   add_header_above(c(" " = 1, 
#                      "Overall" = 3, "Indoor" = 4))
```

Time-resolved indoor PM~2.5~ was measured using the same commercially available sensor (PMS7003 Plantower, Zefan, Inc.) used for outdoor sensor-based PM~2.5~ and recorded every 1 min. The sensor was placed on a table in a room where participants reported spending most of their time when awake. Indoor PM~2.5~ sensors were deployed between late November and mid January within field waves, depending on the village and household visit schedule. Measurement continued from the time of deployment until sensors were recollected from homes in late April to capture the full heating season.

We randomly selected three households with PM~2.5~ sensors to co-locate a filter-based PM~2.5~ sampler. We collected a 24-h PM~2.5~ filter sample during the first 24-h of indoor PM~2.5~ sensor measurements. Filter-based PM~2.5~ samples were collected using Ultrasonic Personal Aerosol Samplers (UPAS, Access Sensor Technologies) or Personal Exposure Monitors (PEMs, Apex Pro) operating  with flow rates of 1.0 and 1.8 L/min, respectively. Both samplers housed 37 mm PTFE filters (VWR, 2.0-μm pore size) and were equipped with a cyclone inlet with a 2.5 μm cut point designed to perform under the corresponding sampling flow rate. In total, we collected 149 and 148 indoor PM~2.5~ filter samples in w2 and w4, respectively.

As with the community outdoor air sampling, to support post-sampling determination of organic carbon (OC) and elemental carbon (EC) fractions of PM~2.5~ mass, quartz filters were co-located with a subset of Teflon filter samples collected in homes. Filter-based PM~2.5~ samples were collected using Personal Exposure Monitors (PEMs, Apex Pro) operating  with flow rates of 1.8 L/min. PEMs housed 37 mm quartz filters (VWR, 2.0µm pore size) and were equipped with a cyclone inlet with a 2.5µm cut point designed to perform under the corresponding sampling flow rate. All quartz fiber filters were baked at 550 °C for a minimum of 8 h to remove organic impurities prior to sample collection. PM~2.5~ samples collected on quartz filters were analyzed using established thermo-optical methods for quantifying elemental carbon (EC) and organic carbon (OC) to, then, calibrate the colorimetric analysis of EC and OC on Teflon filters. In w2, 71 quartz-based indoor PM~2.5~ samples and 14 field blanks were successfully collected. In w4, indoor PM~2.5~ samples for gravimetric analysis had to be collected on two types of PTFE sample media (Zefluor and Teflo filters), due to discontinuation of manufacturing of the Zefluor filter media. To ensure that quartz filters were deployed with both types of Teflon-based filter media, 73 quartz-based indoor PM~2.5~ samples were collected concurrently with Zefluor samples, and 47 quartz indoor PM~2.5~ samples were collected alongside Teflo samples. For indoor quartz PM~2.5~ mass sampling in w4, 18 field blanks were collected. 

#### Personal exposure to PM~2.5~ and black carbon

To measure personal exposure we used two types of samplers: Personal Exposure Monitors (PEMs, Apex Pro; Casella, UK) and Ultrasonic Personal Aerosol Samplers (UPAS, Access Sensor Technologies, Fort Collins, CO, USA). PEMs actively sampled air at a flow rate of 1.8 L/min, and UPAS sampled air at 1.0 L/min [@volckens2017]. Both samplers housed 37 mm PTFE filters (VWR, 2.0µm pore size) and were equipped with a cyclone inlet with a 2.5µm cutpoint. Sampler flow rates were calibrated the night before deployment and measured immediately after the sampling period. Only 2% of the post-sampling measurements deviated from the target flow rate by greater than +/-10%. Participants were instructed to wear a small waistpack (for the PEM and sampling pump) or an arm band or cross-body sling (for the UPAS) for 24-h, which they could remove from their body and place within 2 meters while sleeping, sitting, or bathing. Field blanks for personal air pollution exposure measurements were collected at a rate of ~10% in each village. 

#### Gravimetric analyses of PTFE filter-based PM~2.5~ samples

All filters were placed in individually labeled cases, sealed in plastic bags, and then transported to a field laboratory and immediately stored in a -20°C freezer. Following completion of the field sampling campaign, the samples and blanks were transported to Colorado State University, where they were stored in a -20°C freezer prior to gravimetric and chemical analysis.

All filters were placed in an environmentally-controlled equilibration chamber (21-22 °C, 30-34% relative humidity) for at least 24-h before tare and gross weighing [@lorange2021]. Before weighing we neutralized static charges by passing the filters over a polonium-210 strip. Filters were weighed on a microbalance (Mettler Toledo Inc., XS3DU, USA) with 1µg resolution in triplicate or more, until the differences among the last three weights were less than 3 μg. The average of three readings was used to determine filter mass, which was then blank-corrected using the median value of blank filters (3µg for UPAS-collected filters [53% of samples]; 33µg for PEM-collected filters [47% of filter samples]), and PM~2.5~ concentrations were calculated by dividing the mass by the sampled air volume.

#### Adjusting sensor-based PM~2.5~ using filter-based gravimetric measurements

We established linear regression models between the filter-based PM~2.5~ mass concentrations (i.e., the ‘gold standard’ reference) and the sensor-based PM~2.5~ concentrations averaged over the same sampling period as the filter-based samples. The slopes of the models were used as the adjustment factors for the sensor-based PM~2.5~ concentrations. Separate regression models were conducted for indoor and outdoor sensors and for each data collection wave given the sensitivity of the sensors to relative humidity, temperature, and particle sources, which may differ for indoor versus outdoor conditions and across waves In w3, where only sensor-based measurements were conducted for indoor PM~2.5~, we applied an adjustment factor developed from a linear regression model that incorporated data from both w2 and w4. 

The PM sensors were also evaluated before and after each data collection wave to identify any sensors that needed further repair or replacement. The PM~2.5~ sensors underwent a calibration process that began with synchronization to real-time PM~2.5~ monitors at Peking University (PKU) campus. This pre- and post-wave calibration included a week-long session using the Beta Attenuation Monitor (BAM) alongside daily 24-hour filter samples. During this time, approximately 240 sensors were placed on the rooftop of the College of Urban and Environmental Sciences building, each recording data every minute. A similar approach was taken at the University of Chinese Academy of Sciences (UCAS) campus, where around 400 PM sensors were installed on the rooftop of the Environmental Monitoring Site of the College of Resources and Environment, with data logging at one-minute intervals. Daily collections of 24-hour PTFE and quartz filter samples accompanied the sensors’ measurements to ensure accuracy. The calibration process was repeated post-fieldwork to account for any potential shifts or discrepancies in sensor performance. This approach aimed to maintain consistent and accurate measurements from the PM sensors throughout the study.

#### Chemical analysis of PM mass

We analyzed the chemical composition of community and personal exposure PM~2.5~ samples to quantify the individual components and species. PM~2.5~ component concentrations were determined by dividing the quantified component mass by the sampled air volume, after correcting for field blanks collected in the corresponding wave.

Elemental analysis of PM~2.5~ mass was performed using a Thermo Scientific Quant'X Evo energy-dispersive X-ray fluorescence (EDXRF) spectrometer with Wintrace software version 10.3 using standard methods [@rtiinternational2009]. Quantitative mass concentrations of 22 individual elements (Mg, Al, Si, S, K, Ca, Ti, Cr, Mn, Fe, Ni, Cu, Zn, Ga, As, Se, Cd, In, Sn, Sb, Te, I) were determined empirically using linear standard curves. Standard curves were generated from commercial, single and dual element, thin film standards from MicroMatter Technologies Inc. (Montreal, Canada) in addition to blank films. The quality of the analysis method was evaluated by analyzing a National Institute of Standards and Technology (NIST) standard reference material (SRM) 2783 Air particulate on filter media (Gaithersburg, MD, USA). Elements for which at least 80% of PM~2.5~ mass samples yielded quantifiable element mass were included for positive matrix factorization and source analysis and apportionment. Those elements were: Si, Mg, Fe, S, Ca, Al, K, Pb. 

For analysis of water-soluble ions, a portion of each PTFE filter was extracted in 15 mL deionized water (DI Water) in a Nalgene Amber HDPE bottle using sonication without heat for 40 min. The extracts were filtered to ensure that insoluble particles were removed using a 0.2 μm PTFE syringe filter. Water-soluble ions were measured using a dual channel Dionex ICS-3000 ion chromatography system. Specifically, a Dionex IonPac CS12A analytical (3 × 150 mm) column with eluent of 20 mM methanesulfonic acid at a flow rate of 0.5 mL/min was used to measure cations (Ca2+, Mg2+, Na+, NH4+, K+), while a Dionex IonPac AS14A analytical (4 × 250 mm) column with an eluent of 1 mM sodium bicarbonate/8 mM sodium carbonate at a flow rate of 1 mL/min was used to measure anions (SO42−, NO3−, Cl−) (Sullivan et al., 2008).

Organic (OC) and elemental carbon (EC) on PTFE filters were measured using an optical color space sensing system. The CIE-Lab color space optical sensing system measures the optical properties of the PM~2.5~ samples, and these properties are used to develop the EC and OC predictive models. The CIE-Lab color system is a color-opponent space that includes all of the color models, with dimension L* for lightness and a* and b* for the color-opponent dimensions. More information about the CIE Lab color space system, its formulation, and its specific application to the analysis of OC and EC fractions of fine particulate matter pollution is provided in Khuzestani et al. [@khuzestani2017]. Briefly, all the Teflon (PTFE) and quartz filters collected were analyzed using the i1Pro Colorimeter (X-Rite, INC. Grand Rapids, MI). The colorimeter sensor was placed directly over the filters, and the color components were measured under the D65 instrument internal illumination light source. Each sample was analyzed in triplicate, and the average value of each color coordinate was applied as the optical
property of the sample [@olson2016]. CIE Standard Illuminant D65 simulates average midday light and is a commonly used standard illuminant, as defined by the International Commission on Illumination (CIE). The CIE-Lab color space response variables were used in separate random forest models for EC and OC. 

The reference measurements for the random forest model development were EC and OC determined from quartz filters collected indoors and outdoors (as described above). PM~2.5~ samples collected on quartz filters were analyzed for OC and EC using a Sunset Laboratory OC/EC Lab instrument (Sunset Laboratories, Inc., MODEL, USA) according to the default Sunset Analyzer protocol. A section of each quartz filter underwent a combined thermal desorption-optical transmittance measurement based on NIOSH methods 5040 to differentiate and quantify the EC and OC components in mass. For the thermal desorption component, the sample is oxidized twice, according to a strict temperature regime. The first oxidation stage thermally removes OC in a mobile phase of pure helium gas to be converted from carbon dioxide (CO2) to methane (CH4) gas and measured by a flame ionization detector (FID). The second oxidation stage proceeds in a mixture of helium and oxygen to oxidize EC, which is also quantified by the FID. The FID is internally calibrated with methane, and external quality control checks are made with sucrose standards. To correct for the potential production of EC by OC pyrolysis during the first heating stage, light transmission from a laser through the filter section was monitored throughout analysis. Reduced light transmittance corresponds to EC generated by the laboratory analysis. 

Following gravimetric analysis, all PTFE filters were also analyzed for black carbon (BC) using an optical transmissometer data acquisition system (SootScan^TM OT21 Optical Transmissometer; Magee Scientific, Berkeley, CA, USA). Light attenuation through each filter was measured before and after sampling in the field. To calculate BC mass, the difference between the pre- and post- light attenuation was converted to a mass surface loading using the classical Magee mass absorption cross-sections of 16.6 m^2^/g for the 880 nm channel optical BC [@ahmed2009]. BC concentrations were calculated by multiplying surface loadings by the sampled surface area of the filters (8.6 cm^2^ for UPAS-collected filters; 7.1 cm^2^ for PEM-collected filters), correcting for the field blank mass using the median value of blanks (0.31 μg for UPAS-collected filters; 0.01 μg for PEM-collected filters), and finally dividing by the sampled air volume. 

For statistical analysis, we estimated the effect of the policy on personal exposures to PM~2.5~ and BC using the results from filter-based measurements collected over 24-h periods. We measured indoor and outdoor PM~2.5~ for up to 6 months in our study households, and thus we calculated both the 24-h mean values (to coincide with the same 24-h period that personal exposure samples were collected) and the wintertime seasonal mean values (with winter ‘season’ defined as January 15 to March 15) of PM~2.5~.

### Outdoor and indoor (household) air temperature 

Hourly outdoor temperature and relative humidity data were obtained from the extensive network of meteorological [stations](http://beijingair.sinaapp.com) in Beijing. We used digital thermometers (Tianjianhuayi Inc., Beijing, China) to measure indoor ‘point’ temperature in the five minutes prior to BP measurement. Staff measured temperature in a centrally located room, away from heating sources and direct sunlight, by placing the probe in mid-air at a height that approximated the participant's shoulder height. In a random 75% subsample of households in each wave, we also conducted long-term measurements of indoor temperature by placing a real-time temperature sensor (iButton DS1921G-F5; Thermochron, Maxim Inc., USA) in the room where participants reported spending most of their daytime hours when indoors. Sensors were wall-mounted at a standardized height (~1.5 to 2 meters), away from major heating sources, windows, and doors, and were programmed to log a temperature reading every 125 minutes for up to 4 months to capture the full winter period and early spring weeks when heating may still intermittently occur. Prior to the start of each wave, we co-located all of the sensors and measured temperature over two days and compared the readings. Sensors recording values >1°C from the group median value were excluded from data collection. 

### Objective measurement of household stove use using sensors 

Following methods used in a previous intervention evaluation study in rural China [@clark2017], we objectively measured household heating stove use in a random sample of households selected, also at random, for either short- or long-term measurement. We measured short-term (24-h) stove use for all household heating stoves in 315 and 227 households in w2 and w3, respectively. Long-term stove use was assessed in 324, 273, and 585 homes in w2, w3, and w4, respectively, for a period of ~6 months. We measured stove use using the same real-time temperature data loggers used to measure seasonal indoor temperature (iButton DS1921G-F5; Thermochron, Maxim Inc., USA). Field staff placed the sensors on stoves and programmed them to record surface temperature every 125 minutes, a timing decision based on pilot assessments showing that shorter time intervals did not affect the number of heating events detected or heating time recorded. Sensors were placed on the surfaces of biomass and coal-fuelled stoves and radiators. For heat pumps, sensors were placed on the heat exchanger coil on air-to-air units and on the radiator of air-to-water units. 

The number and duration of stove combustion events were identified from the temperature data using criteria defined based on the observed changes in the peak shape of the time series temperature curves (i.e., changes in the slope or in absolute temperature compared with the indoor ambient temperature). This approach was specific to heating stoves but developed based on stove use identification for cookstoves in previous studies by us and others [@clark2017; @ruiz-mercado2013; @snider2018]. We developed separate criteria for each stove type given the observed stove-specific differences in heating patterns. These criteria were coded into stove-specific algorithms to systematically identify the number and duration of heating events across households. A stratified random sample of stove use temperature files (15% for each stove type and measurement duration - short-term/24 h or long-term/~6 mo - combination) were manually coded to develop the test criteria. The number and duration of heating events were identified by the algorithms in the remaining 85% of files. We compared heating periods identified manually with those identified by the algorithm to check for systematic differences and possible overfitting.  

### Questionnaires

Field staff administered household and individual-level questionnaires to assess household demographic information and educational attainment, household assets, house structure, stove and fuel use patterns (including a complete roster of heating methods and their contributions in each room), and individual health behaviors including exercise frequency, smoking, alcohol consumption, medication use, and clinician-diagnosed health conditions. We used Surveybe computer-assisted personal interview (CAPI) software to collect survey data via handheld electronic tablets. Questions were read to participants in Mandarin-Chinese, and their responses were recorded into tablets. 

Prior to the start of data collection, all questions were translated from English into Chinese and then back-translated to English for quality assurance. Many questions were adapted from previous field studies of household energy and blood pressure conducted in rural Beijing or other rural sites in China  [@baumgartner2018; @yan2020], and all questions were iteratively tested with staff and adapted prior to implementation. Prior to each wave in this study, the questionnaire and other study measurements were tested in 12 households located in a Beijing village that was eligible for our study but was instead selected for testing. We used the test village to assess whether the questions were understandable and interpreted as intended and to identify any problems with the study measurements or their implementation. Study protocols were subsequently adapted prior to the start of data collection.

In addition to household and individual participant questionnaires, we conducted village surveys with one representative from each village committee to understand how the policy was implemented in that village and to inquire about any other rural development or health programs being implemented in the village. Committee members answered questions about committee and villager interest in the policy and, for treated villages, assignment versus application to the policy, any home or village renovations required by the upper-level government prior to heat pump installation, decision-making for the type and brand of heating technology, level of subsidies provided for heaters and electricity, and technical and logistic guidance to villagers.

### Blood pressure 

Following 5 min of quiet rest, at least three brachial and central systolic (bSBP/cSBP) and diastolic (bDBP/cDBP) blood pressures (BPs) were taken by trained staff at 1 min apart on the participant's supported right arm. We used an automated oscillometric device (BP+; Uscom Ltd, New Zealand) that estimates central pressures from the brachial cuff pressure fluctuations. Central pressures were validated against invasive cBP measurements in previous studies [@costello2015; @lowe2009]. The BP devices were factory calibrated by the manufacturer prior to the start of the first and fourth waves. Up to five measurements were taken if the difference between the last two was >5 mmHg or staff were unable to obtain a reading. The BP measurements were conducted in the participant's home and staff were trained to follow strict quality control procedures, including use of an appropriately sized cuff, correct positioning of the arm, both feet on the ground, and ensuring 5 min of quiet rest before measurement. Details are described in the standard operating procedures [(SOP)](https://osf.io/gmka5). The average of the final two measurements was used for statistical analysis unless only one BP measurement was obtained (n = 13 observations), in which case a single measurement was used. The time of day, day of the week, and indoor temperature prior to BP measurement were also recorded.

### Self-reported respiratory symptoms and airway inflammation

During questionnaire assessment, participants were asked about chronic airway symptoms including cough, phlegm, wheeze, and tightness in the chest using questions validated for use in Mandarin-Chinese and developed from the standard St. George's Respiratory Questionnaire. The Mandarin-Chinese questions were extensively piloted with rural and peri-urban Beijing residents to ensure that the health terminology and symptom time patterns were adequate and understandable to the local population. 

In a ~25% random subsample of participants, we also measured the fractional concentration of exhaled nitric oxide (FeNO), a non-invasive and established marker of airway inflammation, using a portable handheld device (Aerocrine, Solna, Sweden) fit with a NIOX VERO® sensor, following ATS recommendations and guidelines (ATS/ERS 2005). Briefly, FeNO measurement was performed with participants in a standing position. They inhaled NO-free air through a mouthpiece with an NO-scrubber attached, followed by controlled expiration for 10 s through the mouthpiece at 50±5 mL/s. A nose clip was used to avoid nasal inhalation, and accurate flow rate was achieved using visual and auditory cues generated by the device. Detailed methods are provided in our previous study of air pollution and FeNO in Beijing adults [@shang2020]. At least two measurements were obtained for each participant.

### Blood inflammatory and oxidative stress markers  

Trained nurses collected 20 ml of whole blood in a labeled vacutainer via venipuncture using standard techniques [@tuck2009]. Details are described in our published [SOP](https://osf.io/zwpfg). Briefly, fasting blood samples were collected by experienced phlebotomists (nurses) in the morning and stored at 4-10°C prior to centrifugation. Two serum aliquots from each participant were then placed in a -30°C freezer for temporary storage. Collection-to-storage time was <4 hrs for all samples in both waves where blood samples were collected. Within 3-5 days of collection, the samples were transported in styrofoam containers with dry ice to a -80°C freezer with a backup generator and alarm system at Peking University. 

The first aliquot was analyzed for glucose and a complete lipid profile within two months of collection, and results were communicated to participants. The second aliquot was stored in the -80°C freezer for analysis of biomarkers of systemic inflammation (C-reactive protein [CRP], interleukin-6 [IL-6], tumour necrosis factor alpha [TNF-$\alpha$] and malondialdehyde [MDA]) at the University of the Chinese Academy of Sciences between July and September of 2023. These biomarkers were selected because they are associated with the development of cardiovascular disease and events [e.g., @danesh2008; @ERF2012; @pearson2003; @ridker2000; @ridker2001], and both acute and longer-term exposures to air pollution have been associated with changes in inflammatory and oxidative stress markers [e.g., @huang2012; @kipen2010; @pope2004; @rich2012; @ruckerl2007].

We followed standard methods for analysis [@fda2018]. For inflammatory markers (IL-6, TNF-$\alpha$, CRP), the optic densities (OD) of all samples were measured using an automated ELISA reader. Every plate had 8 standard samples used to generate a standard curve that related OD and standard inflammatory marker concentration. A standard curve for each microplate was generated by a computer software program based on a 4-parameter method. Each plate included at least 3 control samples to ensure the stability of standard curves. All samples, standards, and controls were measured in duplicate, and the average was used for statistical analysis. For oxidative stress biomarkers (MDA), the chromatographic peak areas of all samples were measured using HPLC with UV detector and HPLC-MS/MS. Every plate had 7 standard samples used to generate a standard curve that related peak area and concentration of each standard oxidative stress marker. A standard curve for each plate was generated using a computer software program based on a linear method. Each plate included at least 3 control samples to ensure the stability of standard curves. Standards and controls were measured in duplicate and samples were measured once due to high precision in a pilot study [@fda2018].

### Anthropometric measurements. 

Body weight, height, and waist circumference were measured at the clinic visit in the first two waves and in participant homes in the last wave. Weight was measured in light indoor clothing without shoes in kilograms to one decimal place, using standing scales supported on a steady surface. The scales were calibrated prior to the start of each wave, and the same staff member stepped on the scale each morning to ensure that it was functioning properly. Height was measured without shoes in centimeters to one decimal place with a stadiometer. Waist circumference was measured without clothing obstruction at one centimeter above the participant’s navel at minimal respiration in centimeters to one decimal place. The measuring tape was replaced at the start of each wave to avoid stretching. 

## Measuring policy impacts

To understand how Beijing’s policy works we used a difference-in-differences (DiD) design [@callaway2020], leveraging the staggered rollout of the policy across multiple villages to estimate its impact on health outcomes and understand the mechanisms through which it works. Simple comparisons of treated and untreated (i.e., control) villages after the CBHP policy has been implemented are likely to be biased by unmeasured village-level characteristics (e.g., migration, average winter temperature, wealth) that are associated with health outcomes. Similarly, comparisons of only treated villages before and after exposure to the program are susceptible to bias by other factors associated with changes in outcomes over time (i.e., secular trends, impacts of the COVID-19 pandemic). By comparing the *changes* in outcomes among treated villages to the *changes* in outcomes among untreated villages, the DiD approach controls for any unmeasured time-invariant characteristics of villages as well as for any general secular trends affecting outcomes in all villages that are unrelated to the policy.

```{r didfig, echo=F, out.width="75%", eval=T}
#| label: fig-didfig
#| fig-cap: 'Stylized example of difference-in-differences'

knitr::include_graphics(here("images", "ddfig.png"))
```

The DiD design compares outcomes before and after an intervention in a treated group relative to the same outcomes measured in a control group. The control group trend provides the crucial "counterfactual" estimate of what would have happened in the treated group had it not been treated. By comparing each group to itself, this approach helps to control for both measured and unmeasured fixed differences between the treated and control groups. By measuring changes over time in outcomes in the control group unaffected by the treatment, this approach also controls for any unmeasured factors affecting outcome trends in both treated and control groups. This is important since there are often many potential factors affecting outcome trends that cannot be disentangled from the policy if one only studies the treated group (as in a traditional pre-post design).

The canonical DiD design [@card1994] compares two groups (treated and control) at two different time periods (pre- and post-intervention, @fig-didfig). In the first time period both groups are untreated, and in the second time period one group is exposed to the intervention. If we assume that the differences between the groups would have remained constant in the absence of the intervention (the parallel trends assumption), then an unbiased estimate of the impact of the intervention in the post-treatment period can be calculated by subtracting the pre-post difference in the untreated group from the pre-post difference in the treated group. The estimand of interest in a typical DiD analysis is the average treatment effect on the treated (i.e, the $ATT$), which is a contrast of the post-intervention outcomes in the treated group with the counterfactual estimate of outcomes in the same population in the absence of treatment.   

When multiple groups are treated at different time periods, the most common approach has been to use a two-way fixed effects model to estimate the impact of the intervention which controls for secular trends and differences between villages. However, recent evidence suggests that traditional two-way fixed effects estimation of the treatment effect may be biased in the context of heterogeneous treatment effects, i.e., where the effects of treatment vary for different groups treated at different time periods [@callaway2021;@goodman-bacon2021]. The bias is due to the fact that the two-way fixed effects estimate is a weighted average of several ‘2 x 2’ DiD estimates, some of which involve using already treated units as controls for later treated units, which can lead to bias [@baker2022].  We take advantage of new developments in the econometrics literature [@callaway2021; @sun2021; @wooldridge2021] that relax the assumption of homogeneity in the context of staggered policy rollouts but also allow straightforward interpretation of $ATT$s for assessing policy impacts. This decision was motivated by the many behavioral, social, or economic factors that might affect both new heat pump use and coal stove suspension (e.g., energy prices and availability, wintertime temperature, COVID-19 pandemic, user preferences) over time in our study, and thus the possibility that the effect of the policy on air pollution and health may be dynamic over time and/or heterogeneous across treatment cohorts. 

## Measuring pathways and mechanisms

To estimate how much of the CBHP intervention may work through different mechanisms, we used causal mediation analysis. Causal approaches to mediation attempt to discern between, and clarify the necessary assumptions for identifying, different kinds of mediated effects. Taking as an example the directed acyclic graph (DAG) in @fig-dag1, with $T$ as the policy, $X$ as a set of pre-treatment covariates, $M_{1}$ as PM~2.5~, $M_{2}$ as indoor temperature, and $Y$ as systolic blood pressure, we can define the controlled direct effect ($CDE$) as the effect of the CBHP policy on systolic blood pressure if we fix the values of PM~2.5~ and indoor temperature to a fixed reference level for the entire population. For example, we can estimate the impact of the policy on health outcomes while holding PM~2.5~ and indoor temperature at uniform levels of average background exposure, or some other hypothetical level.

```{r dag1, echo=F, out.width="60%", eval=T}
#| label: fig-dag1
#| fig-cap: 'Hypothetical Directed Acyclic Graph showing direct and indirect effects with outcome ($Y$), pre-treatment covariates ($X$), policy ($T$), multiple mediators ($M_{1},M_{2}$), as well as covariates for the mediators ($W$).'

knitr::include_graphics(here("images", "dag1.png"))
```

Although other mediated effects such as “natural” direct and indirect effects are theoretically estimable [@vanderweele2015], they involve challenging "cross-world" assumptions that are difficult to anchor in policy [@naimi2014]. Other approaches to mechanisms have focused on principal stratification [e.g., @zigler2016], although conceptual difficulties with identifying the (unverifiable) principal strata make it challenging for questions of mediation. Because controlled direct effects are considered more directly policy relevant for public health, we focused on estimating these mediated quantities.

# Data Analysis

To understand how the policy’s impact on health may be mediated by different potential mediators, we need to first estimate the total effect of the policy on the outcomes, then estimate the $CDE$s after adjustment for potential mediators and any residual mediator-outcome confounding. As discussed above, in order for the mediators to ‘explain’ the total effects of the policy on health, the policy should affect the mediators, and the mediators should also affect the outcomes. 

## Total Effect
To estimate the total effect of the policy we used a DiD analysis that accommodates staggered treatment rollout. To allow for heterogeneity in the context of staggered rollout we used 'extended' two-way fixed effects (ETWFE) models [@wooldridge2021] to estimate the total effect of the CBHP policy. The mean outcome (replaced by a suitable link function $g(\cdot)$ for binary or count outcomes) was defined using a set of linear predictors:

$$Y_{ijt}=g(\mu_{ijt}) = \alpha + \sum_{r=q}^{T} \beta_{r} d_{r} + \sum_{s=r}^{T} \gamma_{s} fs_{t}+ \sum_{r=q}^{T} \sum_{s=r}^{T} \tau_{rt} (d_{r} \times fs_{t}) + \varepsilon_{ijt}$$ {#eq-etwfe}

where $Y_{ijt}$ is the outcome for individual $i$ in village $j$ at time $t$, $d_{r}$ represent treatment cohort dummies, i.e., fixed effects for cohorts of villages that were first exposed to the policy at the same time $q$ (e.g., in 2019, 2020, or 2021), $fs_{t}$ are time fixed effects corresponding to different winter data collection waves (2018-19, 2019-20, or 2021-22), and $\tau_{rt}$ are the cohort-time $ATT$s in the context of a linear model. For binary or count outcomes the cohort-time $ATT$s are derived by estimating marginal effects from non-linear models [@arel-bundock2024]. For all models we cluster standard errors at the village level, consistent with the unit of treatment assignment [@cameron2015]. The ETWFE and other approaches that allow for several (potentially heterogeneous) treatment effects may also be averaged to provide a weighted summary $ATT$. Several potential possibilities are feasible, including weighting by treatment cohorts or time since policy adoption [@goin2023]. We generally focus on two types of $ATT$s for this report: simple averages across all treatment cohorts and the full set of cohort-time $ATT$s to evaluate heterogeneous treatment effects. Although we primarily focus on reporting the simple average $ATT$ for most outcomes, we also used omnibus joint *F*-tests to assess whether there was sufficient evidence to reject the assumption of homogeneity across the $ATT$s.

## Mediation Analysis
As noted above, with respect to the mediation analysis we are chiefly interested in the $CDE$, which can be derived by adding relevant mediators $M$ to @eq-etwfe. If we also allow for exposure-mediator interaction and potentially allow for adjustment for confounders $W$ of the mediator-outcome effect, we can extend equation @eq-etwfe as follows:

$$
\begin{aligned}
Y_{ijt}=g(\mu_{ijt}) = \alpha + \sum_{r=q}^{T} \beta_{r} d_{r} + \sum_{s=r}^{T} \gamma_{s} fs_{t}+ \sum_{r=q}^{T} \sum_{s=r}^{T} \tau_{rt} (d_{r} \times fs_{t}) \\ + \delta M_{it} + \sum_{r=q}^{T} \sum_{s=r}^{T} \eta_{rt} (d_{r} \times fs_{t} \times M_{it}) + \zeta \mathbf{W} + \varepsilon_{ijt}
\end{aligned}
$$ {#eq-etwfem}

where now $\delta$ is the conditional effect of the mediator $M$ at the reference level of the treatment (again, represented via the series of group-time interaction terms), and the collection of $\eta$ terms are coefficients for the product terms allowing for mediator-treatment interaction. Finally, $\zeta$ is a vector of coefficients for the set of confounders contained within $\mathbf{W}$. 

As noted above, in the staggered DiD framework that allows for heterogeneity we do not have a single treatment effect but a collection of group-time treatment effects that may be averaged in different ways. This extends to the estimation of the $CDE$, in which case we will also have several $CDE$s that can be averaged to make inferences about the extent to which the policy's impact is mediated by PM~2.5~. Based on the setup in @eq-etwfem the $CDE$ is estimated as: $\delta + \eta_{rt}MT$. In the absence of interaction between the exposure and the mediator (i.e., $\eta_{rt}=0$) the $CDE$ will simply be the estimated treatment effects $\sum_{r=q}^{T} \sum_{s=r}^{T} \tau_{rt}$, i.e., the effect of the policy holding $M$ constant. For a valid estimate of the $CDE$ we must account for confounding of the mediator-outcome effect, represented by $W$ in the equation above. The inclusion of baseline measures of both the outcome and the proposed mediators inherent in our DiD strategy help to reduce the potential for unmeasured confounding of the mediator-outcome effect [@keele2015]. Given the large number of outcomes of interest in this study, as well as the potential for heterogeneous treatment effects, we limited the mediation analysis to health outcomes for which we observed a total effect of the CBHP policy. 

## Identification of potential confounders and model covariates 

In contrast to typical analytic approaches such as regression adjustment or propensity scores that solely focus on measured covariates, our DiD approach helps to minimize the risk of some sources of *unmeasured* confounding. Treatment cohort fixed effects control for measured and unmeasured time-constant factors that may differ between treatment cohorts (e.g., genetics, altitude), and time fixed effects control for secular trends, capturing any unmeasured factors that affect outcomes in all treatment cohorts (including the untreated) similarly over the study period (e.g., background improvements in ambient air quality or household transition to more efficient heating). The latter are particularly helpful in the context of the documented declines in PM~2.5~ in China attributable to sources other than the CBHP policy [@vandonkelaar2021; @zhang2019]

For models estimating the effect of the policy on health outcomes, we used DAGs [@pearl2000] to identify potential time-varying causes of both treatment by the policy and our study outcome(s) that could differ between treatment groups, and adjusted for those potential confounders in the regression models. For the mediation analysis, we identified potential mediator-outcome confounders using the same approach. These variables were identified from the relevant peer-reviewed literature and our team’s substantive knowledge about the CBHP policy. In the multivariable models, we also adjusted for strong predictors of the outcome that were not affected by treatment, and thus not confounders, to improve model precision. The covariates included in each of the models are provided in the tables. 

For air pollution outcomes, we considered the following covariates: village population and total number of households in the village; temperature, relative humidity, wind direction, wind speed, boundary layer height; home area and home area heated; home insulation; smoking status of participant and whether or not they lived with a smoker; whether or not the household reported using wood (i.e., biomass) for household energy activities, and if so, self-reported quantity of wood. Potential non-linearity between continuous covariates and our study outcomes were evaluated using natural cubic splines with different degrees of freedom. Ultimately, the following covariates were included in the final DiD models for outdoor, indoor, and personal exposures to air pollution, based on whether measurable changes in the covariate over time were observed. For the final adjusted DiD model for personal exposure source contributions due to mixed combustion of solid fuels (hereafter ‘mixed combustion’), we adjusted for: temperature (represented by a spline with 2 degrees of freedom); participant smoking status; and whether or not the household reported using biomass fuel. For the final adjusted DiD model for outdoor (community) ‘mixed combustion’ source contributions, the following covariates were included: total number of households in the village; village population; and ambient relative humidity (represented by a spline with 2 degrees of freedom). 

##  Multiple imputation for covariates and indoor PM~2.5~ in analyses with BP outcomes

Blood pressure was measured at household visits but several key covariates like waist circumference, height, and weight were measured at the clinic visits in w1 and w2. Thus, we were missing covariate information for individuals who were unable to attend the clinic visits (~15-20% of participants in each wave). Additionally, since we only measured indoor PM~2.5~ in a subsample of 300 homes in w2 and w4, we were missing indoor PM~2.5~ for all participants in w1 with BP measures, as well as for a sub-sample of participants in w2 and w4. To prepare data for the BP outcomes analysis we used multiple imputation with chained equations (MICE) to impute missing covariate data and missing indoor PM~2.5~ values for individuals who participated in the household visit but not the clinic visit. This allowed us to retain observations with BP measurements that would have otherwise been dropped in adjusted and mediation models using complete-case analysis. Imputation was performed with the *MICE* package [@vanbuuren2011] in *R* (m = 30 imputation datasets, with 30 iterations each), and the difference-in-differences and mediation analyses were conducted for each of the 30 datasets. We then used Rubin’s Rules to combine point estimates and standard errors while accounting for both within- and between-dataset variances [@rubin1987]. In Appendix @fig-afig-mi we show kernel density plots for the distribution of imputed values for BMI, waist circumference, and indoor PM~2.5~, all of which closely approximated the observed values.  


# Results

We retained all 50 study villages during this four-year longitudinal assessment of village treatment by the CBHP policy, though we were only able to visit 41 villages in winter 2020-21 (w3) and were limited to village and household-level measurements of air quality, indoor temperature, and stove use in that wave due to restrictions during the COVID pandemic. 

By w2, w3, and w4 there were a cumulative total of 10, 17, and 20 (out of 50 total) study villages treated by the CBHP policy, respectively. All of the treated villages selected to install electric-powered air-source heat pumps with 200 RMB per meter square (up to 24,000 RMB) in subsidies and were also provided with 80% night-time electricity subsidies up to 10,000kWh per heating season. To limit coal use, villages enrolled in the policy were no longer allowed to place orders for subsidized coal with the district-level governments that manage the procurement and distribution of coal for residential heating in Beijing. In addition, village committee leaders in treated villages reported feeling accountable to the Environmental Protection Department for limited coal-related air pollution, and were motivated to encourage residents to not burn coal. Some villages were equipped with government air pollution monitors and the Environmental Protection Department conducted village inspections and issued warnings about coal burning. Households burning coal in treated villages were at risk of losing their electricity subsidy. 

Appendix @fig-flowchart shows the participation of villages, households, and participants across the four waves of data collection. We conducted measurements in over 1000 participants in each of the three measurement waves that included individual-level measurements. In total, we enrolled 1432 participants into the study, of which 630 (43%) individual contributed 1890 observations across all three waves, 443 (31%) individuals contributed 886 observations across two waves and 365 (25%) individuals participated in a single wave. @tbl-each-campaign shows selected demographic characteristics and health behaviors between participants who contributed to each study wave. We find no differences in gender or smoking across waves, but overall BMI and waist circumference increased over time.\comment{EC 4b} @tbl-diff-campaign shows similar measures according to whether or between participants in each of the three waves with individual measurements. 

```{r, echo=F, message=F, warning=F}
# read in the data
ds <- read_csv(here("data-clean", 
  "BHET_master_data_05Mar2024.csv"),
  col_select = c("wave", "gender_health", "age_health",
    "smoking", "waist_circ", "height", "ptc_id", 
    "weight", "lived_with_smoker", "ID_VILLAGE")) %>%
  filter(wave != 3) %>%
  mutate(catvar = recode_factor(wave, 
    `1` = "1", `2` = "2", `4` = "3"),
    bmi = (weight / (height/100)^2),
    female = if_else(gender_health == 2 & !is.na(gender_health),
      1, 0),
    csmoke = if_else(smoking==1 & !is.na(smoking), 1, 0),
    asmoke = if_else(smoking < 3, 1, 
      if_else(smoking==3 & lived_with_smoker %in% 
                                    c(2,3), 1, 0))) %>%
  mutate(across(c(female, csmoke, asmoke), as.integer))
```

```{r, warning=F, message=F}
#| echo: FALSE
#| tbl-cap: Demographic and health characteristics of participants in each study wave.
#| label: tbl-each-campaign
#| eval: TRUE
  
# Columns of interest
columns_of_interest <- c("female", "csmoke", "asmoke", 
  "bmi", "age_health", "waist_circ")

# Apply the function to the data set
result <- process_columns(ds, columns_of_interest)

t2 <- result %>%
  mutate(char = c(
    "Female, n (%)", 
    "Current smoker, n (%)",
    "Any smoke exposure, n (%)", 
    "Age in years, Mean (SD)",
    "BMI (kg/m2), Mean (SD)", 
    "Waist circumference (cm), Mean (SD)")) %>%
  rename("Characteristic" = char)

colnames(t2) <- c("Characteristic", 
  "Wave 1 (2018-19) N=1003", "Wave 2 (2019-20) N=1110",
  "Wave 4 (2021-22) N=1028", "Statistic", "p-value")

tt(t2,
   width = c(.4, .15, .15, .15, .1, .1),
   notes = list(a = list(i=0, j=5,
     text = "Chi-square test for categorical and F-test for continuous characteristics."))) |>
  group_tt(
    j = list(
      " " = 1,
      "Estimates" = 2:4,
      "Test for Equality" = 5:6)) |>
  format_tt(escape = TRUE) |>
  style_tt(j = 1:4, align = "llll")
```


```{r, warning=F, message=F}
#| echo: FALSE
#| tbl-cap: "Demographic and health characteristics of participants who contributed to different numbers of study waves."
#| label: tbl-diff-campaign
#| eval: TRUE

# revise data set to identify participants 
# by number of waves contributed
ds <- ds %>%
  select(-catvar) %>%
  filter(wave != 3) %>%
  add_count(ptc_id) %>%
  mutate(catvar = recode_factor(n, 
    `1` = "1", `2` = "2", `3` = "3")) 

# apply function across selected columns
# Columns of interest
columns_of_interest <- c("female", "csmoke", "asmoke", 
  "bmi", "age_health", "waist_circ")

# Apply the function to the data set
result <- process_columns(ds, columns_of_interest)

t3 <- result %>%
  mutate(char = c(
    "Female, n (%)", 
    "Current smoker, n (%)",
    "Any smoke exposure, n (%)", 
    "Age in years, Mean (SD)",
    "BMI (kg/m2), Mean (SD)", 
    "Waist circumference (cm), Mean (SD)")) %>%
  rename("Characteristic" = char)

colnames(t3) <- c("Characteristic", 
  "1 Wave N=365", "2 Waves N=886",
  "3 Waves N=1890", "Statistic", "p-value")

tt(t3,
   width = c(.4, .15, .15, .15, .1, .1),
   notes = list(a = list(i=0, j=5,
     text = "Chi-square test for categorical and F-test for continuous characteristics."))) |>
  group_tt(
    j = list(
      " " = 1,
      "Estimates" = 2:4,
      "Test for Equality" = 5:6)) |>
  format_tt(escape = TRUE) |>
  style_tt(j = 1:4, align = "llll")
```

## Description of study sample

```{r make_table1, message=FALSE, cache=TRUE, echo=FALSE, eval=T}
# select variables for table
d <- read_csv(here("data-clean", 
  "BHET_master_data_05Mar2024.csv"),
  col_select = c("hh_id", "ptc_id", "gender_health",
    "ban_status_no", "age_health", "education_health",
    "smoking", "freq_drink", "sys_brachial", 
    "dia_brachial", "waist_circ", "height",
    "weight", "temp", "wave", "PM25conc_exposureugm3",
    "freq_cough", "freq_phlegm", "freq_wheezing", 
    "freq_breath", "freq_no_chest"))
dt <- d %>%
  # restrict to baseline
  filter(wave==1) %>%
  # select variables for inclusion
  # select(ban_status_no, age_health, )
  mutate(ever_trt = ifelse(ban_status_no==0, 1 ,0),
    et = recode_factor(ever_trt, `0` = "Never treated", 
      `1` = "Ever treated"),
    `Age (years)` = age_health,
    `Female (%)` = ifelse(gender_health==2, 100, 0),
    `No education (%)` = ifelse(education_health==4, 100, 0),
    `Primary education (%)` = ifelse(education_health==1, 100, 0),
    `Secondary+ education (%)` = ifelse(
      education_health %in% c(2,3), 100, 0),
    `Never smoker (%)` = ifelse(smoking==3, 100, 0),
    `Former smoker (%)` = ifelse(smoking==2, 100, 0),
    `Current smoker (%)` = ifelse(smoking==1, 100, 0),
    `Never drinker (%)` = ifelse(freq_drink==1, 100, 0),
    `Occasional drinker (%)` = ifelse(freq_drink %in% 
      c(2:8), 100, 0),
    `Daily drinker (%)` = ifelse(freq_drink==9, 100, 0),
    `Systolic (mmHg)` = sys_brachial,
    `Diastolic (mmHg)` = dia_brachial,
    `Waist circumference (cm)` = waist_circ,
    `Body mass index (kg/m2)` = weight / (height/100)^2,
    `Frequency of coughing (%)` = 
      if_else(freq_cough < 3, 100, 0),
    `Frequency of phlegm (%)` = 
      if_else(freq_phlegm < 3, 100, 0),
    `Frequency of wheezing (%)` = 
      if_else(freq_wheezing < 3, 100, 0),
    `Shortness of breath (%)` = 
      if_else(freq_breath < 3, 100, 0),
    `Chest trouble (%)` = 
      if_else(freq_no_chest < 3, 100, 0),
    `Any respiratory problem (%)` = if_else(
      freq_cough < 3 |
      freq_phlegm < 3 |
      freq_wheezing < 3 |
      freq_breath < 3 |
      freq_no_chest < 3, 100, 0),
    `Temperature (°C)` = temp,
    `Personal PM2.5 (ug/m3)` = PM25conc_exposureugm3) %>%
  select(et, `Age (years)`, `Female (%)`, `No education (%)`, 
    `Primary education (%)`, `Secondary+ education (%)`, 
    `Never smoker (%)`, `Former smoker (%)`, 
    `Current smoker (%)`, `Never drinker (%)`, 
    `Occasional drinker (%)`, `Daily drinker (%)`,
    `Systolic (mmHg)`, `Diastolic (mmHg)`,
    `Waist circumference (cm)`,
    `Body mass index (kg/m2)`, 
    `Frequency of coughing (%)`,
    `Frequency of wheezing (%)`,
    `Shortness of breath (%)`,
    `Chest trouble (%)`,
    `Any respiratory problem (%)`,
    `Temperature (°C)`,
    `Personal PM2.5 (ug/m3)`)
# caption <- '\\label{#tbl-table1}Descriptive statistics, by treatment status'
reference <- ''
# add empty rows for categorical variables
# grouped categories
nrn <- c("Demographics:", "Health measures:",
  "Environmental measures:")
# empty data frame
nr <- data.frame(matrix(ncol = 7, nrow = length(nrn)))
nr$X1 <- nrn
nr[is.na(nr)] <- " "
# placement in table
attr(nr, 'position') <- c(1, 7, 23)
options(modelsummary_format_numeric_latex = "plain")
```

```{r, message=FALSE, warning=F}
#| echo: FALSE
#| tbl-cap: Descriptive statistics for selected demographic, health, and environmental measures at baseline, by treatment status.
#| label: tbl-desc
#| eval: TRUE


t1 <- datasummary_balance(~et, data = dt, 
  add_rows = nr, align = "rrrrrrr",
  notes = reference) %>%
  style_tt(j = 1:7, fontsize = 0.75) %>%
  style_tt(i = c(1,7,23), bold=TRUE)
t1
```

@tbl-desc shows the distribution of selected demographic, health, and environmental characteristics from the baseline survey, prior to any villages being enrolled in the CBHP policy. We provide means and standard deviations separately for villages that eventually enter into the policy with those that never do so. As noted above, although our DiD identification strategy allows for fixed differences between treated and untreated villages, overall the differences at baseline are generally small and the groups seem well balanced on most measures, with the exception of personal exposure to PM~2.5~, which was lower in villages that were eventually treated.

## Summary of PM and BC measurements

At baseline, PM~2.5~ and BC concentrations were higher, on average, for personal exposures compared with outdoor concentrations. From w2 onward, with the inclusion of indoor air pollution measurements, personal exposure air pollution concentrations were still higher than indoor or outdoor concentrations, with indoor levels being higher than outdoors (@tbl-pm-season). This trend (personal > indoor > outdoor) was observed among households in treated and untreated villages. Personal, indoor, and outdoor geometric mean (95% confidence interval) concentrations of PM~2.5~ were 72 (65, 80), 45 (39, 53), and 31 (28, 35), respectively, and elevated relative to health-based guidelines. The current World Health Organization (WHO) guidelines state that annual average concentrations of PM~2.5~ should not exceed 5 µg/m^3^, while 24-hour average exposures should not exceed 15 µg/m^3^ for more than 3 to 4 days per year [@who2021]. Interim targets have been set to support the planning of incremental milestones toward cleaner air, particularly for cities, regions, and countries with higher air pollution levels. For PM~2.5~, the four interim (IT) targets for annual and 24-h means are: IT-1: 35 and 75 µg/m^3^; IT-2: 25 and 50 µg/m^3^; IT-3: 15 and 37.5 µg/m^3^; and IT-4: 10 and 25 µg/m^3^ [@who2021]. In our study, baseline personal exposures to PM~2.5~ did not even meet IT-1, indicating considerable opportunity for air quality exposure reduction with intervention. 

```{r, message = F, warning=F}
#| echo: FALSE
#| tbl-cap: Arithmetic and geometric means for air pollutant concentrations (micrograms per cubic meter) by wave.
#| label: tbl-pm-season
#| eval: TRUE

ap_season <- read_csv(here("data-clean", 
  "ap-conc-season.csv"))

tap <- ap_season %>%
  select(-time, -substance) %>%
  pivot_longer(
    cols = Mean_S1:GM_S4,
    names_to = c("avg", ".value"),
    names_pattern = "(.*)_S(.)") %>%
  pivot_wider(
    names_from = metric,
    values_from = c(`1`, `2`, `3`, `4`)
  ) %>%
  select(-category)

colnames(tap) <- c("", "", "",  
                         "Est.", "CI", "Est.", "CI", "Est.", "CI", 
                         "Est.", "CI")
tt(tap, 
  width = c(3.5, 3, 1, 0.5, 2, 0.5, 2, 0.5, 2, 0.5, 2),
  notes = "Note: Est. = Estimate, CI = 95 percent confidence interval, GM = Geometric Mean") %>%
  format_tt(replace = "") %>%
  group_tt(
    j = list("Wave 1" = 4:5, "Wave 2" = 6:7,
      "Wave 3" = 8:9, "Wave 4" = 10:11),
    i = list("Personal measurements" = 1, 
             "Indoor measurements" = 5,
             "Outdoor measurements" = 11)) %>%
  style_tt(i = c(1, 6, 13), align = "l", bold=T) %>%
  style_tt(
    i = c(2, 4, 7, 9, 11, 14, 16, 18), j = 2, 
    rowspan = 2, alignv = "t") %>%
  style_tt(
    i = c(2, 9, 16), j = 1, rowspan = 4, alignv = "t") %>%
  style_tt(
    i = c(7, 14), j = 1, rowspan = 2, alignv = "t") %>%
  style_tt(j=1:11, fontsize = 0.8) %>%
  style_tt(i = 0, align = "c")

```

We also present the geometric and arithmetic means (and 95% confidence intervals) for PM~2.5~ and BC in each measurement wave (@tbl-pm-season). Wave 3 (2020/2021) was a partial wave that took place over a time period impacted by the COVID-19 pandemic and did not involve filter-based air pollution sample collection.

## Policy uptake

Each year of the study, participants reported the types of fuels and stoves and the amount of fuel used for space heating in winter. Based on these data, heating energy types were classified into four categories: exclusive use of a heat pump ("Heat pump exclusively"), use of a heat pump and a biomass-fueled kang ("Heat pump with biomass kang"), use of solid fuel heater with an electric heating devices other than heat pumps ("Coal stove and/or biomass kang with electric heater’), and exclusive use of solid fuel (‘Coal stove and/or biomass kang’). In villages treated by the policy, @fig-sankey shows meaningful transitions from solid fuel to electric-powered heat pumps for all treatment cohorts. For example, the proportion of households in the group treated in 2019 (w2) using heat pumps increased from 3% in w1 to 93% in w2 and 96% in w4. Conversely, use of coal stoves decreased from 97% in w1 to 8% in w2 and 3% in w4. We observed similar stove use transitions for households in villages treated in 2020 (w3). In the three villages treated in 2021, we observed overall less exclusive use of the heat pump and a slightly larger proportion of households continuing to use coal. 


```{r fig-sankey, echo=F, message=F, warning=F, out.width="100%"}
#| label: fig-sankey
#| fig-cap: "Transitions to different energy sources across study waves"
knitr::include_graphics(here("images", 
  "sanky.jpg"))
```

We also observed a substantial decline in the amount of self-reported coal used in villages treated by CBHP policy (Appendix @fig-afig-coal), though the reduction in coal use was smaller with each subsequent treatment cohort (Appendix @tbl-fuel-did). Biomass (i.e., wood logs/twigs or charcoal), usually burned in kangs for both cooking and space heating, was not expressly targeted by the CBHP policy. We observed declines in self-reported biomass use in villages treated in 2019 and 2020, but there was a small increase in biomass consumption in the cohort treated last (2021).  

In never treated villages, we also observed a transition to clean energy over the four year study but it was much slower than in treated villages. The proportion of households that reported using electric heat pumps increased from 5% in w1 to 10% in w2 and 25% in w4, and those who adopted heat pumps tended to use them exclusively. Commensurately, the reported expenditures on electricity increased gradually over time in the untreated villages (data not shown). The percentage of untreated households using solid fuel with other types of electric devices remained relatively stable, ranging from 64% to 70% across waves. Self-reported use of biomass also remained stable, at approximately one ton of fuel each winter, whereas exclusive use of solid fuel decreased from 30% in w1 to 7% in w4.   

## Aim 1: Policy impacts and potential mediation

### Impact of the CBHP policy on potential mediators

The average marginal effect ($ATT$) from the basic ETWFE model (@tbl-did-med) shows that exposure to the CBHP policy reduced 24h indoor PM~2.5~ by -19 µg/m^3^ (95%CI: -61, 22). After adjusting outdoor temperature, dewpoint, household smoking status, and the number of residents in each household, the $ATT$ decreased to -14 µg/m^3^ (95%CI: -54, 26). The impact was stronger on seasonal indoor PM~2.5~, with an average $ATT$ of -36 µg/m^3^ (95%CI: -61, -12) that was robust to covariate adjustment. This finding likely reflects the direct benefit of the policy in replacing coal stoves and air quality improvement. We found little evidence of heterogeneity in $ATT$s across cohort and time (all p-values > 0.385 for tests of heterogeneity, see Appendix @tbl-a-het-indoor).

```{r, message=F, warning=F}
#| echo: FALSE
#| label: tbl-did-med
#| tbl-cap: Treatment effect on outdoor and indoor PM~2.5~, personal exposure to PM~2.5~ and black carbon, and measures of indoor temperature. Outdoor and indoor PM~2.5~ were derived from sensor measurements after being adjusted based on co-located gravimetric PM~2.5~ measurements. 24h indicates the mean PM~2.5~ concentrations during the 24 hours when personal exposure samples were collected in each village. 'Seasonal' indicates the seasonal mean PM~2.5~ concentrations in each village, from Jan. 15th to Mar. 15th.
#| eval: TRUE

# air pollution results
ap_table <- read_rds(here("outputs", 
  "ap-etwfe-table.rds")) 

# temperature results
temp_table <- tibble(
  category = "Point", outcome = "Mean", estimate_1 = 1.96,
  ci_1 = "(0.96, 2.96)", estimate_2 = 1.96, 
  ci_2 = "(0.96, 2.96)"
)

stemp_table <- read_xlsx(here("data-clean",
  "overall_temp_table.xlsx")) %>%
  rename(`estimate_1` = att,
         `ci_1` = ci) %>%
  mutate(category = rep("Seasonal", times = 6),
    outcome = c("Mean (all)", "Mean (daytime)", 
      "Mean (heating season)", "Mean (daytime heating season)",
      "Min. (all)", "Min. (heating season)"),
    estimate_2 = `estimate_1`, 
    ci_2 = `ci_1`) %>%
  select(-model) %>%
  relocate(category, outcome)

# join tables
m_table <- bind_rows(ap_table, temp_table, 
  stemp_table)

colnames(m_table) <- c(" ", " ", "ATT", "(95% CI)", 
  "ATT", "(95% CI)")

tt(m_table,
   digits = 2,
  #width = c(3.5, 3, 1, 0.5, 2, 0.5, 2, 0.5, 2, 0.5, 2),
  notes = list("Note: ATT = Average Treatment Effect on the Treated, DiD = Difference-in-Differences, ETWFE = Extended Two-Way Fixed Effects.", a = list(i=0, j=5,
     text = "ETWFE models for air pollution outcomes were adjusted for household size, smoking, outdoor temperature, and outdoor humidity. Temperature models not additionally adjusted."))) %>%
  group_tt(
    j = list("DiD" = 3:4, 
             "Adjusted DiD" = 5:6),
    i = list("Air pollution" = 1, 
             "Indoor temperature" = 7)) %>%
  style_tt(i = c(1, 8), align = "l", bold=T) %>%
  style_tt(
    i = c(2, 4, 6), j = 1, 
    rowspan = 2, alignv = "t") %>%
  style_tt(
    i = 10, j = 1, rowspan = 6, alignv = "t") %>%
  style_tt(j = 1:6, align = "llcccc") %>%
  format_tt(escape = TRUE) %>%
  format_tt(j=c(3,5), sprintf = "%.2f") 
```

Overall we found little evidence of an impact of the CBHP policy on 24-h and seasonal outdoor (community) PM~2.5~ or personal exposures to PM~2.5~ and BC. Treatment was associated with lower, but statistically imprecise, personal 24-h BC exposures. This finding is consistent with the expectation that the policy contributed to reducing air pollutant emissions from solid fuel burning, as BC serves as a potential indicator of such combustion.

With respect to the other potential mediator of temperature, @tbl-did-med shows that exposure to the CBHP policy increased mean household point temperature by around 2°C (95%CI: 1, 3), with similar impacts on mean seasonal temperatures during the heating season. The CBHP policy had considerably stronger impacts on average seasonal minimum temperatures, which increased by 3.8°C (95%CI: 2.3, 5.4). 

### Impact of the CBHP policy on health outcomes

```{r, message=F, warning=F}
#| echo: FALSE
#| label: tbl-did-health
#| tbl-cap: "Overall impacts of the ‘coal-to-clean energy’ policy on blood pressure, respiratory outcomes, and inflammatory markers"
#| eval: TRUE

# bp results from Talia
bp_policy_t <- tibble(
  category = rep(c("Systolic BP", "Diastolic BP", 
    "Pulse Pressure", "BP Amplification x10"), each=2),
  outcome = c("Brachial","Central","Brachial",
    "Central", "Brachial","Central", "Pulse pressure",
    "Systolic BP"),
  estimate_1 = c(-0.79, -1.04, -1.29, -1.35, 0.50,
    0.31, 0.10, 0.20),
  ci_1 = c("(-2.63, 1.04)", "(-2.82, 0.73)",
    "(-2.62, 0.04)", "(-2.66, 0.04)", "(-0.71, 1.70)",
    "(-0.85, 1.46)", "(-0.12, 1.40)", "(-0.20, 0.50)"),
  estimate_2 = c(-1.40, -1.56, -1.60, -1.66, 0.21,
    0.10, 0.00, 0.10),
  ci_2 = c("(-3.31, 0.51)", "(-3.40, 0.28)",
    "(-2.96, -0.25)", "(-2.97, -0.34)", "(-1.00, 1.41)",
    "(-1.01, 1.20)", "(-1.20, 1.20)", "(-0.20, 0.40)")
)

# respiratory results
r_table <- read_rds(here("data-clean",
  "resp-did.rds"))

# FeNO results
feno_table <- tibble(
  category = "Measured", outcome = "FeNO (ppb)", estimate_1 = 0.17,
  ci_1 = "(-2.24, 2.58)", estimate_2 = 0.55, 
  ci_2 = "(-2.13, 3.13)"
)

inf_table <- tibble(
  category = " ", 
  outcome = c("IL6", "TNF-alpha",	"CRP",	"MDA"),
  estimate_1 = c(6.8, 24.3, 2.7, 7.6),
  ci_1 = c("(-12.2, 30.0)", "(-1.3, 56.4)", 
           "(-19.8, 31.6)", "(-8.7, 26.9)"),
  estimate_2 = c(5.9, 24.7, 3.8, 6.5),
  ci_2 = c("(-13.80, 30.20)", "(-0.90, 54.20)", 
           "(-19.40, 33.60)", "(-9.70, 25.5)")
)

# join tables
op_table <- bind_rows(bp_policy_t, r_table, 
 feno_table, inf_table)

colnames(op_table) <- c(" ", " ", "ATT", "(95% CI)", 
  "ATT", "(95% CI)")

tt(op_table,
   digits = 2,
   #width = c(3.5, 3, 1, 0.5, 2, 0.5, 2, 0.5, 2, 0.5, 2),
   notes = list("Note: ATT = Average Treatment Effect on the Treated, DiD = Difference-in-Differences, ETWFE = Extended Two-Way Fixed Effects, pp = percentage points, ppb = parts per billion.", a = list(i=0, j=5, text = "ETWFE models for blood pressure models adjusted for #age, sex, waist circumference, smoking, alcohol consumption, and #use of blood pressure medication."))) %>%
  group_tt(
    j = list("DiD" = 3:4, 
             "Adjusted DiD" = 5:6),
    i = list("Blood pressure (mmHg)" = 1, 
             "Respiratory outcomes" = 9,
             "Inflammatory markers (%)" = 16)) %>%
  style_tt(i = c(1, 10, 18), align = "l", bold=T) %>%
  style_tt(
    i = c(2, 4, 6, 8), j = 1, 
    rowspan = 2, alignv = "t") %>%
  style_tt(
    i = 11, j = 1, rowspan = 6, alignv = "t") %>%
  style_tt(j = 1:6, align = "llcccc") %>%
  format_tt(escape = TRUE) %>%
  format_tt(j=c(3,5), sprintf = "%.2f") 
#
#kable(op_table,  digits = 2,
#  col.names = c(" ", " ", "ATT", "(95% CI)", 
#   "ATT", "(95% CI)"), "latex", booktabs = T,
#  longtable = T,
#  linesep = "", align = 'llcccc') %>%
#  kable_styling(full_width = F) %>%
#  collapse_rows(columns = 1:2, valign = "top") %>% 
#  pack_rows("Blood pressure (mmHg)", 1, 8) %>%
#  pack_rows("Respiratory\noutcomes", 9, 15) %>%
#  pack_rows("Inflammatory\nmarkers (%)", 16, 19) %>%
#  add_header_above(c(" " = 2, 
#    "DiD" = 2, "Adjusted DiD\\\\textsuperscript{a}" = 2),
#    escape = F) %>%
#  footnote(
#    general = "\\\\small{Note: ATT = Average Treatment Effect on #the Treated, DiD = Difference-in-Differences, pp = percentage #points, ppb = parts per billion.}",
#    alphabet = "\\\\small{Blood pressure models adjusted for age, #sex, waist circumference, smoking, alcohol consumption, and use of #blood pressure medication.}", 
#    general_title = "", threeparttable = T, escape = F)
```

@tbl-did-health shows the impacts of the policy on blood pressure in basic ETWFE models and models further adjusted for age, sex, waist circumference, smoking, alcohol consumption, and use of blood pressure medication. Overall exposure to the CBHP policy demonstrated reductions in blood pressure of approximately 1.5 mmHg for both systolic and diastolic BP, but we found little evidence of a meaningful impact on pulse pressure or BP amplification. The effects on brachial and central blood pressures were similar. However, the average effects in @tbl-did-health conceal a fair amount of heterogeneity in treatment effects for blood pressure across treatment cohorts and time. Appendix @tbl-bp-het shows that treatment impacts were considerably stronger for the earlier compared to the later-treated cohorts. For example, the CBHP policy reduced central DBP in the year of treatment by -2.7 mmHg (95%CI: -4.6, -0.8) for the villages first treated in wave 2, but increased central DBP by 1.1 mmHg (95%CI: -0.1, 2.2) for the villages treated in wave 4 (*p*-value for heterogeneity <0.0001).   

@tbl-did-health shows the impacts on self-reported chronic respiratory symptoms categorized as any symptoms and separately for each individual symptom type. In both basic and covariate-adjusted ETWFE models, exposure to the CBHP policy reduced self-report of any poor respiratory symptoms by around 7 percentage points (95%CI: -14, -1). This was largely through reductions in reports of having chest trouble or difficulty breathing on several or most days of the week. Appendix tables [-@tbl-a-het-resp], [-@tbl-a-het-cough], [-@tbl-a-het-phlegm], [-@tbl-a-het-wheeze], [-@tbl-a-het-breath], [-@tbl-a-het-nochest] show little evidence of any systematic heterogeneity in the cohort-time treatment effects across the different respiratory outcomes.   

@tbl-did-health also shows the impacts of the CBHP policy on FeNO, which was conducted in a sub-sample of 511 participants, including 274 participants with one measurement, 142 with two measurements, 95 participants with 3 measurements. We did not find evidence that the policy affected changes in FeNO in the covariate-adjusted ETWFE model (0.5 ppb, 95%CI: -2.1, 3.1). There was some evidence of heterogeneity in the FeNO effects of the policy by treatment cohort, though the confidence intervals for each of the cohort-specific effects were large and overlapping (Appendix . Our results did not change with sensitivity analyses that limited the analysis to participants with at least two repeated measurements and to those who participated in all three waves (Appendix @tbl-a-feno) 

### Mediated impact on health outcomes

As noted above, we aimed to assess whether any health impacts of the CBHP policy may work specifically through pathways involving changes in PM~2.5~ and indoor temperature. Below we show results from several mediation models. We evaluated potential mediation for each mediator (indoor temperature and exposure to indoor PM~2.5~) separately and in a single model accounting for multiple mediators, and we set the values of both mediators to the  mean value for untreated participants at baseline (wave 1). For mediation analysis, we focused on BP outcomes for which we observed an effect of the policy. In @tbl-bp-med we show that conditioning on indoor PM~2.5~ and indoor temperature largely explains the entire total effect of the CBHP policy on blood pressure for systolic BP, as the CDE conditional on both mediators was reduced to 0.03 (95%CI: -2.0, 2.0) for brachial SBP. The CDE for diastolic BP was roughly half the value of the total effect. 

```{r, message=F, warning=F}
#| echo: FALSE
#| label: tbl-bp-med
#| tbl-cap: Controlled direct effects for the CBHP policy on blood pressure.
#| eval: TRUE

ot <- read_xlsx(here("data-clean", 
  "overall_total_effect_adjusted.xlsx")) %>%
  mutate(model = 1)

otmp <- read_xlsx(here("data-clean", 
  "overall_pm_mediation_adjusted.xlsx")) %>%
  mutate(model = 2)

otmt <- read_xlsx(here("data-clean", 
  "overall_temp_mediation_adjusted.xlsx")) %>%
  mutate(model = 3)

otmm <- read_xlsx(here("data-clean", 
  "overall_mult_mediation_adjusted.xlsx")) %>%
  mutate(model = 4)

otm <- bind_rows(ot, otmp, otmt, otmm) %>%
  rename(est = theta_bar, ll = lower_95CI,
         ul = upper_95CI) %>%
  mutate(ci = paste("(", sprintf('%.2f', ll), ", ",
    sprintf('%.2f', ul), ")", sep="")) %>%
  select(bp, model, est, ci) %>%
  pivot_wider(names_from = model, 
    values_from = c(est, ci), names_vary = "slowest")

colnames(otm) <- c("", "ATT", "(95%CI)", "ATT", 
  "(95%CI)", "ATT", "(95%CI)", "ATT", "(95%CI)")

tt(otm,
   digits = 2,
   #width = c(3.5, 3, 1, 0.5, 2, 0.5, 2, 0.5, 2, 0.5, 2),
   notes = list("Note: Results combined across 30 multiply-imputed datasets. ATT = Average Treatment Effect on the Treated, CDE = Controlled Direct Effect, DBP = Diastolic blood pressure, SBP = Systolic blood pressure.", a = list(i=0, j=2, text = "Adjusted for age, sex, waist circumference, smoking, alcohol consumption, and use of blood pressure medication."), b = list(i=0, j=c(4,6,8), text = "Mediators were set to the mean value for untreated participants at baseline."))) %>%
  group_tt(
    j = list("Indoor PM" = 4:5,
             "Indoor Temp" = 6:7,
             "PM + Temp" = 8:9)) %>%
  group_tt(
    j = list("Adjusted Total Effect" = 2:3,
             "CDE Mediated By:" = 4:9)) %>%
  style_tt(j = 1:9, align = "lcccccccc") %>%
  style_tt(j=1:9, fontsize = 0.9) %>%
  format_tt(escape = TRUE) %>%
  format_tt(j=c(2,4,6,8), sprintf = "%.2f") 

# kable(otm, digits = 2, longtable = T,
#   col.names = c("", "ATT", "(95%CI)",
#   "ATT", "(95%CI)", "ATT", "(95%CI)", "ATT", "(95%CI)"),
#   align = 'lcccccc') %>%
#   kable_styling(font_size = 10,
#     latex_options = "HOLD_position") %>%
#   add_header_above(c(" " = 3, 
#   "Indoor PM" = 2, "Indoor Temp" = 2, "PM + Temp" = 2)) %>%
#   add_header_above(c(" " = 1, 
#     "Adjusted Total Effect\\\\textsuperscript{a}" = 2,
#     "CDE Mediated By:\\\\textsuperscript{b}" = 6),
#     escape = F) %>%
#     footnote(
#     general = "\\\\small{Note: Results combined across 30 # multiply-imputed datasets. ATT = Average Treatment Effect on the # Treated, CDE = Controlled Direct Effect, DBP = Diastolic blood # pressure, SBP = Systolic blood pressure.}",
#     alphabet = c("\\\\small{Adjusted for age, sex, waist # circumference, smoking, alcohol consumption, and use of blood # pressure medication.}", "\\\\small{Mediators were set to the mean # value for untreated participants at baseline.}"), 
#     general_title = "", threeparttable = T, escape = F)
```

@tbl-resp-med shows estimates from similar analyses for the CDE of the policy on respiratory outcomes. For respiratory outcomes we focus on mediation by personal exposure to PM~2.5~ and point temperature and therefore these estimates are derived for the subset of individuals with measures of personal exposure. Thus the total adjusted $ATT$s in @tbl-resp-med are not directly comparable with those in @tbl-did-health. We estimate the CDEs holding the values of both mediators to the average levels for never treated households at baseline. Overall we find no evidence that any of the total effects we observed for self-reported respiratory outcomes in @tbl-did-health were mediated by personal exposure to PM~2.5~ or indoor temperature. Generally the CDEs for all of the outcomes are statistically indistinguishable from the total effects estimated without controlling for mediators. 

```{r, message=F, warning=F}
#| echo: FALSE
#| label: tbl-resp-med
#| tbl-cap: "Controlled direct effects for the CBHP policy on self-reported respiratory outcomes"
#| eval: TRUE

cde_resp <- read_rds(here("outputs",
  "resp-cdes.rds"))

colnames(cde_resp) <- c("", "ATT", "(95%CI)", "ATT", 
  "(95%CI)", "ATT", "(95%CI)", "ATT", "(95%CI)")

tt(cde_resp,
   digits = 1,
   #width = c(3.5, 3, 1, 0.5, 2, 0.5, 2, 0.5, 2, 0.5, 2),
   notes = list("Note: Estimated for the subset of individuals with measured personal exposure (n=1274). ATT = Average Treatment Effect on the Treated, CDE = Controlled Direct Effect.", a = list(i=0, j=2, text = "Adjusted for age, sex, and smoking."), b = list(i=0, j=c(4,6,8), text = "Mediators were set to the mean value for untreated participants at baseline."))) %>%
  group_tt(
    j = list("Indoor PM" = 4:5,
             "Indoor Temp" = 6:7,
             "PM + Temp" = 8:9)) %>%
  group_tt(
    j = list("Adjusted Total Effect" = 2:3,
             "CDE Mediated By:" = 4:9)) %>%
  style_tt(j = 1:9, align = "lcccccccc") %>%
  style_tt(j=1:9, fontsize = 0.8) %>%
  format_tt(escape = TRUE) %>%
  format_tt(j=c(2,4,6,8), sprintf = "%.1f") 

#kable(cde_resp, digits = 2,
#  col.names = c("", "ATT", "(95%CI)",
#  "ATT", "(95%CI)", "ATT", "(95%CI)", "ATT", "(95%CI)"),
#  align = 'lcccccc', longtable=T,
#  linesep = "") %>%
#  kable_styling(font_size = 9,
#    latex_options = "HOLD_position") %>%
#  add_header_above(c(" " = 3, 
#  "Indoor PM" = 2, "Indoor Temp" = 2, "PM + Temp" = 2)) %>%
#  add_header_above(c(" " = 1, 
#    "Adjusted Total Effect\\\\textsuperscript{a}" = 2,
#    "CDE Mediated By:\\\\textsuperscript{b}" = 6),
#    escape = F) %>%
#    footnote(
#    general = "\\\\small{Note: Estimated for the subset of #individuals with measured personal exposure (n=1274). ATT = #Average Treatment Effect on the Treated, CDE = Controlled Direct #Effect.}",
#    alphabet = c("\\\\small{Adjusted for age, sex, and smoking.}", #"\\\\small{Mediators were set to the mean value for untreated #participants at baseline.}"), 
#    general_title = "", threeparttable = T, escape = F)
```

## Aim 2: Source contributions

Source analysis for this study was conducted using data from all eligible outdoor PM and personal PM samples. Eligible samples were those for which PM~2.5~ mass and chemical components were quantified. We evaluated factors contributing to community-outdoor and personal exposure to PM~2.5~ using the U.S. EPA’s source apportionment model PMF (positive matrix factorization) 5.0, which has been widely used for similar analyses in China (Gao et al. 2018; Liu et al. 2017; Tao et al. 2017). As an optimum PMF result depends on the appropriate number of input factors, sensitivity analysis using a range of factors (e.g., range of 3 to 7 factors, based on a combination of the species that we have and our field-based observations and sources that have been identified previously in our study region) were conducted to examine the impact of a different number of factors on the model results. Detailed information on the procedures of PMF analysis can be found elsewhere (Wang et al. 2016; Zíková et al. 2016). Briefly, the scree plot from our principal component analysis indicated that solutions of between 3 and 5 factors (+/- 1) would be most appropriate, further supporting our evaluation of 3 to 6 factor solutions from PMF. As there was no indication that even moving from five to six factors would improve our solution; therefore, a seven factor solution would not make sense to investigate further (@fig-source-figure). 

The chemical analysis data used as the inputs for the PMF model were dispersion normalized prior to inclusion in the model. PMF works by using covariance of compositional variables to separate sources of ambient PM. However, atmospheric dilution also induces covariance. Dilution can be quantified in terms of a ventilation coefficient (VC) and used to normalize the input chemical concentrations and uncertainties in the original data matrix on a sample by sample basis. The dispersion normalized concentrations and uncertainties are used as the inputs to PMF analysis. Dispersion normalization, as conducted in this study, is a relatively new application of this conceptual framework [@dai2020], developed to adjust for wind speed (dispersion in the x-y plane) and boundary layer height (dispersion in the z-axis). This process involves first calculating the sample specific ventilation coefficient by multiplying the average wind speed by the average boundary layer height over the sampling duration. The average ventilation coefficient is also calculated for the village by averaging all the ventilation coefficients. The dispersion normalized concentration for any species in any sample is equal to the species concentration in that sample multiplied by the ventilation coefficient for that sample and divided by the average ventilation coefficient for that village. Dividing by the average ventilation coefficient for that village helps curtail any extreme concentrations driven by an outlier in the sample ventilation coefficient.

The meteorological data included hourly boundary layer height, 2-m temperature, 2-m dew point temperature, and 2-m horizontal wind speed components (u, v), which were obtained from the European Center for Midrange Weather Forecasting ERA5 reanalysis dataset (0.25 x 0.25 resolution). Values of these meteorological variables were determined at the village-level by identifying the four surrounding grid points with values available from the ERA5 reanalysis, and then applying inverse distance weighted interpolation from those four grid points to the village. Percent relative humidity was calculated from the 2-m dew point temperature using the “weathermetrics” package (version 1.2.2) in R [@anderson2016]. Total hourly wind speed and wind direction were calculated from the horizontal wind speed components.

The model diagnostics for the three- to six-factor PMF solutions are given in @tbl-pmf. Model fit was assessed using Q/Qexp (how our model fit divided by the expected fit). As the change in Q/Qexp decreases as more factors are added, the model may be fitting additional sources that do not improve the overall fit. The largest change in Q/Qexp was from three to four sources (6.24 to 5.37) while the changes moving from four to five and five to six were similar, which suggests that the four factors solution is sufficient to explain the variation in our data. We assessed the random error in our model by randomly sampling blocks of data, fitting new models with the blocks, and comparing how the source profiles compared to the original model (bootstrap (BS) mapping). The three- and four-factor solutions had high BS mapping (all factors found in > 96.5% of bootstrap runs). The additional sources identified in the five-factor (lead) and six-factor (chloride) solutions had low BS mapping (> 72%), which means those solutions are not as consistent as the three- and four-factor solutions. The possibility that multiple, different, solutions could result in the same Q value was assessed using displacement. The displacement approach takes the original factor profiles and modifies the values for each species up or down to maintain a small change in Q, reruns the solution with the new species values, and then compares the profiles of the new model to the original. Any swaps indicate that small changes in the species values could result in factor profiles that look different from the original solution, and that the original solution is unstable. None of the factors were swapped during displacement, which indicates that all of the potential solutions are stable. Based on the Q/Qexp, BS mapping, and interpretability of the factors, the four-factor solution was selected as the most appropriate source solution for the data.

```{r, message=F, warning=F}
#| echo: FALSE
#| label: tbl-pmf
#| tbl-cap: PMF error estimation diagnostics.
#| eval: TRUE

# options(knitr.kable.NA = " ")
t_pmf <- read_csv(here("data-clean", 
  "pmf-error.csv"))

tt(t_pmf,
   width = c(1, 1.5, 1.5, 1.5, 1.5)) %>%
  group_tt(j = list(
    "Potential Factor Solution" = 2:5),
    ) %>%
  style_tt(j = 1:5, align = "ccccc") %>%
  style_tt(i = 0, align = "c") %>%
  style_tt(i = c(5,8), j = 1:5, align="l") %>%
  format_tt(escape = TRUE)

#kable(t_pmf,
# # "latex", booktabs = T,
#  linesep = "", align = 'lllll') %>%
#  kable_styling(full_width = F,
#    font_size = 9) %>%
#  column_spec(2:5, width = "10em") %>%
#  add_header_above(c(" " = 1, 
#    "Potential Factor Solution" = 4))
```

The source profiles for the four-factor solution are presented in @fig-source-figure. The first source was identified as dust based on high percentages of crustal elements like wi-Ca, Si, and wi-Mg. The second source consisted of non-sulfate sulfur as well as secondary inorganic ions (ammonium, nitrate, and sulfate). Non-sulfate sulfur is a tracer for primary coal combustion, while secondary inorganic ions indicate a secondary source. Since industrial coal burning is a source of power generation in our study area, it is likely that the second source is a mixture of primary and secondary emissions that originate from coal and other sulfurous fuel combustion. Additionally, the mean source contribution of the second source is higher in outdoor than personal exposure measurements. Secondary formation occurs outdoors in the presence of sunlight, so higher outdoor concentrations compared to personal exposure further support our naming the second source ‘sulfur secondary’. The third source had high percentages of ws-Ca nd Al, which in our study region, has been found to be indicative of transported dust from dust storms that can occur in the spring. While our samples were collected during winter months only, it is possible that transported dust from previous years still remained. The fourth source was characterized by high percentages of tracers for both coal (OC, wi-K, chloride, Pb) and biomass combustion (EC, ws-K). Coal and biomass combustion are anticipated sources of PM pollution in our study setting, particularly from domestic cooking and heating activities, so this source is likely a mixture of PM emitted from these two household combustion sources. We extend the source profiles across the different treatment cohorts in @fig-source-season.

```{r, message=F, warning=F, out.width="90%"}
#| echo: FALSE
#| label: fig-source-figure
#| fig-cap: Source profiles for the 4-factor PMF solution to the sum of elements, ions, elemental carbon, and organic carbon for outdoor and personal PM~2.5~ exposure measurements. The lines separate the major contributing species to each source.

knitr::include_graphics(here("images", "source-figure.png"))

```


```{r, message=F, warning=F, out.width="80%"}
#| echo: FALSE
#| label: fig-source-season
#| fig-cap: Arithmetic mean dispersion normalized source contributions found from the 4-factor PMF solution for **A** outdoor and **B** personal PM~2.5~ exposure samples by year the group received treatment.

knitr::include_graphics(here("images", "source-season2.png"))

```

@tbl-source-did shows the average treatment effect of the CBHP policy on community outdoor levels and personal exposure levels of the mixed combustion source was statistically indistinguishable from the null. Treatment was associated with lower, but statistically imprecise, personal exposures to the mixed combustion source. As with BC, this finding is consistent with the expectation that the policy contributed to reducing air pollutant emissions from solid fuel burning, as this ‘mixed combustion’ source most likely reflects solid fuel combustion, particularly in our study settings. The results were consistent across both the unadjusted and adjusted models. 

```{r, message=F, warning=F}
#| echo: FALSE
#| label: tbl-source-did
#| tbl-cap: Average treatment effect (µg/m^3^) for outdoor and personal exposure to the mixed combustion source.
#| eval: TRUE

# DiD results for mixed combustion
source_t <- tibble(
  category = c("Outdoor", "Personal exposure"),
  did_att = c("1.07", "-5.60"),
  did_ci = c("(-4.90, 7.04)", "(-13.70, 2.54)"),
  dida_att = c("1.53", "-5.39"),
  dida_ci = c("(-4.19, 7.26)", "(-13.1, 2.35)")
)

colnames(source_t) =c(" ", "ATT", "(95% CI)", 
   "ATT", "(95% CI)")

tt(source_t,
   digits = 2,
   notes = list("Note: ATT = Average Treatment Effect on the Treated, CI = confidence interval.", a = list(i=0, j=4, text = "Models adjusted for temperature; participant smoking status; and whether or not the household reported using biomass fuel."))) %>%
  group_tt(j = list(
     "DiD" = 2:3,
     "Adjusted DiD" = 4:5)) %>%
  style_tt(j = 1:5, align = 'lcccc') %>%
  format_tt(escape = TRUE)

# kable(source_t,
#   col.names = c(" ", "ATT", "(95% CI)", 
#    "ATT", "(95% CI)"), # "latex", booktabs = T,
#   linesep = "", align = 'lcccc') %>%
#   kable_styling(full_width = F,
#     latex_options = "HOLD_position") %>%
#   add_header_above(c(" " = 1, 
#     "DiD" = 2, "Adjusted DiD\\\\textsuperscript{a}" = 2),
#     escape = F) %>%
#   footnote(alphabet = "\\\\small{Note: Models adjusted for # temperature; participant smoking status; and whether or not the # household reported using biomass fuel.}",
#   escape = F, threeparttable = T)
```
  
When the average treatment effects of the CBHP policy on community outdoor levels and personal exposure levels of the mixed combustion source were allowed to vary by treatment year and time, the treatment effect for households most recently treated (i.e., treated in the final wave, w4) was associated with lower personal exposures to the mixed combustion source (Appendix @fig-afig-mixed-ct). In each wave, treatment by the CBHP policy was associated with a reduction in the source contribution to personal PM~2.5~ mass from the mixed combustion source; however, for villages treated in w2 and w3, the effect was statistically imprecise. Treatment was not associated with a reduction or an increase in the source contribution to community outdoor PM~2.5~ mass from the mixed combustion source. Personal exposure measures of this specific air pollution source were found to be more indicative of treatment effect than community outdoor measures of the same source. This finding aligns with the expectation that the pollution source, identified as a mixture of coal and biomass combustion, is characteristic of household use of solid fuels. These fuels, including coal and biomass, produce emissions that are likely to be closer to the people using them rather than near the centrally located community outdoor air samplers.

## Aim 3: Mediation by source contribution

@tbl-med-source shows results from the mediation analysis by personal exposure to the mixed combustion source (coal and biomass), estimated for the subset of participants with personal exposure measurements. The CDE in this model estimates the impact of exposure to the CBHP policy on central and systolic blood pressure while holding constant values of mixed combustion source at the mean baseline values for untreated population. The marginal policy effects (ATTs) from the adjusted ETWFE models for this subset of participants were largely similar to those from the full sample for central SBP (around a 1.6 mmHg decrease), but slightly smaller for central DBP (-1.7 mmHg in the full sample vs. -1.3 mmHg in the subset with personal exposure measurements) and were estimated with greater imprecision. We found little evidence that these treatment effects were meaningfully mediated by exposure to the mixed combustion source, as the controlled direct effects were generally of similar magnitude as the adjusted total effects.  

```{r, message=F, warning=F}
#| echo: FALSE
#| label: tbl-med-source
#| tbl-cap: Average treatment effects and controlled direct effect (mm/Hg) of the CBHP policy on central systolic and diastolic blood pressure with mixed combustion source as the potential mediator.
#| eval: TRUE

# read in mediation by source results
med_source <- read_csv(here("data-clean", 
  "mixed_med_table_overall.csv")) 

med_source_t <- med_source %>%
  select(-type, -model) %>%
  mutate(outcome = c("Central SBP", "Central SBP",  
    "Central DBP", "Central DBP", "Central SBP",
    "Central DBP"),
    model = c(1,2,1,2,3,3)) %>%
  separate_wider_delim(att, delim = "(", 
    names = c("att", "attci"), cols_remove = TRUE) %>% 
  mutate(attci = paste("(", attci, sep="")) %>% 
  pivot_wider(names_from = "model", 
    values_from = c("att", "attci"), names_vary = "slowest")

colnames(med_source_t) = c("", "ATT", 
  "(95%CI)", "ATT", "(95%CI)", 
  "ATT", "(95%CI)")

tt(med_source_t, 
   digits = 2, 
   notes = list("Note: ATT = Average Treatment Effect on the Treated, CI = confidence interval, DiD = Difference-in-Differences, CDE = Controlled Direct Effect, DBP = Diastolic Blood Pressure, SBP = Systolic Blood Pressure.", a = list(i = 0, j = 4, text = "Adjusted for age, sex, waist circumference, smoking, alcohol consumption, and use of blood pressure medication."), b = list(i =0, j = 6, text = "Further adjusted for mediation by mixed combustion source (coal and biomass)"))) %>%
  group_tt(j = list(
     "DiD" = 2:3,
     "Adjusted DiD" = 4:5,
     "Adjusted CDE" = 6:7)) %>%
  format_tt(escape = TRUE) %>%
  style_tt(j = 1:7, align = 'lcccccc')

# kable(med_source_t,
#   col.names =c("", "ATT", "(95%CI)", "ATT", "(95%CI)",
#    "ATT", "(95%CI)"), 
#    # "latex", booktabs = T,
#   linesep = "", align = 'lcccccc') %>%
#   kable_styling(full_width = F,
#     latex_options = "HOLD_position") %>%
#   add_header_above(c(" " = 1, 
#     "DiD" = 2, 
#     "Adjusted DiD\\\\textsuperscript{a}" = 2,
#     "Adjusted CDE\\\\textsuperscript{b}" = 2),
#     escape = F) %>%
#   footnote(
#     general = "\\\\small{Note: ATT = Average Treatment Effect on # the Treated, DiD = Difference-in-Differences, CDE = Controlled # Direct Effect, DBP = Diastolic Blood Pressure, SBP = Systolic # Blood Pressure.}",
#     alphabet = c("\\\\small{Adjusted for age, sex, waist # circumference, smoking, alcohol consumption, and use of blood # pressure medication.}", "\\\\small{Further adjusted for mediation # by mixed combustion source (coal and biomass)}"), 
#     general_title = "", threeparttable = T, escape = F)
```

# Discussion and Conclusions

Air pollution emitted from residential space heating with coal has historically been a major contributor to cardio-respiratory disease burden in northern China [@archer-nicholls2016; @yun2020]. Since the introduction of its 13^th^ 5-Year-Plan (2016-2020), China has successfully implemented numerous large-scale measures to improve air quality including programs that incentivize rural household transition from solid fuels to clean energy sources [@young2015]. The CBHP policy is among the largest and most ambitious household energy policies implemented anywhere in the world in recent decades, and its staggered roll-out provided a unique opportunity to prospectively evaluate this real-world experiment and its effects on air quality and health.

## Adoption of the heat pump technology and adherence to the policy

The CBHP policy was successful in driving a rapid household heating energy transition from coal stoves to electric heat pumps in the treated study villages, with little difference in coal stove suspension or heat pump adoption for those treated before versus during the COVID-19 pandemic. There was high uptake and consistent use of the new heat pump technology and large reductions in coal use in treated villages starting in the first year post-treatment and continuing into the third year of treatment for the villages first treated in 2019. We enrolled rural and peri-urban villages across a wide geographic area and socioeconomic spectrum in Beijing and observed near universal adoption of the heat pump technologies and suspension of coal stove use across the different treatment groups and waves. This contrasts with many previous household energy intervention studies, including several randomized trials, where low fidelity and compliance with the intervention stoves were considered major limitations to achieving their intended air quality or health benefits [@ezzati2017; @lai2024; @rosenthal2018]. 

A number of factors contribute to the successful uptake of the new technology and adherence to the policy. The initial uptake of the heat pump technology was influenced by broad support and perceived benefits of village and household participation in the policy. At baseline assessment, 49 of 50 village committee interviewees indicated a desire to participate in the policy by the committee members and their constituents, for reasons including the ease of use of the heat pump, the convenience of no longer having to add coal throughout the day and especially the night, the desire for a cleaner local environment, and a perceived lower risk of carbon monoxide poisoning without coal stoves (data not reported). While the availability and cost of clean fuels are well-established barriers to their adoption and sustained use over time [@rehfuess2014], in our study, both the upfront costs of the heat pump technology and a portion of electricity use were subsidized by the government, which limited the financial burden of clean energy transition for households. Further, after policy implementation, treated villages no longer had access to government-subsidized coal, and household coal burning was further discouraged with possible punitive measures (e.g., potential loss of electricity subsidies). 

## Impacts of the policy on health

One of the key findings from our comprehensive evaluation of the CBHP policy was that exposure to the policy reduced systolic and diastolic blood pressure by ~1.5 mmHg, and that most of the observed BP effects were mediated by improvements in the indoor environment, specifically reductions in indoor PM~2.5~ and increases in indoor temperature. The total effects of the policy are consistent with a small number of randomized trials of gas cookstoves or more efficient biomass cookstoves showing reductions in blood pressure of similar magnitudes [@kumar2021]. In contrast, recent randomized trials of liquefied petroleum gas (LPG) stoves in multiple countries observed no effect or a small (~0.6 mmHg) increase in blood pressure [@ye2022; @checkley2021] despite large decreases in personal exposures to PM~2.5~ and black carbon. The inconsistency between our results and the LPG stove trial may stem from large differences in age (mean ages of 25y and 48y in the trials versus 61y in our sample) and that gas stoves can still emit health-damaging air pollutants including benzine and volatile organic compounds [@kashtan2023], especially in contrast with the zero-emission electric-powered heat pumps introduced to our study villages. Our findings of temperature- and air quality-mediated impacts of the policy on BP are also supported by observational studies showing that increased exposure to household air pollution [@baumgartner2018; @baumgartner2011; @dong2013; @kanagasabai2022] and to colder indoor temperatures [@lv2022; @sternbach2022] are associated with higher blood pressure in rural and peri-urban areas of China, with exposure-response estimates that reasonably align with our estimates of the policy impact on BP after conditioning on temperature and PM~2.5~ in the mediation analysis. 

We did not observe effects of the policy on measures of PP or cPP/SBP amplification. Pulse pressure is measured as the difference between SBP and DBP, and represents the pulsatile component of blood flow [@dart2001]. Thus, increases in PP can result from increases in SBP, decreases in DBP, or both. The lack of effect on PP in our study is attributed to the similar reductions in SBP and DBP from the policy. Similarly, PP/SBP amplification is measured as a ratio of peripheral to central pressures, and the decreases in central and brachial pressures with the policy were also nearly identical in our study. Although the duration of our study was nearly twice as long as most previous household stove intervention studies conducted over two years or less, it is still possible that even longer-term reductions in BP are required to observe any structural changes in the caliber or elasticity of arterial walls that would subsequently be reflected in differences in PP or SBP/PP amplification [@dart2001]. 

Our study also contributes to the limited evidence that transition from solid fuel to clean energy can reduce the self-report of symptoms consistent with chronic respiratory tract irritation. Exposure to the CBHP policy reduced self-report of any chronic respiratory symptoms (~7 percentage points) with most of these effects driven by reductions in self-reported chest trouble or difficulty breathing on several or most days of the week. These findings align with previous randomized trials in Guatemala and Mexico, where biomass chimney stove interventions lowered indoor carbon monoxide and reduced the self-reported prevalence of chronic respiratory symptoms, especially cough and wheeze, in younger women after 12 and 18 months of intervention [@smith-sivertsen2009; @romieu2009]. In contrast our our findings, introduction of a solar cooker in Senegal provided no benefit to air pollution or self-reported respiratory symptoms [@beltramo2013], and a recent trial of gas stoves in Peru similarly found no reduction in respiratory symptoms within the year of intervention despite very large reductions in PM~2.5~ [@checkley2021]. It is possible that our longer-term (4-yr) study 

We did not, however, find evidence that the reductions in chronic respiratory symptoms were mediated by changes in personal exposure to PM~2.5~ or indoor temperature. This is not particularly unexpected since we did not observe an effect of the policy on personal exposure to PM~2.5~ and any impacts of temperature on chronic respiratory symptoms would more likely arise from large, rapid changes in temperature [@damato2018] whereas we observed small, gradual changes in our study. Future work will consider mediation by seasonal indoor PM~2.5~, which is a longer-term measure of ‘usual’ air pollution than 24-h personal exposure and was shown to be reduced by the policy in our study homes. 

We found some evidence of heterogeneity in the health benefits of the policy by treatment cohort. Generally the policy showed strong reductions for the villages treated early and weak or even small increases in BP for the last 3 villages exposed to the policy in 2021. We found less evidence for heterogeneity for self-reported respiratory symptoms, but did note potential evidence for increases in self-reported wheezing attacks with the policy in the three villages treated in 2021. Notably this was also the treatment cohort with the smallest improvement in point temperature at the time of BP measurement and an increase in self-reported biomass use. Paradoxically, we observed a larger decrease in PM~2.5~ and mixed solid fuel use in this group. It is possible that the composition of PM and mixed solid fuel was different in this cohort, with a greater contribution of biomass smoke, however we are unable to differentiate between biomass and coal in our ‘mixed solid fuel combustion’ category. This group was also treated during the pandemic, which could have impacted how the policy was introduced or resulted in changes to other BP risk factors that we did not evaluate in our study, e.g., changes in diet.  
 
We also found little evidence of an impact of the policy on blood biomarkers of inflammation and oxidative stress in the sub-sample of participants with blood collection in waves 1 and 2, but these were estimated with imprecision. Our results contrast with a natural experiment in urban Beijing that showed large regional and local air quality reductions during the 2008 Beijing Olympics and also observed benefits to airway inflammation [@huang2012] and blood markers of inflammation and oxidative stress in healthy urban Beijing residents during the Olympics compared with before and after [@rich2012]. Our mediation analysis indicated that the blood pressure effects of the policy were mediated more through indoor temperature than air pollution. Although observational studies from rural northern China show impacts of exposure to temperature on inflammation and oxidative stress [@wang2020; @xu2019], it’s possible that the relatively small increases in mean indoor temperature in treated households we observed were not sufficiently large to capture measurable changes in these biomarkers.
 
## Impacts of the policy on air pollution and its sources

China has a long history of launching ambitious, large-scale policies and programs to promote clean household energy transition and support rural energy infrastructure development [@zhang2007]. It was a relatively early initiator of rural electrification projects in the 1950s and achieved complete (100%) electrification of households by 2016 [@yangk2021], which undoubtedly facilitated the policy option to replace coal stoves with electric-powered heat pump heaters. Several decades later, China achieved what is likely still the largest improvement in household energy efficiency in history with regards to the population affected by a single program: the National Improved Stove Program (NISP) and its provincial counterparts were initiated in the early 1980s and are credited with introducing nearly 200 million improved cooking and heating stoves by the late 1990s. All NISP stoves had chimneys and some had manual or electric blazers to promote more efficient combustion [@zhang2007], with the primary goal of increased biomass fuel efficiency to reduce pressure on local forests and a secondary goal of improving indoor air quality [@sinton2004]. Because NISP focused mainly on biomass stoves for cooking, it had limited impacts on the rapid increase in coal heating stove installation during that period, most of which were implemented without chimneys [@zhang2007]. 

In contrast to NISP, the primary aim of the CBHP policy was to reduce air pollution emissions and improve regional air quality, and it specifically targeted coal-burning stoves in northern China. Our evaluation of the CBHP policy indicates a substantial improvement in indoor air quality, with a reduction of roughly -36 µg/m^3^ (95%CI: -61, -12) in wintertime indoor PM~2.5~ resulting in geometric mean indoor PM~2.5~ levels of 49 µg/m^3^ (95%CI: 43, 57) in treated households in w4. At baseline, indoor PM~2.5~ levels in treated households were above the WHO’s IT-1 (annual and 24-h means: 35 and 75 µg/m^3^), which is the first stepping stone in high-pollution areas towards achieving cleaner air [@who2021]. Following the policy, indoor PM~2.5~ levels were approaching and in some cases even reaching the IT-1 guideline value.

Similar to our indoor results, several recent randomized trials with high compliance (exclusive or near exclusive) in the use of LPG stoves in rural settings with low outdoor pollution in Peru, Ghana, Guatemala, India, and Rwanda  [@checkley2021; @chillrud2021; @katz2020] [@johnson2022] found lower exposures to PM~2.5~ (32-69%) in the intervention group compared with controls using traditional solid fuel stoves, but even in these relatively low pollution settings, post-intervention mean exposures (range: 24 to 52 µg/m^3^ ) were still well-above the WHO's annual air quality guideline (5 µg/m^3^) and, like our study, more aligned with IT-1 and IT-2. A trial in urban and peri-urban Nigeria, a high pollution setting more similar to our Beijing sites, did not observe an air pollution benefit of ethanol stoves but did observe improved birth and pregnancy outcomes and blood pressure [@alexander2018; @alexander2017]. 

Nonetheless, comparisons of the indoor PM~2.5~ benefits of the CBHP policy in our study with previous assessments of household energy interventions in China suggest that the CBHP policy performed well. Homes with the NISP biomass chimney stoves had modestly lower indoor PM than traditional open fire stoves (293 versus 223 µg/m^3^), though post-intervention air pollution levels were still an order of magnitude higher than the current health-motivated WHO (24-h) guideline [@sinton2004]. The NISP’s so-called "improved" coal heating stoves unexpectedly emitted higher concentrations of PM and carbon monoxide than the traditional coal stoves [@edwards2004]. In southwestern China (Sichuan), a difference-in-differences analysis of an government-supported household energy package pilot (semi-gasifier cookstove, water heater, pelletized biomass fuel) observed decreased indoor PM~2.5~ (24–67%) in women treated by the energy package, but greater reductions (48–70%) were observed in untreated women, a result likely influenced by an unexpectedly large transition in gas cookstoves in untreated homes during the study period [@baumgartner2019]. 

The relatively high post-policy indoor air pollution levels and the limited benefit to personal exposures and outdoor PM~2.5~ in treated villages in our study—despite excellent compliance with the policy—is likely due to three key factors. First, a quarter of our study households had at least one tobacco smoker, which is a large contributor to personal exposures to PM~2.5~ in our study settings, especially during wintertime when people tend to spend more time indoors [@li2022a]. Second, although has Beijing rapidly and impressively reduced outdoor PM~2.5~ over the last decade (annual mean of 89 μg/m^3^ in 2013 decreased to 30 μg/m^3^ in 2022) [@zhang2023], the wintertime outdoor PM~2.5~ levels in the treated study villages remained high enough across the study waves (range of means: 26-38 μg/m^3^ in treated villages) to limit the minimum exposure achievable with an indoor stove. The contribution of outdoor sources to personal exposures is further supported by our source apportionment analyses, which showed a clear contribution of regional sources (secondary sulfur, transported dust) to personal exposures. Finally, the continued use of biomass-burning kangs likely also contributed to indoor PM~2.5~ and personal exposures. Kangs are a relatively simple and culturally entrenched combined cooking and space heating technique that have been used in China for over two thousand years [@zhuang2009]. Kangs are mostly fuelled by wood or other biomass that is freely and widely available in our study villages. The CBHP policy did not ban biomass burning, and we observed persistent self-reported use of kangs after heat pump installation. Continued use of traditional solid fuel stoves alongside cleaner stoves and fuels (i.e., stove stacking) has long been a barrier to achieving large reductions in indoor and personal exposures after intervention [@shankar2020]. A notable exception is the HAPIN trial which attained near exclusive use of LPG stoves and dramatic reductions in personal exposures to PM~2.5~ (lowered by 66% compared with controls, 70 versus 24 μg/m^3^) [@johnson2022], though the impressive air quality improvements were not accompanied by any health benefits across a range of neonatal, child, and maternal outcomes [@lai2024].

To comprehensively evaluate a large-scale policy like the CBHP policy, our study’s measurement approach required extensive long-term measurements in >1000 households in multiple waves using over 500 air pollution monitors that collected thousands of hours of measurements. The scale and duration of air pollution measurement achieved in this study would not have been possible without low-cost air pollution sensors that have proliferated in the past decade. Our use of low-cost sensors to capture long-term (5-6 months) indoor air quality data in rural settings places it at the forefront of applying cutting-edge technology to understand and mitigate household air pollution. This approach is somewhat unique for China as most studies, including those using lower-cost air pollution sensing networks [@chao2021; @mei2020], focus on urban air quality, driven by consideration for urban population demographic changes and industrial, power generation, and vehicular emissions [@shen2017]. By focusing on rural indoor environments, our study addresses a crucial gap, offering insights into the effectiveness of a specific policy (CBHP) on a micro-scale. Future evaluations of household energy interventions might also consider longitudinal measures of air pollution that track changes over longer periods to capture delayed effects. Estimating the causal effects of the CBHP policy required a multifaceted approach to evaluation that incorporated a study design (difference-in-differences) and analytical methods (ETWFE, causal mediation) that are less common for evaluating air quality interventions. By incorporating a broader array of metrics and considering the systemic nature of air pollution and its health impacts, through this study, we sought to provide a more nuanced understanding of an intervention's effectiveness and the ways in which it may need to be augmented or restructured to achieve desired health outcomes.

## Assumptions, strengths, and limitations

The validity of our DiD approach is subject to two key assumptions [@callaway2021; @wooldridge2021]. First, no anticipation: we assume that anticipation of the CBHP policy did not affect outcomes prior to policy implementation and did not differ between treated and untreated villages. We selected villages that were eligible for the policy but not currently treated. It was generally understood that the policy would first be implemented in the plains areas with more updated electric grids and then gradually expand into more remote and mountainous areas of Beijing, though most of our study villages were far from Beijing's urban core. In addition to these geographical parameters, some of our study villages were assigned to the policy whereas others applied to the local government, but they were generally unaware of if or when they would be treated at the time of enrollment. Second, parallel trends: our analysis assumes that in the absence of the policy the trends in air quality and health in treated and untreated villages would have remained the same over time. Because the parallel trends assumption is based on a counterfactual it cannot be empirically verified (similar to the assumption of no unmeasured confounding). However,\comment{EC 4a} given that we had two pre-intervention periods prior to the 2021 cohort being treated, we assessed the similarity of pre-intervention trends between w1 and w2 for the never treated group and the group eventually treated in 2021. Estimates and 95% CIs for the difference in pre-trends are given in the Appendix for BP outcomes (@fig-afig-pt3 and @fig-afig-pt4), personal exposure to PM~2.5~ and black carbon (@fig-afig-pt5), and self-reported respiratory outcomes (@fig-afig-pt6). We found little strong evidence for systematic differences in pre-trends for any outcome, but some estimates were imprecise and tests for pre-trends are generally considered to have low power [@roth2022]. We also adjusted for relevant time-varying confounders in estimating total effects and in mediation analyses, which aims to improve the credibility of parallel trends assumption. 

We also note that, in general, the addition of covariates to our “basic” ETWFE models did not appreciably change our estimates. Nevertheless, we cannot entirely rule out the possibility that other programs or policies differentially affected air quality or health in treated and untreated villages, which could lead to over- or under-estimation of its effects. To investigate this possibility we surveyed village leaders about other rural development or health policies and programs in their villages throughout our four-year study period and did not identify any co-implemented programs that would differentially impact villages by treatment status and affect outcomes or mediators. Finally, our mediation analysis assumes no residual time-varying confounding between our mediators (air pollution and temperature) and our health outcomes. Although we measured and evaluated a large number of time-varying risk factors for BP, we cannot entirely eliminate the possibility of potential residual confounding which could over-or under-estimate the mediating effects of indoor environmental factors. 
 
Strengths of this comprehensive, field-based assessment of the CBHP policy include our quasi-experimental design to evaluate a real-world clean energy intervention that would be near impossible to experimentally manipulate at the scale of our study. Our study design controlled for secular changes in health and we additionally collected data on and adjusted for important time-varying covariates. It’s perhaps worth noting that control for secular trends was important in our context. For personal exposure, supplementary analyses that dropped the time fixed effects or compared treated vs. untreated villages with covariate adjustment would have suggested a substantial impact of the policy (Appendix @tbl-a-fe). Our numerous sensitivity analyses showed the robustness of our findings to various analytic decisions. Most previous field-based household energy intervention studies were less than two-years in duration with a single post-treatment wave [@lai2024; @quansah2017], and our four-year study enabled longer-term evaluation of compliance with the coal ban and heat pump adoption/use and their impacts on air pollution and health. Despite the logistical challenges of COVID-19 pandemic shutdowns and related government restrictions that occurred throughout half of our study period, we were able to continue the study and successfully retain participants in all 50 study villages over four years. Our large sample size of 1000 participants in 50 villages across multiple study waves enabled us to evaluate both the total effects of the policy and separately for different treatment cohorts. By comparison, the few previous field-based assessments of household energy interventions (trials and pre-post designs with controls) and blood pressure ranged in size from 44 to 324 participants [@lai2024; @kumar2021; @onakomaiya2019], with exception of HAPIN trial that enrolled ~3000 pregnant women [@ye2022].

This study also has several limitations to consider when interpreting our results. First, the COVID-19 pandemic began in the middle of our study and roughly half of our treated villages entered into the policy during the pandemic, which likely had some influence on the roll-out of the policy in those villages. We observed the largest benefits in BP and several respiratory outcomes in villages treated before the pandemic. However, we cannot differentiate between treatment cohort effects attributable treatment during the COVID-19 pandemic versus other factors that different between treatment cohorts (i.e., geographic location, access to biomass, fuel prices).

Second, the CBHP policy roll-out began in 2016 but we did not begin enrolling villages into our study until 2018. Thus, many of our study villages are farther from the urban core and generally of lower socioeconomic status than many villages treated in the first three years of the policy. Previous studies of the CBHP policy suggest that treated villages of all socioeconomic levels benefited from less-polluted and warmer indoor environments, but that the benefits were larger in wealthier villages that were more likely to use the heat pumps more often and set to a higher indoor temperature [@barrington-leigh2019; @meng2023]. Further, most of our study villages had relatively easy access to (free) biomass fuel, and may be more likely to use biomass-burning kangs compared with villages near the urban core where biomass fuel is less readily available. Thus our results may not be generalizable to all of rural and peri-urban Beijing, especially to the more urbanized, wealthier villages treated between 2016 and 2018, and may underestimate the impacts of the policy on indoor environmental factors that were important cardio-respiratory health mediators in our study.

Third, like any field-based study, we had a number of constraints with data collection. We were unable to measure indoor air quality in w1 due to logistical and budget constraints, and thus cannot directly estimate the effects of the policy on indoor PM~2.5~ for the 10 villages treated in 2019, which is also the treatment cohort that experienced the greatest health benefits. Similarly, we were unable to collect blood samples in the last wave because all of our measurements were conducted in participant homes rather than clinics to avoid group contact during the pandemic. In addition, our study logistics required visiting 50 villages over a period of just several months. Thus, we were unable to return to villages if a previously enrolled participant was not at home at the time that staff visited the village. In such instances, we either randomly selected either another eligible participant in the same home or we randomly selected another household with eligible participants from the village roster and our study participants differed slightly across waves. Though this is unlikely to impact our findings since our village-level study and analysis is robust to participation of a random sample of participants in each wave, and there were no notable differences in key demographic characteristics or health behaviors between participants who contributed to a different number of waves or between participants across each of the three waves. 

Fourth, respiratory symptoms were self-reported and thus our estimated effects on respiratory symptoms must be interpreted with caution. Participants in our study were aware of their treatment status, and knowledge of being treated by a policy aimed at reducing local air pollution may have affected their reporting of the perceived health benefits of intervention [@peel2015]. Previous trials of improved biomass stoves, for example, noted a tendency of participants to report favorable response to the stove regardless of its physiologic efficacy [@burwen2012; @smith-sivertsen2009]. Such reporting bias could have inaccurately increased the estimated effect of the policy, though we did not observe consistent effects across all respiratory outcomes or treatment cohorts, which one might expect if treated participants were inclined to give more favorable responses. Our study also benefited from co-measurement of BP, an objective measure that is less likely to be biased by participant or staff awareness of treatment status because our staff consistently followed strict quality control guidelines for measurement across all study villages and homes, regardless of treatment status.   
 
# Implications of Findings

In this comprehensive field-based assessment of a real-world CBHP policy in Beijing, we observed high fidelity and compliance with the policy in our study villages and households where nearly all households in treated villages stopped using coal and shifted to electric-powered heaters. Exposure to the policy reduced blood pressure and self-reported chronic respiratory symptoms, and the effects were mediated by reductions in indoor PM~2.5~ and improvements in home temperature. We did not observe the same benefits of the policy on outdoor air quality or personal exposures, likely because the relatively high contribution of other regional and local air pollution sources to outdoor and personal exposures may have masked the benefits from a single source reduction. We also did not observe benefits of the policy on different measures of inflammation and oxidative stress in the sub-sample of participants with biomarker assessment, even though we observed respiratory symptoms and BP benefits of the policy in a sensitivity analysis limited to the same participants. 

Our results showing an indoor air quality and cardio-respiratory health benefit of a real-world, large-scale clean energy policy are timely, as they are synchronous with ongoing and planned clean energy policies in China and other countries in a global effort to “ensure access to affordable, reliable, sustainable, and modern energy for all” (Sustainable Development Goal-7) and directly respond to a recent call-to-action from global cardiovascular societies that emphasized the urgent need for interventional studies that inform targeted pollution-reducing strategies to reduce cardiovascular disease [@brauer2021].

# Data Availability Statement

The de-identified data, code, documentation, and study resources including the standard operating procedures for all study measurements are openly available on the Open Science Foundation (OSF) [platform](https://osf.io/8twds/?view_only=c41dd3d6228240d6aad92f81371c5339).


# Acknowledgements

In addition to the HEI funding that supported this work, we also acknowledge support from the Canadian Institutes for Health Research (CIHR #159477) and the Social Sciences and Humanities Research Council (SSHRC #430-2017-00998 and #435-2016-0531). None of these funders had any role in study design, data collection and analysis, decision to publish, or preparation of this report. 

We would like to thank and acknowledge the over 1400 study participants and the over 50 field staff members who assisted with data collection and laboratory analysis. This work would not have been possible without the dedicated efforts and contributions of investigators and trainees who contributed to the development of ideas, data collection, and results that are reported here and in publications resulting from this work. Here, we wish to acknowledge Koren Mann, Brian Robinson, Chris Barrington-Leigh, Arijit Nandi, Robert Platt, Talia Sternbach, Xiang Zhang, Wenlu Yuan, Collin Brehmer, Kennedy Hirst, Enkhuun Byambadorj, Kaibing Xue, Siobhan Carroll, and Martha Lee. We also acknowledge the efforts of project coordinators in Canada and China: Leona Siaw, Neha Ahmed, and Laojie Li. 


# References

::: {#refs}
:::

\newpage
\appendix
\renewcommand{\thefigure}{A\arabic{figure}}
\renewcommand{\thetable}{A\arabic{table}}
\setcounter{figure}{0}
\setcounter{table}{0}

# Appendices {.appendix}

## Biomarker descriptives
Below we show boxplots for the logged values of the blood inflammatory and oxidative stress markers. 

```{r mi-plots, echo=FALSE, out.width = "90%"}
#| fig-cap-location: top
#| label: fig-afig-biomarkers
#| fig-cap: "Boxplots for markers of systemic inflammation including C-reactive protein (CRP), interleukin-6 (IL-6), tumour necrosis factor alpha (TNF-$\\alpha$) and markers of oxidative stress including 8-hydroxy-2'-deoxyguanosine (8-OHdG) and malondialdehyde (MDA)"

knitr::include_graphics(here("images", 
  "biomarker-boxplot-log.jpg"))
```

\newpage 

## Imputation results
The figures below show density plots for the values of body mass index, waist circumference, and indoor PM~2.5~ from the multiple imputation models. The red lines show the values for each of the 30 imputed datasets, and the black line shows the value for the observed data. 

```{r}
#| echo: FALSE
#| fig-cap-location: top
#| label: fig-afig-mi
#| fig-cap: Kernal density plots showing distribution of multiply-imputed values for body mass index (kg/m^2^), waist circumference (cm), and indoor PM~2.5~ (µg/m^3^) (red lines) and observed values (heavy black line).
#| fig-width: 7
#| fig-subcap: 
#|   - ""
#|   - ""
#|   - ""
#| layout-nrow: 2

knitr::include_graphics(here("images", 
  "MI_BMI_density.png"))

knitr::include_graphics(here("images", 
 "MI_waist_circ_density.png"))

knitr::include_graphics(here("images", 
 "MI_indoorPM_density.png"))
```

\newpage

## Participant flow diagram

```{r}
#| echo: FALSE
#| label: fig-flowchart
#| fig-cap: Flow chart of BHET study participation at the participant, household, and village levels across study years.
#| fig-width: 6


knitr::include_graphics(here("images", 
  "Participation-flowchart-Apr12.png"))
```

\newpage


\newpage

## Policy uptake
@fig-afig-coal shows trends over time in self-reported coal and biomass consumption over each season. @tbl-fuel-did shows results from applying our extended two-way fixed effects models (in separate analyses) to coal and biomass consumption.

```{r afig, message=FALSE, cache=TRUE, echo=FALSE, out.width = "100%"}
#| echo: FALSE
#| label: fig-afig-coal
#| fig-cap: Trends in self-reported coal and biomass, by treatment season.
#| fig-width: 6

knitr::include_graphics(here("images", "coal-plot.png"))
```

```{r}
#| echo: FALSE
#| label: tbl-fuel-did
#| tbl-cap: "Policy impacts on self-reported fuel use (kg)"

# read in fuel use table
fuel_table <- read_rds(here("outputs", 
  "fuel-table-het.rds"))

models_coal <- read_rds(here("outputs/models", 
  "m_coal.rds"))
models_bio <- read_rds(here("outputs/models", 
  "m_biomass.rds"))

models_coal_note <- paste("Joint test that all ATTs are equal: ", 
    "F(", models_coal$ht1$df1, ", ", 
    models_coal$ht1$df2, ")= " , 
    round(models_coal$ht1$statistic, digits=3), ", p= ", 
    round(models_coal$ht1$p.value, digits=3), sep="")

models_bio_note <- paste("Joint test that all ATTs are equal: ", 
    "F(", models_bio$ht1$df1, ", ", 
    models_bio$ht1$df2, ")= " , 
    round(models_bio$ht1$statistic, digits=3), ", p= ", 
    round(models_bio$ht1$p.value, digits=3), sep="")

colnames(fuel_table) <- c("Cohort", "Time", 
  "ATT", "(95% CI)", "ATT", "(95% CI)")

tt(fuel_table,
   # width = c(.8, .8, 1, 1, 1, 1),
   digits = 2,
   notes = list("Note: ATT = Average Treatment Effect on the Treated, CI = confidence interval", 
  a = list(i = 0, j = 3, text = models_coal_note), 
  b = list(i =0, j = 5, text = models_bio_note))) %>%
    group_tt(
      j = list(
        "Coal" = 3:4,
        "Biomass" = 5:6),
      i = list(
        "Average ATT" = 1, 
        "Cohort-Time ATTs" = 2)) %>%
  style_tt(i = c(1,3), bold = TRUE) %>%
  format_tt(escape = TRUE)
```

\newpage

## Heterogeneity in treament effects 

### Personal exposure 
Table @tbl-a-het-personal shows limited evidence that the $ATT$s across cohorts and time demonstrate meaningful heterogeneity.

```{r}
#| echo: FALSE
#| label: tbl-a-het-personal
#| tbl-cap: "Heterogenous treatment effects: Personal exposures"

# read in personal exposure heterogeneity table
aph_table <- read_rds(here("outputs", 
  "ap-het-table.rds"))

models_ppm <- read_rds(here("outputs/models", "m_ppm.rds"))
models_pbc <- read_rds(here("outputs/models", "m_pbc.rds"))

models_ppm_note <- paste("Joint test that all cohort-time ATTs are equal: ", 
    "F(", models_ppm$ht1$df1, ", ", 
    models_ppm$ht1$df2, ")= " , 
    round(models_ppm$ht1$statistic, digits=3), ", p= ", 
    round(models_ppm$ht1$p.value, digits=3), sep="")

models_pbc_note <- paste("Joint test that all cohort-time ATTs are equal: ", 
    "F(", models_pbc$ht1$df1, ", ", 
    models_pbc$ht1$df2, ")= " , 
    round(models_pbc$ht1$statistic, digits=3), ", p= ", 
    round(models_pbc$ht1$p.value, digits=3), sep="")

colnames(aph_table) <- c("Cohort", "Time", 
  "ATT", "(95% CI)", "ATT", "(95% CI)")

tt(aph_table,
   # width = c(.8, .8, 1, 1, 1, 1),
   digits = 2,
   notes = list("Note: ATT = Average Treatment Effect on the Treated, CI = confidence interval", 
  a = list(i = 0, j = 3, text = models_ppm_note), 
  b = list(i =0, j = 5, text = models_pbc_note))) %>%
    group_tt(
      j = list(
        "PM2.5" = 3:4,
        "Black carbon" = 5:6),
      i = list(
        "Average ATT" = 1, 
        "Cohort-Time ATTs" = 2)) %>%
  style_tt(i = c(1,3), bold = TRUE) %>%
  format_tt(escape = TRUE)
```

### Indoor PM~2.5~
Table @tbl-a-het-indoor shows estimates for cohort-time $ATT$s for daily and seasonal indoor PM~2.5~.

```{r, echo=F}
#| echo: FALSE
#| label: tbl-a-het-indoor
#| tbl-cap: Heterogenous treatment effects for Indoor PM~2.5~.

# read in personal exposure heterogeneity table
aph_table_ind <- read_rds(here("outputs", 
  "ap-het-table-indoor.rds"))

models_i24 <- read_rds(here("outputs/models", "m_i24.rds"))
models_is <- read_rds(here("outputs/models", "m_is.rds"))

models_i24_note <- paste("Joint test that all ATTs are equal: ", 
    "F(", models_i24$ht1$df1, ", ", 
    models_i24$ht1$df2, ")= " , 
    round(models_i24$ht1$statistic, digits=3), ", p= ", 
    round(models_i24$ht1$p.value, digits=3), sep="")

models_is_note <- paste("Joint test that all ATTs are equal: ", 
    "F(", models_is$ht1$df1, ", ", 
    models_is$ht1$df2, ")= " , 
    round(models_is$ht1$statistic, digits=3), ", p= ", 
    round(models_is$ht1$p.value, digits=3), sep="")

colnames(aph_table_ind) <- c("Cohort", "Time", 
  "ATT", "(95% CI)", "ATT", "(95% CI)")

tt(aph_table_ind,
   # width = c(.8, .8, 1, 1, 1, 1),
   digits = 2,
   notes = list("Note: ATT = Average Treatment Effect on the Treated, CI = confidence interval", 
  a = list(i = 0, j = 3, text = models_i24_note), 
  b = list(i =0, j = 5, text = models_is_note))) %>%
    group_tt(
      j = list(
        "Daily" = 3:4,
        "Seasonal" = 5:6),
      i = list(
        "Average ATT" = 1, 
        "Cohort-Time ATTs" = 2)) %>%
  style_tt(i = c(1,3), bold = TRUE) %>%
  format_tt(j = c(3,5), sprintf = "%.2f") %>%
  format_tt(escape = TRUE)

```

\newpage

### Indoor temperature

```{r}
#| echo: FALSE
#| label: tbl-a-het-temp
#| tbl-cap: Heterogenous treatment effects for indoor temperature

ctt <- read_xlsx(here("data-clean", 
  "ct_temp_table.xlsx"))

options(knitr.kable.NA = " ")
ctt_table <- ctt %>% 
  pivot_longer(!ct_labels, names_to = "outcome", 
    values_to = "est_ci", cols_vary = "slowest") %>%
  separate_wider_delim(est_ci, delim = "(", 
    names = c("att", "attci"), cols_remove = TRUE) %>% 
  mutate(attci = paste("(", sprintf("%12s", attci), sep=""),
    measure = rep(c("All", "Daytime", "Heating season",
      "Daytime heating season", "All", "Heating season"),
      each = 6),
    stat = c(rep(2, times = 24), rep(3, times = 12)),
    cohort = rep(c(2019,2019,2019,2020,2020,2021), 
                 times = 6),
    time = rep(c(2019,2020,2021,2020,2021,2021), 
               times = 6),
    att = as.numeric(att)) %>%
  select(cohort, stat, time, measure, att, attci) %>%
  relocate(measure, stat, cohort, time)

ctt_point_temp <- read_xlsx(here("data-clean",
  "unadjusted_pointtemp_results_apr3.xlsx")) %>%
  filter(type != "Overall ATT") %>%
  separate_wider_delim(att, delim = "(", 
    names = c("att", "attci"), cols_remove = TRUE) %>%
  mutate(att = as.numeric(att),
         measure = "All",
         cohort = c(2019, 2019, 2020, 2021),
         time = c(2019, 2021, 2021, 2021),
         stat = 1,
         attci = paste("(", attci, sep="")) %>%
  select(stat, measure, cohort, time, att, attci) %>%
  relocate(measure, stat, cohort, time)

ctt_temp_atts <- bind_rows(ctt_point_temp, ctt_table)

ctt_het_stats <- read_xlsx(here("data-clean",
  "gt_temp_heterogeneity.xlsx"))  %>%
  rename(measure = temp_metric,
         test = f_stat,
         pval = p_value) %>%
  mutate(measure = c("All", "Daytime", "Heating season",
      "Daytime heating season", "All", "Heating season",
      "All"),
    stat = c(2,2,2,2,3,3,1),
    test = sprintf("%.1f", test),
    pval = sprintf("%.3f", pval),
    cohort = 2021,
    time = 2021) %>%
  select(measure, stat, cohort, time, test, pval)


ctt_temp_het_table <- ctt_temp_atts %>% 
  left_join(ctt_het_stats, 
    join_by(measure, stat, cohort, time)) %>%
  pivot_wider(names_from = stat, 
    values_from = c(att,attci,test,pval), 
    names_vary = "slowest") %>%
  arrange(measure, cohort, time) %>%
  mutate(ct = paste(cohort, time, sep=" ")) %>%
  select(-measure, -test_1, -test_2, -test_3,
         -cohort, -time) %>%
  relocate(ct)


colnames(ctt_temp_het_table) <- c("Cohort Time", "ATT", "(95% CI)", "p-val", "ATT", 
  "(95% CI)", "p-val", "ATT", "(95% CI)", "p-val")

tt(ctt_temp_het_table,
   width = c(1.2, 0.5, 1.2, 0.5, 0.5, 
             1.2, 0.5, 0.5, 1.2, 0.5),
   notes = "Note: ATT = Average Treatment Effect on the Treated, CI = confidence interval") %>%
  group_tt(
  i = list(
    "All times" = 1, 
    "Daytime" = 7,
    "Daytime heating" = 13,
    "Heating season" = 19),
  j = list(
    "Point temp (°C)" = 2:4,
    "Mean temp (°C)" = 5:7,
    "Min temp (°C)" = 8:10)) %>%
  style_tt(i = c(1,8,15,22), bold = TRUE,
           align = "c") %>%
  # style_tt(
  #   i = c(2,9,16,23), j = 1, 
  #     rowspan = 3, alignv = "t") %>%
  # style_tt(
  #   i = c(4,10,16,22), j = 1, 
  #     rowspan = 2, alignv = "t") %>%
  style_tt(j=1:10, fontsize = 0.8) %>%
  style_tt(j=c(2,5,8), sprintf = "%.2f") %>%
  style_tt(j = 1, align = "l") %>%
  format_tt(escape = TRUE)

```


\newpage

### Blood pressure outcomes
@tbl-bp-het shows $ATT$s by treatment cohort and time, as well as the results of joint tests of heterogeneity across $ATT$s.

```{r}
#| echo: FALSE
#| label: tbl-bp-het
#| tbl-cap: Heterogenous treatment effects for the total effect of the CBHP policy on blood pressure.

options(knitr.kable.NA = " ")
temp_table <- read_xlsx(here("data-clean",
  "adjusted_CT_results_table.xlsx")) %>%
  select(bp, parameter, `Adjusted DiD`) %>%
  rename(attci = `Adjusted DiD`) %>%
  mutate(cohort = rep(c(2019,2019,2020,2021),
                      times = 4),
         time = rep(c(2019,2021,2021,2021),
                    times = 4)) %>%
  separate_wider_delim(attci, delim = "(", 
    names = c("att", "attci"), cols_remove = TRUE) %>% 
  mutate(attci = paste("(", attci, sep="")) %>% 
  select(bp, att, attci, cohort, time) %>%
  relocate(bp, cohort, time)


het_stats <- read_xlsx(here("data-clean",
  "ct-heterogeneity-results.xlsx")) %>%
  filter(Model == "Adjusted DiD") %>%
  rename(bp = `BP measure`,
         test = `Test statistic`,
         pval = `P-value`) %>%
  mutate(test = sprintf("%.1f", test),
         pval = sprintf("%.3f", pval),
         cohort = 2021,
         time = 2021) %>%
  select(bp, cohort, time, test, pval)

bp_het_table <- temp_table %>% 
  left_join(het_stats, join_by(bp, cohort, time)) %>%
  select(-bp)

colnames(bp_het_table) <- c("Cohort", "Time", 
  "ATT", "(95% CI)", "F-Statistic", "p-value")

tt(bp_het_table,
   digits = 2,
   width = c(1, 1, 1, 1.25, 1, 1),
   notes = list("Note: ATT = Average Treatment Effect on the Treated, CI = confidence interval, DiD = Difference-in-Differences.", 
     a = list(i = 0, j = 3, text = "Adjusted for age, sex, waist circumference, smoking, alcohol consumption, and use of blood pressure medication."), 
     b = list(i = 0, j = 5, text = "F-statistics and p-values for joint tests of equality across cohort and time ATTs"))) %>%
  group_tt(
    j = list(
      "Adjusted DiD" = 3:4,
      "Heterogeneity tests" = 5:6),
    i = list(
      "Brachial SBP" = 1,
      "Central SBP" = 5,
      "Brachial DBP" = 9,
      "Central DBP" = 13)) %>%
  style_tt(i = c(1,6,11,16), bold = TRUE) %>%
  # style_tt(i = c(2,7,12,17), rowspan = 2) %>%
  format_tt(escape = TRUE)

```

\newpage

### Mediation analyses for blood pressure
@tbl-a-bp-med-het shows the cohort-time treatment effects for the mediation model for blood pressure.


```{r, message=F}
#| echo: FALSE
#| label: tbl-a-bp-med-het
#| tbl-cap: Heterogenous treatment effects for blood pressure mediation model.
#| tbl-pos: H

ctot <- read_xlsx(here("data-clean", 
  "ct_total_effect_adjusted.xlsx")) %>%
  mutate(model = 1)

ctotmp <- read_xlsx(here("data-clean", 
  "ct_pm_mediation_adjusted.xlsx")) %>%
  mutate(model = 2)

ctotmt <- read_xlsx(here("data-clean", 
  "ct_temp_mediation_adjusted.xlsx")) %>%
  mutate(model = 3)

ctotmm <- read_xlsx(here("data-clean", 
  "ct_mult_mediation_adjusted.xlsx")) %>%
  mutate(model = 4)

ctotm <- bind_rows(ctot, ctotmp, ctotmt, ctotmm) %>%
  rename(est = theta_bar, ll = lower_95CI,
         ul = upper_95CI) %>%
  mutate(ci = paste("(", sprintf('%.2f', ll), ", ",
    sprintf('%.2f', ul), ")", sep=""),
    cohort = rep(c(2019,2019,2020,2021),
                      times = 16),
         time = rep(c(2019,2021,2021,2021),
                    times = 16)) %>%
  select(bp, cohort, time, model, est, ci) %>%
  pivot_wider(names_from = model, 
    values_from = c(est, ci), names_vary = "slowest") %>%
  select(-bp)

colnames(ctotm) <- c("Cohort", "Time", 
  "ATT", "(95% CI)", "ATT", "(95% CI)", 
  "ATT", "(95% CI)", "ATT", "(95% CI)")

tt(ctotm,
   digits = 2,
   notes = list("Note: Results combined across 30 multiply-imputed datasets. ATT = Average Treatment Effect on the Treated, CDE = Controlled Direct Effect, DBP = Diastolic blood pressure, SBP = Systolic blood pressure.", 
     a = list(i=0, j=3, text = "Adjusted for age, sex, waist circumference, smoking, alcohol consumption, and use of blood pressure medication."), 
     b = list(i=0, j=c(5,7,9), text = "Mediators were set to the mean value for untreated participants at baseline."))) %>%
  group_tt(
    j = list("Indoor PM" = 5:6,
             "Indoor Temp" = 7:8,
             "PM + Temp" = 9:10)) %>%
  group_tt(
    j = list("Adjusted Total Effect" = 3:4,
             "CDE Mediated By:" = 5:10)) %>%
  style_tt(j = 1:10, align = "llcccccccc") %>%
  style_tt(j=1:10, fontsize = 0.8) %>%
  format_tt(escape = TRUE) %>%
  format_tt(j=c(3,5,7,9), sprintf = "%.2f") %>%
  group_tt(
    i = list(
        "Brachial SBP" = 1, 
        "Central SBP" = 5,
        "Brachial DBP" = 9,
        "Central DBP" = 13)) %>%
  style_tt(i = c(1,6,11,16), bold = TRUE)
```

```{r, message=F}
#| echo: FALSE
#| label: tbl-a-bp-med-het-tests
#| tbl-cap: Heterogenous treatment effects and tests for cohort-time heterogeneity across CDEs for multiple mediation blood pressure mediation model.
#| tbl-pos: H

mhet_model <- read_xlsx(here("data-clean", 
  "ct_mult_mediation_adjusted.xlsx")) %>%
  rename(est = theta_bar, ll = lower_95CI,
         ul = upper_95CI) %>%
  mutate(ci = paste("(", sprintf('%.2f', ll), ", ",
    sprintf('%.2f', ul), ")", sep=""),
  cohort = rep(c(2019,2019,2020,2021),
                      times = 4),
  time = rep(c(2019,2021,2021,2021),
                    times = 4)) %>%
  select(bp, cohort, time, est, ci) 

mhet_stats <- read_xlsx(here("data-clean",
  "heterogeneity_test_results.xlsx")) %>%
  filter(analysis == "Multiple mediation") %>%
  rename(test = `median_fstat`,
         pval = `median_p`) %>%
  mutate(bp = c("Brachial SBP", "Central SBP",
                "Brachial DBP", "Central DBP"),
         test = sprintf("%.1f", test),
         pval = sprintf("%.3f", pval),
         cohort = 2021,
         time = 2021) %>%
  select(bp, cohort, time, test, pval)

bp_mmed_het_table <- mhet_model %>% 
  left_join(mhet_stats, join_by(bp, cohort, time)) %>%
  select(-bp)

colnames(bp_mmed_het_table) <- c("Cohort", 
  "Time", "ATT", "(95% CI)",
  "F-Statistic", "p-value")

tt(bp_mmed_het_table,
   digits = 2, width = 0.7,
   notes = 
     list("Note: ATT = Average Treatment Effect on the Treated, CI = confidence interval, DiD = Difference-in-Differences, CDE = Controlled Direct Effect.", 
     a = list(i=0, j=3, text = "Adjusted for age, sex, waist circumference, smoking, alcohol consumption, and use of blood pressure medication."),
     b = list(i=0, j=5, text = "F-statistics and p-values for joint tests of equality across cohort and time ATTs"))) %>%
  group_tt(
    j = list(
      "Adjusted CDE" = 3:4,
      "Heterogeneity tests" = 5:6)) %>%
  format_tt(escape = TRUE) %>%
  format_tt(j=3, sprintf = "%.2f") %>%
  group_tt(
    i = list(
        "Brachial SBP" = 1, 
        "Central SBP" = 5,
        "Brachial DBP" = 9,
        "Central DBP" = 13)) %>%
  style_tt(i = c(1,6,11,16), bold = TRUE) %>%
  style_tt(j = 1:6, align = "llcccc")
```

\newpage

### Respiratory outcomes

Appendix tables [-@tbl-a-het-resp], [-@tbl-a-het-cough], [-@tbl-a-het-phlegm], [-@tbl-a-het-wheeze], [-@tbl-a-het-breath], [-@tbl-a-het-nochest] below show Average Treatment Effect on the Treated ($ATT$s) by treatment cohort and time. ATTs are derived from estimating marginal effects from extended two-way fixed effects models with additional adjustment for age, sex, and smoking status. 

```{r}
#| echo: FALSE
#| label: tbl-a-het-resp
#| tbl-cap: "Heterogenous treatment effects for self-reported respiratory outcomes: Any respiratory symptom."
#| tbl-pos: H


# read in personal exposure heterogeneity table
resp_any_table <- read_rds(here("outputs", 
  "resp-het-resp.rds")) %>%
  select(-outcome)

models_resp <- read_rds(here("outputs/models", 
  "r_het_tests.rds"))

models_resp_note <- paste("Note: Joint test that all ATTs are equal: ", 
    "F(", models_resp$resp$df1, ", ", 
    models_resp$resp$df2, ")= " , 
    round(models_resp$resp$statistic, digits=3), ", p= ", 
    round(models_resp$resp$p.value, digits=3),".", sep="")

colnames(resp_any_table) <- c("Cohort", "Time", 
    "ATT", "(95% CI)")

tt(resp_any_table,
   digits = 2,
   width = 0.7,
   notes = models_resp_note) %>%
  group_tt(i = list(
    "Average ATT" = 1,
    "Cohort-Time ATTs" = 2)) %>%
  style_tt(i = c(1,3), bold = TRUE) %>%
  format_tt(j=3, sprintf = "%.2f") %>%
  format_tt(escape = TRUE)

```

```{r}
#| echo: FALSE
#| label: tbl-a-het-cough
#| tbl-cap: "Heterogenous treatment effects for self-reported respiratory outcomes: Coughing."
#| tbl-pos: H


# read in personal exposure heterogeneity table
resp_cough_table <- read_rds(here("outputs", 
  "resp-het-cough.rds")) %>%
  select(-outcome)

models_resp <- read_rds(here("outputs/models", 
  "r_het_tests.rds"))

models_resp_note <- paste("Note: Joint test that all ATTs are equal: ", 
    "F(", models_resp$cough$df1, ", ", 
    models_resp$cough$df2, ")= " , 
    round(models_resp$cough$statistic, digits=3), ", p= ", 
    round(models_resp$cough$p.value, digits=3),".", sep="")

colnames(resp_cough_table) <- c("Cohort", "Time", 
    "ATT", "(95% CI)")

tt(resp_cough_table,
   digits = 2,
   width = 0.7,
   notes = models_resp_note) %>%
  group_tt(i = list(
    "Average ATT" = 1,
    "Cohort-Time ATTs" = 2)) %>%
  style_tt(i = c(1,3), bold = TRUE) %>%
  format_tt(j=3, sprintf = "%.2f") %>%
  format_tt(escape = TRUE)

```


```{r}
#| echo: FALSE
#| label: tbl-a-het-phlegm
#| tbl-cap: "Heterogenous treatment effects for self-reported respiratory outcomes: Phlegm"


# read in personal exposure heterogeneity table
resp_phlegm_table <- read_rds(here("outputs", 
  "resp-het-phlegm.rds")) %>%
  select(-outcome)

models_resp <- read_rds(here("outputs/models", 
  "r_het_tests.rds"))

models_resp_note <- paste("Note: Joint test that all ATTs are equal: ", 
    "F(", models_resp$phlegm$df1, ", ", 
    models_resp$phlegm$df2, ")= " , 
    round(models_resp$phlegm$statistic, digits=3), ", p= ", 
    round(models_resp$phlegm$p.value, digits=3),".", sep="")

colnames(resp_phlegm_table) <- c("Cohort", "Time", 
    "ATT", "(95% CI)")

tt(resp_phlegm_table,
   digits = 2,
   width = 0.7,
   notes = models_resp_note) %>%
  group_tt(i = list(
    "Average ATT" = 1,
    "Cohort-Time ATTs" = 2)) %>%
  style_tt(i = c(1,3), bold = TRUE) %>%
  format_tt(j=3, sprintf = "%.2f") %>%
  format_tt(escape = TRUE)
```

```{r}
#| echo: FALSE
#| label: tbl-a-het-wheeze
#| tbl-cap: "Heterogenous treatment effects for self-reported respiratory outcomes: Wheezing attacks."
#| tbl-pos: H


# read in personal exposure heterogeneity table
resp_wheeze_table <- read_rds(here("outputs", 
  "resp-het-wheeze.rds")) %>%
  select(-outcome)

models_resp <- read_rds(here("outputs/models", 
  "r_het_tests.rds"))

models_resp_note <- paste("Note: Joint test that all ATTs are equal: ", 
    "F(", models_resp$wheeze$df1, ", ", 
    models_resp$wheeze$df2, ")= " , 
    round(models_resp$wheeze$statistic, digits=3), ", p= ", 
    round(models_resp$wheeze$p.value, digits=3),".", sep="")

colnames(resp_wheeze_table) <- c("Cohort", "Time", 
    "ATT", "(95% CI)")

tt(resp_wheeze_table,
   digits = 2,
   width = 0.7,
   notes = models_resp_note) %>%
  group_tt(i = list(
    "Average ATT" = 1,
    "Cohort-Time ATTs" = 2)) %>%
  style_tt(i = c(1,3), bold = TRUE) %>%
  format_tt(j=3, sprintf = "%.2f") %>%
  format_tt(escape = TRUE)
```

```{r}
#| echo: FALSE
#| label: tbl-a-het-breath
#| tbl-cap: "Heterogenous treatment effects for self-reported respiratory outcomes: Trouble breathing"


# read in personal exposure heterogeneity table
resp_breath_table <- read_rds(here("outputs", 
  "resp-het-breath.rds")) %>%
  select(-outcome)

models_resp <- read_rds(here("outputs/models", 
  "r_het_tests.rds"))

models_resp_note <- paste("Note: Joint test that all ATTs are equal: ", 
    "F(", models_resp$breath$df1, ", ", 
    models_resp$breath$df2, ")= " , 
    round(models_resp$breath$statistic, digits=3), ", p= ", 
    round(models_resp$breath$p.value, digits=3),".", sep="")

colnames(resp_breath_table) <- c("Cohort", "Time", 
    "ATT", "(95% CI)")

tt(resp_breath_table,
   digits = 2,
   width = 0.7,
   notes = models_resp_note) %>%
  group_tt(i = list(
    "Average ATT" = 1,
    "Cohort-Time ATTs" = 2)) %>%
  style_tt(i = c(1,3), bold = TRUE) %>%
  format_tt(j=3, sprintf = "%.2f") %>%
  format_tt(escape = TRUE)
```

```{r}
#| echo: FALSE
#| label: tbl-a-het-nochest
#| tbl-cap: "Heterogenous treatment effects for self-reported respiratory outcomes: Chest trouble"


# read in personal exposure heterogeneity table
resp_nochest_table <- read_rds(here("outputs", 
  "resp-het-nochest.rds")) %>%
  select(-outcome)

models_resp <- read_rds(here("outputs/models", 
  "r_het_tests.rds"))

models_resp_note <- paste("Note: Joint test that all ATTs are equal: ", 
    "F(", models_resp$nochest$df1, ", ", 
    models_resp$nochest$df2, ")= " , 
    round(models_resp$nochest$statistic, digits=3), ", p= ", 
    round(models_resp$nochest$p.value, digits=3),".", sep="")

colnames(resp_nochest_table) <- c("Cohort", "Time", 
    "ATT", "(95% CI)")

tt(resp_nochest_table,
   digits = 2,
   width = 0.7,
   notes = models_resp_note) %>%
  group_tt(i = list(
    "Average ATT" = 1,
    "Cohort-Time ATTs" = 2)) %>%
  style_tt(i = c(1,3), bold = TRUE) %>%
  format_tt(j=3, sprintf = "%.2f") %>%
  format_tt(escape = TRUE)
```

\newpage

### Outdoor and personal mixed combustion

```{r}
#| echo: FALSE
#| label: fig-afig-mixed-ct
#| fig-cap: Adjusted and unadjusted treatment effect for outdoor and personal exposure (µg/m^3^) to the mixed combustion source by treatment year.
#| fig-width: 6

knitr::include_graphics(here("images", 
  "did-mixed-ct-wave.png"))
```

\newpage

## Impact of sample composition on FeNO results
@tbl-a-feno shows differences in the $ATT$s for the impact of the CBHP policy on FeNO depending on whether the estimation sample includes all individuals or is limited to those with repeated measures across campaigns.

```{r}
#| echo: FALSE
#| label: tbl-a-feno
#| tbl-cap: Effects of the CBHP policy on FeNO (ppb) based on the number of individuals with repeated measurements.
#| tbl-pos: H

tx <- tibble(
  p = c("DiD", "Adjusted DiD", "Observations"),
  est1 =c("0.17", "0.55", "794"), 
  ci1 = c("(-2.24, 2.58)", "(-2.03, 3.13)", ""),
  est2 = c("0.13", "0.24", "526"),
  ci2 = c("(-3.09, 3.35)", "(-3.19, 3.67)", ""),
  est3 = c("-0.57", "0.27", "252"),
  ci3 = c("(-3.08, 1.94)", "(-2.39, 2.92)", "")
)

colnames(tx) <- c("", "ATT", "(95% CI)", 
    "ATT", "(95% CI)", "ATT", "(95% CI)")

tt(tx, digits = 2,
   notes = "Note: ATT = Average Treatment Effect on the Treated, CI = Confidence Interval, DiD = Difference-in-Differences") %>%
  group_tt(j = list(
    "All participants" = 2:3,
    "Participants with >1 measure" = 4:5,
    "Participants with 3 measures" = 6:7)) %>%
  style_tt(j=1:7, align = 'lcccccc') %>%
  format_tt(escape = TRUE)

```

\newpage

## Impact of including Season 3 data 
@tbl-a-ind-s3 shows differences in the $ATT$s for the impact of seasonal indoor PM~2.5~ when season 3 data (collected in 41 villages during COVID-19) are included versus excluded. 

```{r}
#| echo: FALSE
#| label: tbl-a-ind-s3
#| tbl-cap: Effects of the CBHP policy on indoor seasonal PM~2.5~ based on whether Season 3 data are included vs. excluded.
#| tbl-pos: H

a_is3_table <- read_rds(here("outputs", 
  "ap-is3_table.rds")) %>%
   mutate(estimate_woS3 = na_if(estimate_woS3, 0),
          ci_woS3 = na_if(ci_woS3, "(NA, NA)"))

colnames(a_is3_table) <- c("Cohort", "Time", 
  "ATT", "(95% CI)", "ATT", "(95% CI)")

tt(a_is3_table,
   digits = 2, width = c(.5,.5,.6,1,.6,1),
   notes = "Note: ATT = Average Treatment Effect on the Treated, CI = confidence interval.") %>%
  group_tt(j = list(
    "With Season 3 data" = 3:4,
    "Without Season 3 data" = 5:6),
    i = list(
    "Average ATT" = 1,
    "Cohort-Time ATTs" = 2)) %>%
  style_tt(i = c(1,3), bold = TRUE) %>%
  format_tt(j=c(3,5), sprintf = "%.2f") %>%
  format_tt(escape = TRUE)
 
```

@fig-afig-did-opm-w3 shows the impact of including Wave 3 data on the estimates of the impact of the policy on seasonal outdoor PM~2.5~.

```{r, out.width = "60%"}
#| echo: FALSE
#| fig-cap-location: top
#| label: fig-afig-did-opm-w3
#| fig-cap: Effects of the CBHP policy on outdoor seasonal PM~2.5~ based on whether Season 3 data are included vs. excluded.
#| fig-width: 6

knitr::include_graphics(here("images", 
 "did-outdoor-w3.png"))

```


\newpage

## Pre-trends

### Blood pressure

```{r pretw3-plots, echo=FALSE, out.width="80%"}
#| fig-cap-location: top
#| label: fig-afig-pt3
#| fig-cap: "Comparison of pre-interventions trends in blood pressure between waves 1 and 2 for never treated and villages later treated in wave 3"

knitr::include_graphics(here("images", 
  "never_Y3.png"))
```


```{r, out.width = "70%"}
#| echo: FALSE
#| fig-cap-location: top
#| label: fig-afig-pt4
#| fig-cap: Comparison of pre-intervention trends in blood pressure between waves 1 and 2 for never treated and villages later treated in wave 4.

knitr::include_graphics(here("images", 
  "never_Y4.png"))
```

### Personal exposure and black carbon

```{r, out.width = "90%"}
#| echo: FALSE
#| fig-cap-location: top
#| label: fig-afig-pt5
#| fig-cap: Comparison of pre-intervention trends in personal exposure and black carbon between waves 1 and 2 for never treated and villages later treated in wave 4.

knitr::include_graphics(here("images", 
  "pe-bc-pretrends.png"))
```

### Self-reported respiratory outcomes

```{r, out.width = "90%"}
#| echo: FALSE
#| fig-cap-location: top
#| label: fig-afig-pt6
#| fig-cap: Comparison of pre-intervention trends in self-reported respiratory outcomes between waves 1 and 2 for never treated and villages later treated in wave 4.

knitr::include_graphics(here("images", 
  "resp-pretrends.png"))
```


\newpage

## Impact of group and time fixed effects
@tbl-a-fe shows the impact of adding different sets of cohort and time fixed effects to the model for personal exposure.

```{r}
#| echo: FALSE
#| label: tbl-a-fe
#| tbl-cap: "Effects of the CBHP policy on personal exposure ($\\mu g / m^{3}$) with variations in fixed effects for treatment group and time."
#| tbl-pos: H


pe_etwfe_me <- read_rds(here("outputs/models", 
  "pe_etwfe_me.rds"))
pe_etwfe_ny_me <- read_rds(here("outputs/models", 
  "pe_etwfe_ny_me.rds"))
pe_etwfe_ng_me <- read_rds(here("outputs/models", 
  "pe_etwfe_ng_me.rds"))
pe_etwfe_nfe_me <- read_rds(here("outputs/models", 
  "pe_etwfe_nfe_me.rds"))

f <- function(x) format(round(x, 0), big.mark=",")
gm <- list(
  list("raw" = "nobs", "clean" = "Observations", "fmt" = f),
  list("raw" = "FE..year", "clean" = "Year fixed effects", "fmt" = f),
  list("raw" = "FE..cohort_year", "clean" = "Cohort fixed effects", "fmt" = f))

temp_table <- modelsummary(list("Adjusted DiD" = pe_etwfe_me, 
  "No time FE" = pe_etwfe_ny_me, 
  "No group FE" = pe_etwfe_ng_me, 
  "No FE" = pe_etwfe_nfe_me), 
  coef_rename = c("treat" = "ATT"), 
  statistic = "conf.int", fmt = 2, 
  gof_omit = 'DF|Deviance|R2|AIC|BIC|RMSE',
  gof_map = gm,
  output = "tinytable")

tt(temp_table@data,
   notes = list("Note: All models adjusted for household size, smoking, outdoor temperature, and outdoor humidity. Standard errors clustered by village.")) %>%
  style_tt(i=0, bold = TRUE) %>%
  style_tt(j = 2:5, align = "c") %>%
  format_tt(escape = TRUE)

```

\newpage

# About the authors {.unnumbered}

# Other publications {.unnumbered}

Li X, Baumgartner J, Barrington-Leigh C, Harper S, Robinson B, Shen G, et al. 2022a. Socioeconomic and Demographic Associations with Wintertime Air Pollution Exposures at Household, Community, and District Scales in Rural Beijing, China. Environ Sci Technol 56:8308–8318; doi:10.1021/acs.est.1c07402.

Li X, Baumgartner J, Harper S, Zhang X, Sternbach T, Barrington-Leigh C, et al. 2022b. Field measurements of indoor and community air quality in rural Beijing before, during, and after the COVID-19 lockdown. Indoor Air 32:e13095; doi:10.1111/ina.13095.

Sternbach TJ, Harper S, Li X, Zhang X, Carter E, Zhang Y, et al. 2022. Effects of indoor and outdoor temperatures on blood pressure and central hemodynamics in a wintertime longitudinal study of Chinese adults. J Hypertension 40:1950–1959; doi:10.1097/HJH.0000000000003198.

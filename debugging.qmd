---
title: "How Do Household Energy Transitions Work?"
author: 
  - Jill Baumgartner (Co-PI)
  - Sam Harper (Co-PI)
  - On behalf of the Beijing Household Energy Transitions Team
date: today

format: 
#  html:
#    keep-md: true
#    
#  docx: 
#    toc: true
#    number-sections: true
#    number-depth: 3

 pdf:
   toc: true
   keep-tex: true
   number-sections: true
   number-depth: 3
   include-in-header:
      - text: |
         \usepackage{wrapfig}
         \usepackage{colortbl}
          \makeatletter
          \renewenvironment{table}%
            {\renewcommand\familydefault\sfdefault
             \@float{table}}
            {\end@float}
          \renewenvironment{figure}%
            {\renewcommand\familydefault\sfdefault
             \@float{figure}}
            {\end@float}
          \makeatother
         \usepackage{changes}
   geometry: 
      - right=1in
      - left=1in
   fig-pos: H
bibliography: hei-report.bib
csl: environmental-health-perspectives.csl
---
```{r packages, echo=FALSE, message = FALSE, warning = FALSE}
library(here)
library(osfr)
library(tidyverse)
library(kableExtra)
library(modelsummary)
library(readxl)
library(marginaleffects)
library(tinytable)
library(tidymodels)
```

```{r master_data, include = FALSE, cache = TRUE, echo=FALSE}
# read in master data
bhet_master_data <- osf_retrieve_node("vxur5")
bhet_master_data %>%
  osf_ls_files("Master Dataset (Seasons 1-4)",
               pattern = "csv") %>%
  osf_download(path = here("data-clean"),
               conflicts = "overwrite")
```

\newpage

# Introduction

China is deploying an ambitious policy to transition up to 70% of households in northern China from residential coal heating to electric or gas “clean” space heating, including a large-scale roll out across rural and peri-urban Beijing, referred to in this document as China’s Coal Ban and Heat Pump (CBHP) subsidy policy. To meet this target the Beijing municipal government announced a two-pronged program that designates coal-restricted areas and simultaneously offers subsidies to night-time electricity rates and for the purchase and installation of electric-powered heat pumps to replace traditional coal-heating stoves. The policy was piloted in 2015 and, starting in 2016, was rolled out on a village-by-village basis. The variability in when the policy was applied to each village allowed us to treat the roll-out of the program as a quasi-randomized intervention and evaluate its impacts on air quality and health. Household air pollution is a well-established risk factor for adverse health outcomes over the entire lifecourse, yet there is no consensus that clean energy interventions can improve these health outcomes based on evidence from randomized trials [@lai2024]. Households may be differentially affected by the CBHP due to factors such as financial constraints and user preferences, and there is uncertainty about whether and how the policy may affect indoor and outdoor air pollution, as well as heating behaviors and health outcomes.

First table:

```{r, echo=F, message=F, warning=F, eval=T}

# options(knitr.kable.NA = "\\")
tx <- tibble(
  p = factor(rep(c("New recruitment",
  "Wave 1 households", "Wave 2 households",
  "Total recruitment"),2), levels = c("New recruitment",
  "Wave 1 households", "Wave 2 households",
  "Total recruitment")),
  g = c(1,1,1,1,2,2,2,2),
  s1 = c(977,NA,NA,977, 0,NA,NA,0),
  s2 = c(196,866,NA, 1062, 300, 0,NA, 300),
  s4 = c(68, 780, 162, 1010, 52, 0, 248, 300)
)
tx2 <- tx %>% pivot_wider(names_from = g,
  values_from = c(s1, s2, s4), 
  names_vary = "slowest") %>%
  mutate(s3_2 = c(0,0,246,246)) %>%
  relocate(p,s1_1,s2_1,s4_1,s1_2,s2_2,s3_2,s4_2) 
  # rename("Sample" = p, "Wave 1" = s1_1, 
  #  "Wave 2" = s2_1, "Wave 4" = s4_1,
  #  "Wave 1" = s1_2, "Wave 2" = s2_2,
  #  "Wave 3" = s3_2, "Wave 4" = s4_2)

colnames(tx2) <- c("Sample", "Wave 1", "Wave 2", "Wave 4", 
    "Wave 1", "Wave 2", "Wave 3", "Wave 4")

tt(tx2,
   caption = "Test caption") |>
  format_tt(replace = "-") |>
  group_tt(
   j = list(
      " " = 1,
      "Overall" = 2:4,
      "Indoor" = 5:8))



#kable(tx2,
#  col.names = c("Sample", "Wave 1", "Wave 2", "Wave 4", 
#    "Wave 1", "Wave 2", "Wave 3", "Wave 4")) %>%
#  kable_styling() %>%
#  add_header_above(c(" " = 1, 
#    "Overall" = 3, "Indoor" = 4))
```

Problem table:

```{r make_table1, message=FALSE, cache=TRUE, echo=FALSE, eval=F}
# select variables for table
d <- read_csv(here("data-clean", 
  "BHET_master_data_05Mar2024.csv"),
  col_select = c("hh_id", "ptc_id", "gender_health",
    "ban_status_no", "age_health", "education_health",
    "smoking", "freq_drink", "sys_brachial", 
    "dia_brachial", "waist_circ", "height",
    "weight", "temp", "wave", "PM25conc_exposureugm3",
    "freq_cough", "freq_phlegm", "freq_wheezing", 
    "freq_breath", "freq_no_chest"))
dt <- d %>%
  # restrict to baseline
  filter(wave==1) %>%
  # select variables for inclusion
  # select(ban_status_no, age_health, )
  mutate(ever_trt = ifelse(ban_status_no==0, 1 ,0),
    et = recode_factor(ever_trt, `0` = "Never treated", 
      `1` = "Ever treated"),
    `Age (years)` = age_health,
    `Female ()` = ifelse(gender_health==2, 100, 0),
    `No education ()` = ifelse(education_health==4, 100, 0),
    `Primary education ()` = ifelse(education_health==1, 100, 0),
    `Secondary+ education ()` = ifelse(
      education_health %in% c(2,3), 100, 0),
    `Never smoker ()` = ifelse(smoking==3, 100, 0),
    `Former smoker ()` = ifelse(smoking==2, 100, 0),
    `Current smoker ()` = ifelse(smoking==1, 100, 0),
    `Never drinker ()` = ifelse(freq_drink==1, 100, 0),
    `Occasional drinker ()` = ifelse(freq_drink %in% 
      c(2:8), 100, 0),
    `Daily drinker ()` = ifelse(freq_drink==9, 100, 0),
    `Systolic (mmHg)` = sys_brachial,
    `Diastolic (mmHg)` = dia_brachial,
    `Waist circumference (cm)` = waist_circ,
    `Body mass index (kg/m2)` = weight / (height/100)^2,
    `Frequency of coughing ()` = 
      if_else(freq_cough < 3, 100, 0),
    `Frequency of phlegm ()` = 
      if_else(freq_phlegm < 3, 100, 0),
    `Frequency of wheezing ()` = 
      if_else(freq_wheezing < 3, 100, 0),
    `Shortness of breath ()` = 
      if_else(freq_breath < 3, 100, 0),
    `Chest trouble ()` = 
      if_else(freq_no_chest < 3, 100, 0),
    `Any respiratory problem ()` = if_else(
      freq_cough < 3 |
      freq_phlegm < 3 |
      freq_wheezing < 3 |
      freq_breath < 3 |
      freq_no_chest < 3, 100, 0),
    `Temperature (°C)` = temp,
    `Personal PM2.5 (ug/m3)` = PM25conc_exposureugm3) %>%
  select(et, `Age (years)`, `Female ()`, `No education ()`, 
    `Primary education ()`, `Secondary+ education ()`, 
    `Never smoker ()`, `Former smoker ()`, 
    `Current smoker ()`, `Never drinker ()`, 
    `Occasional drinker ()`, `Daily drinker ()`,
    `Systolic (mmHg)`, `Diastolic (mmHg)`,
    `Waist circumference (cm)`,
    `Body mass index (kg/m2)`, 
    `Frequency of coughing ()`,
    `Frequency of wheezing ()`,
    `Shortness of breath ()`,
    `Chest trouble ()`,
    `Any respiratory problem ()`,
    `Temperature (°C)`,
    `Personal PM2.5 (ug/m3)`)
# caption <- '\\label{#tbl-table1}Descriptive statistics, by treatment status'
reference <- ''
# add empty rows for categorical variables
# grouped categories
nrn <- c("Demographics:", "Health measures:",
  "Environmental measures:")
# empty data frame
nr <- data.frame(matrix(ncol = 7, nrow = length(nrn)))
nr$X1 <- nrn
nr[is.na(nr)] <- " "
# placement in table
attr(nr, 'position') <- c(1, 7, 23)
options(modelsummary_format_numeric_latex = "plain")
```

```{r table1, cache=TRUE, message=FALSE, echo=FALSE, eval=F}
##| label: tbl-table1
#| tbl-cap: "Descriptive statistics for selected demographic, health, and environmental measures at baseline, by treatment status"



datasummary_balance(~et, data = dt, 
  add_rows = nr, align = "rrrrrrr",
  notes = reference, output = 'tinytable')

#t1

#tinytable::tt(t1) |>
 # format_tt(escape = TRUE)
#%>%
 # kable_styling(font_size = 9) %>%
  #row_spec(c(1,7,23), bold = T)
```

Read in the data for Table 2:
```{r data-t2, echo=F, message=F, warning=FALSE, eval=F}
ds <- read_csv(here("data-clean", 
  "BHET_master_data_05Mar2024.csv"),
  col_select = c("wave", "gender_health", "age_health",
      "smoking", "waist_circ", "height", 
      "weight", "lived_with_smoker", "ID_VILLAGE")) %>%
  filter(wave != 3) %>%
  mutate(wave = as.factor(wave),
         bmi = (weight / (height/100)^2),
    female = if_else(gender_health == 2 & !is.na(gender_health),
                     1, 0),
    csmoke = if_else(smoking==1 & !is.na(smoking), 1, 0),
    asmoke = if_else(smoking < 3, 1, 
      if_else(smoking==3 & lived_with_smoker %in% 
      c(2,3), 1, 0))) %>%
  mutate(across(c(female, csmoke, asmoke), as.integer))
```

Now insert the function:
```{r tab2-function, echo=F, results=F, eval=F}
# Combined function to process columns
process_column <- function(ds, column_name) {
  column_type <- typeof(ds[[column_name]])
  
  if (column_type == "integer") {
    cprops <- ds %>% filter(wave != 3) %>%
      group_by(wave) %>%
      summarize(
        n = n(), 
        prop = mean(.data[[column_name]], na.rm=TRUE),
        np = round(n * prop, 0),
        pr = sprintf('%.1f', prop * 100)) %>% 
      select(wave, np, pr) %>% 
      pivot_wider(names_from = wave, 
                  values_from = c(np, pr), 
                  names_vary = "slowest") %>%
      mutate(char = column_name,
             w1 = paste0(np_1, " (", pr_1, ")"),
             w2 = paste0(np_2, " (", pr_2, ")"),
             w4 = paste0(np_4, " (", pr_4, ")")) %>%
      select(char, w1, w2, w4)
    
    cprop_stats <- ds %>%
      mutate(!!sym(column_name) := as.factor(.data[[column_name]])) %>%
      infer::chisq_test(as.formula(paste("wave ~", column_name))) %>%
      select(-chisq_df) %>%
      mutate(across(c('statistic', 'p_value'), 
                    ~ sprintf('%.3f', .x)))
    
    ctable <- cprops %>% bind_cols(cprop_stats)
    
  } else if (column_type == "double") {
    cmeans <- ds %>% filter(wave != 3) %>%
      group_by(wave) %>%
      summarize(
        vmean = sprintf('%.1f', mean(.data[[column_name]], 
          na.rm=TRUE)),
        vsd = sprintf('%.1f', sd(.data[[column_name]], 
          na.rm=TRUE))) %>%
      pivot_wider(names_from = wave, 
                  values_from = c(vmean, vsd), 
                  names_vary = "slowest") %>%
      mutate(char = column_name,
             w1 = paste0(vmean_1, " (", vsd_1, ")"),
             w2 = paste0(vmean_2, " (", vsd_2, ")"),
             w4 = paste0(vmean_4, " (", vsd_4, ")")) %>%
      select(char, w1, w2, w4)
    
    formula <- as.formula(paste(column_name, "~ wave"))
    
    F_hat <- ds %>% 
      infer::observe(formula, stat = "F")
    
    null_dist_theory <- ds %>%
      infer::specify(formula) %>%
      hypothesize(null = "independence") %>%
      assume(distribution = "F") %>%
      get_p_value(obs_stat = F_hat, direction = "two-sided")
    
    cmeans_stats <- F_hat %>% 
      bind_cols(null_dist_theory) %>%
      rename("statistic" = stat) %>%
      mutate(across(c('statistic', 'p_value'), 
                    ~ sprintf('%.3f', .x)))
    
    ctable <- cmeans %>% bind_cols(cmeans_stats)
  }
  
  return(ctable)
}

# Combine results for all columns
process_columns <- function(ds, columns) {
  result <- bind_rows(lapply(columns, function(col) 
    process_column(ds, col)))
  return(result)
}
```

```{r tab2-f2, echo=F, results = F}
source(here("code/functions", "process-columns.R"))
```

And then make the table (see @tbl-table2):
```{r table2, warning=F, message=F, eval=F}

# Columns of interest
columns_of_interest <- c("female", "csmoke", "asmoke", 
  "bmi", "age_health", "waist_circ")

# Apply the function to the data set
result <- process_columns(ds, columns_of_interest)

t2 <- result %>%
  mutate(char = c(
    "Female, n (%)", 
    "Current smoker, n (%)",
    "Any smoke exposure, n (%)", 
    "Age in years, Mean (SD)",
    "BMI (kg/m2), Mean (SD)", 
    "Waist circumference (cm), Mean (SD)")) %>%
  rename("Characteristic" = char)

colnames(t2) <- c("Characteristic", 
  "Wave 1 (2018-19) N=1003", "Wave 2 (2019-20) N=1110",
  "Wave 4 (2021-22) N=1028", "Statistic", "p-value")

tt(t2, caption = "Example table.\\label{tbl-table2}",
   width = c(.4, .15, .15, .15, .1, .1),
   notes = list(a = list(i=0, j=5,
     text = "Blah."))) |>
  theme_tt("multipage") |>
  group_tt(
    j = list(
      " " = 1,
      "Estimates" = 2:4,
      "Test for Equality" = 5:6)) |>
  format_tt(escape = TRUE) |>
  style_tt(j = 1:4, align = "llll")
```



---
title: "Tests"
format: 
  pdf:
    keep-tex: true
    include-in-header:
      - text: |
         \usepackage{wrapfig}
         \usepackage{colortbl}
          \makeatletter
          \renewenvironment{table}%
            {\renewcommand\familydefault\sfdefault
             \@float{table}}
            {\end@float}
          \renewenvironment{figure}%
            {\renewcommand\familydefault\sfdefault
             \@float{figure}}
            {\end@float}
          \makeatother
         \usepackage[rm]{roboto}
         \usepackage[T1]{fontenc}
          
  
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE, eval=T}
library(here)
library(osfr)
library(tidyverse)
library(readr)
library(readxl)
library(modelsummary)
library(marginaleffects)
library(kableExtra)
```

```{r set-data, inclulde=F, cache=T, message=F, warning=F, eval=F}
# read in master data
bhet_master_data <- osf_retrieve_node("vxur5")
bhet_master_data %>%
  osf_ls_files("Master Dataset (Seasons 1-4)",
               pattern = "csv") %>%
  osf_download(path = here("data-clean"),
               conflicts = "overwrite")

# read in data for Aim 1
aim_1 <- osf_retrieve_node("qsmbr")
aim_1 %>%
  osf_ls_files("Air pollution",
    pattern = "csv") %>%
  osf_download(path = here("data-clean"),
               conflicts = "overwrite")
```

Read in data
```{r data, include=FALSE, cache=TRUE, eval=F}
library(tidyverse)
library(kableExtra)
d <- read_csv(here("data-clean", 
  "BHET_master_data_05Mar2024.csv"),
  col_select = c("hh_id", "ptc_id", "gender_health",
    "ban_status_no", "age_health", "education_health",
    "smoking", "freq_drink", "sys_brachial", 
    "dia_brachial", "waist_circ", "height",
    "weight", "temp", "wave", "PM25conc_exposureugm3"))
```

```{r dag1, engine='tikz', echo=F, out.width="60%"}
#| label: fig-dag1
#| fig-cap: "Hypothetical Directed Acyclic Graph showing direct and indirect effects with outcome ($Y$), pre-treatment covariates ($X$), policy ($T$), multiple mediators ($M_{1},M_{2}$), as well as covariates for the mediators ($W$)."

\begin{tikzpicture}[shorten > = 1pt, line width=0.5pt, font=\scriptsize]
\fontfamily(roboto)
\tikzstyle{every node} = [rectangle, fill=white, draw=none]
\node (x) at (0,0) [align=center] {$X$};
\node (t) at  (1.5,0) [align=center] {Policy\\($T$)};
\node (m1) at  (3.5,1) [align=center] {PM\textsubscript{2.5}\\($M_{1}$)};
\node (m2) at  (3.5,-1) [align=center] {Indoor\\Temp\\($M_{2}$)};
\node (y) at  (5.5,0) [align=center] {SBP\\($Y$)};
\node (w) at (2,-1.5) [align=center] {$W$};
\foreach \from/\to in {x/t, t/y, t/m1, t/m2, m1/y, m2/y, w/m1, w/m2}
  \draw [->] (\from) -- (\to);
\draw [->] (x) to [bend left=45] (y.north);
\draw [->] (x) to [bend left=20] (m1);
\draw [->] (x) to [bend right=25] (m2);
\draw [->] (w) to [bend right=45] (y);
\end{tikzpicture}
```



```{r fig-dag, engine='tikz', echo=F, out.width="60%", eval=F}
\begin{tikzpicture}[shorten > = 1pt, line width=0.5pt, font=\scriptsize]
\tikzstyle{every node} = [rectangle, fill=white, draw=none]
\node (x) at (0,0) [align=center] {$X$};
\node (t) at  (1.5,0) [align=center] {Policy\\($T$)};
\node (m1) at  (3.5,1) [align=center] {PM\textsubscript{2.5}\\($M_{1}$)};
\node (m2) at  (3.5,-1) [align=center] {Indoor\\Temp\\($M_{2}$)};
\node (y) at  (5.5,0) [align=center] {SBP\\($Y$)};
\node (w) at (2,-1.5) [align=center] {$W$};
\foreach \from/\to in {x/t, t/y, t/m1, t/m2, m1/y, m2/y, w/m1, w/m2}
  \draw [->] (\from) -- (\to);
\draw [->] (x) to [bend left=45] (y.north);
\draw [->] (x) to [bend left=20] (m1);
\draw [->] (x) to [bend right=25] (m2);
\draw [->] (w) to [bend right=45] (y);
\end{tikzpicture}
```

\newpage

The source profiles for the four-factor solution are presented in Figure X. The first source was identified as dust by high percentages of crustal elements like wi-Ca, Si, and wi-Mg. The second source was constituted of non-sulfate sulfur as well as secondary inorganic ions (ammonium, nitrate, and sulfate). Non-sulfate sulfur is a tracer for primary coal combustion, while secondary inorganic ions indicate a secondary source. Since coal combustion is a major source of energy in our study area, it is likely that the second source is a mixture of primary and secondary emissions that originate from coal and other sulfurous fuel combustion. 

\begin{wrapfigure}{R}{0.7\textwidth}
\includegraphics[width=0.7\textwidth]{images/policy-implementation-map.png}
\caption{\label{fig-map}{Google scholar metrics}}
\end{wrapfigure}

Additionally, in Figure\ref{fig-map} for details. the mean source contribution of the second source is higher in outdoor than personal exposure measurements. Secondary formation occurs outdoors in the presence of sunlight, so higher outdoor concentrations compared to personal exposure further support our naming the second source and sulfur secondary. The third source had high percentages of ws-Ca nd Al, which in our study region, has been found to be indicative of transported dust from dust storms that can occur in the spring. While our samples were collected during winter months only, it is possible that transported dust from previous years still remained. The fourth source was characterized by high percentages of tracers for both coal (OC, wi-K, chloride, Pb) and biomass combustion (EC, ws-K). Coal and biomass combustion is common in our study setting so this source is likely a mixture of the two combustion sources.

```{r atbl-het, echo=F, eval=F}
options("modelsummary_format_numeric_latex" = "plain")
models_personal <- read_rds(here("outputs", "m_ppm.rds"))
data_personal <- read_rds(here("data-clean", "d_personal.rds"))

models_bc <- read_rds(here("outputs", "m_pbc.rds"))
data_bc <- read_rds(here("data-clean", "d_bc.rds"))

personal_all <- slopes(models_personal$e2, 
  newdata = subset(data_personal, treat==1), 
  variables = "treat", by = "treat")

personal_all <- personal_all %>% 
  mutate(term = "ATT(All, All)") 

personal_ct <- slopes(models_personal$e2, 
  newdata = subset(data_personal, treat==1), 
  variables = "treat", by = c("cohort_year", "year"))

personal_ct <- personal_ct %>% 
  mutate(term = c("ATT(2019, 2019)", "ATT(2019, 2021)", 
    "ATT(2020, 2021)", "ATT(2021, 2021)"))

bc_all <- slopes(models_bc$e2, 
  newdata = subset(data_bc, treat==1), 
  variables = "treat", by = "treat")

bc_all <- bc_all %>% 
  mutate(term = "ATT(All, All)") 

bc_ct <- slopes(models_bc$e2, 
  newdata = subset(data_bc, treat==1), 
  variables = "treat", by = c("cohort_year", "year"))

bc_ct <- bc_ct %>% 
  mutate(term = c("ATT(2019, 2019)", "ATT(2019, 2021)", 
    "ATT(2020, 2021)", "ATT(2021, 2021)"))

personal_panels <- list(
  "Average ATT" = list(
    "Personal: PM2.5" = personal_all, 
    "Personal: BC" = bc_all),
  "Cohort-Time ATTs" = list(
    "Personal: PM2.5" = personal_ct, 
    "Personal: BC" = bc_ct)
)

personal_note <- paste("Joint test that all ATTs are equal: ", 
    "F(", models_personal$ht1$df1, ", # ", 
    models_personal$ht1$df2, ")= " ,
    round(models_personal$ht1$statistic, digits=3), ", p= ",
    round(models_personal$ht1$p.value, digits=3), sep="")

modelsummary(
  personal_panels,
  shape = "rbind",
  gof_omit = ".*",
  estimate = "{estimate} [{conf.low}, {conf.high}]",
  statistic = NULL,
  fmt = 2, output = 'latex', 
  notes = list('First note.', 'Second note.')
)

# modelsummary(list("Adjusted ETWFE" = mstest1), 
#   shape = term ~ model, 
#   estimate = "{estimate} [{conf.low}, {conf.high}]", 
#   statistic = NULL, gof_map = "nobs", 
#   notes = paste("Joint test that all ATTs are equal: ", "F(", m_p$ht1$df1, ", # ", m_p$ht1$df2, ")= " ,round(m_p$ht1$statistic, digits=3), ", p= ", # round(m_p$ht1$p.value, digits=3), sep=""), output = 'latex')
```

Another example
```{r, echo=F, eval=T}
#| label: tbl-fuel
#| tbl-cap: "Policy impacts on self-reported fuel use (kg)"

# read in fuel use table
fuel_table <- read_rds(here("outputs", 
  "fuel-table-het.rds"))

models_coal <- read_rds(here("outputs/models", 
  "m_coal.rds"))
models_bio <- read_rds(here("outputs/models", 
  "m_biomass.rds"))

models_coal_note <- paste("Joint test that all ATTs are equal: ", 
    "F(", models_coal$ht1$df1, ", ", 
    models_coal$ht1$df2, ")= " , 
    round(models_coal$ht1$statistic, digits=3), ", p= ", 
    round(models_coal$ht1$p.value, digits=3), sep="")

models_bio_note <- paste("Joint test that all ATTs are equal: ", 
    "F(", models_bio$ht1$df1, ", ", 
    models_bio$ht1$df2, ")= " , 
    round(models_bio$ht1$statistic, digits=3), ", p= ", 
    round(models_bio$ht1$p.value, digits=3), sep="")

kable(fuel_table, digits = 0, escape = FALSE,
  col.names =c("Cohort", "Time", "ATT", "(95\\%CI)", 
   "ATT", "(95\\%CI)"), "latex", booktabs = T,
  linesep = "", align = 'cccccc') %>%
  column_spec(1:2, width = "1.5cm") %>%
  kable_styling(full_width = F) %>%
  pack_rows("Average ATT", 1, 2, indent = F) %>%
  pack_rows("Cohort-Time ATTs", 2, 5, indent = F) %>%
  add_header_above(c(" " = 2, 
    "Coal\\\\textsuperscript{a}" = 2, 
    "Biomass\\\\textsuperscript{b}" = 2),
    escape = FALSE) %>%
  footnote(alphabet=c(models_coal_note, models_bio_note)) 
```

```{r ap-season, echo=F, eval = F}
options(knitr.kable.NA = " ")
ap_season <- read_csv(here("data-clean", 
  "ap-conc-season.csv"))

ap_season %>%
  select(-time, -substance) %>%
  pivot_longer(
    cols = Mean_S1:GM_S4,
    names_to = c("avg", ".value"),
    names_pattern = "(.*)_S(.)") %>%
  pivot_wider(
    names_from = metric,
    values_from = c(`1`, `2`, `3`, `4`)
  ) %>%
  select(-category) %>%
  kable(col.names =c("", "", "",  
   "Est.", "CI", "Est.", "CI", "Est.", "CI", 
   "Est.", "CI"), "latex", booktabs = T,
  linesep = "", align = 'lllcccccccc') %>% 
  kable_styling(font_size = 9) %>% 
  # column_spec(1:3, width = "4em") #%>%
  collapse_rows(columns = 1:2, valign = "top") %>%
  pack_rows("Personal", 1, 4, indent = F) %>%
  pack_rows("Indoor", 5, 10, indent = F) %>%
  pack_rows("Outdoor", 11, 16, indent = F) %>%
  add_header_above(c(" " = 3, "Season 1" = 2,
    "Season 2" = 2, "Season 3" = 2,
    "Season 4" = 2)) %>%
  footnote(general = "Note: Est. = Estimate, CI = 95\\\\% CI, GM = Geometric Mean",  
           general_title = "", escape = F)
```


```{r, echo=F, eval=F}
med_source <- read_csv(here("data-clean", 
  "mixed_med_table_overall.csv")) 

med_source_t <- med_source %>%
  select(-type, -model) %>%
  mutate(outcome = c("Central SBP", "Central SBP",  
    "Central DBP", "Central DBP", "Central SBP",
    "Central DBP"),
    model = c(1,2,1,2,3,3)) %>%
  separate_wider_delim(att, delim = "(", 
    names = c("att", "attci"), cols_remove = TRUE) %>% 
  mutate(attci = paste("(", attci, sep="")) %>% 
  pivot_wider(names_from = "model", 
    values_from = c("att", "attci"), names_vary = "slowest")

kable(med_source_t,
  col.names =c("", "ATT", "(95%CI)", "ATT", "(95%CI)",
   "ATT", "(95%CI)"), 
   "latex", booktabs = T,
  linesep = "", align = 'lcccccc') %>%
  kable_styling(full_width = F) %>%
  add_header_above(c(" " = 1, 
    "DiD" = 2, 
    "Adjusted DiD\\\\textsuperscript{a}" = 2,
    "Adjusted CDE\\\\textsuperscript{b}" = 2),
    escape = F) %>%
  footnote(
    general = "\\\\small{Note: ATT = Average Treatment Effect on the Treated, DiD = Difference-in-Differences, CDE = Controlled Direct Effect.}",
    alphabet = c("\\\\small{Adjusted for age, sex, waist circumference, smoking, alcohol consumption, and use of blood pressure medication.}", "\\\\small{Further adjusted for mediation by mixed combustion source (coal and biomass)}"), 
    general_title = "", threeparttable = T, escape = F)
```

```{r, echo=F, eval=F}
options(knitr.kable.NA = " ")
temp_table <- read_xlsx(here("data-clean",
  "adjusted_CT_results_table.xlsx")) %>%
  select(bp, parameter, `Adjusted DiD`) %>%
  rename(attci = `Adjusted DiD`) %>%
  mutate(cohort = rep(c(2019,2019,2020,2021),
                      times = 4),
         time = rep(c(2019,2021,2021,2021),
                    times = 4)) %>%
  separate_wider_delim(attci, delim = "(", 
    names = c("att", "attci"), cols_remove = TRUE) %>% 
  mutate(attci = paste("(", attci, sep="")) %>% 
  select(bp, att, attci, cohort, time) %>%
  relocate(bp, cohort, time)


het_stats <- read_xlsx(here("data-clean",
  "ct-heterogeneity-results.xlsx")) %>%
  filter(Model == "Adjusted DiD") %>%
  rename(bp = `BP measure`,
         test = `Test statistic`,
         pval = `P-value`) %>%
  mutate(test = sprintf("%.1f", test),
         pval = sprintf("%.3f", pval),
         cohort = 2021,
         time = 2021) %>%
  select(bp, cohort, time, test, pval)

bp_het_table <- temp_table %>% 
  left_join(het_stats, join_by(bp, cohort, time)) %>%
  select(-bp)
  
kable(bp_het_table,
  col.names =c("Cohort", "Time", "ATT", "(95%CI)",
   "F-Statistic", "p-value"), 
   "latex", booktabs = T,
  linesep = "", align = 'llcccc') %>%
  column_spec(1:2, width = "2cm") %>%
  kable_styling(full_width = F) %>%
  pack_rows("Brachial SBP", 1, 4) %>%
  pack_rows("Central SBP", 5, 8) %>%
  pack_rows("Brachial DBP", 9, 12) %>%
  pack_rows("Central DBP", 13, 16) %>%
  add_header_above(c(" " = 2, 
    "Adjusted DiD\\\\textsuperscript{a}" = 2,
    "Heterogeneity tests\\\\textsuperscript{b}" = 2),
    escape = F) %>%
  footnote(
    general = "\\\\small{Note: ATT = Average Treatment Effect on the Treated, DiD = Difference-in-Differences, CDE = Controlled Direct Effect.}",
    alphabet = c("\\\\small{Adjusted for age, sex, waist circumference, smoking, alcohol consumption, and use of blood pressure medication.}", "\\\\small{F-statistics and p-values for tests of equality across cohort and time ATTs}"), 
    general_title = "", threeparttable = T, escape = F)
```


```{r, echo=F}
ctot <- read_xlsx(here("data-clean", 
  "ct_total_effect_adjusted.xlsx")) %>%
  mutate(model = 1)

ctotmp <- read_xlsx(here("data-clean", 
  "ct_pm_mediation_adjusted.xlsx")) %>%
  mutate(model = 2)

ctotmt <- read_xlsx(here("data-clean", 
  "ct_temp_mediation_adjusted.xlsx")) %>%
  mutate(model = 3)

ctotmm <- read_xlsx(here("data-clean", 
  "ct_mult_mediation_adjusted.xlsx")) %>%
  mutate(model = 4)

ctotm <- bind_rows(ctot, ctotmp, ctotmt, ctotmm) %>%
  rename(est = theta_bar, ll = lower_95CI,
         ul = upper_95CI) %>%
  mutate(ci = paste("(", sprintf('%.2f', ll), ", ",
    sprintf('%.2f', ul), ")", sep=""),
    cohort = rep(c(2019,2019,2020,2021),
                      times = 16),
         time = rep(c(2019,2021,2021,2021),
                    times = 16)) %>%
  select(bp, cohort, time, model, est, ci) %>%
  pivot_wider(names_from = model, 
    values_from = c(est, ci), names_vary = "slowest") %>%
  select(-bp)

kable(ctotm, digits = 2,
  col.names = c("Cohort", "Time", "ATT", "(95%CI)",
  "ATT", "(95%CI)", "ATT", "(95%CI)", "ATT", "(95%CI)"),
  "latex", booktabs = T, align = 'llcccccccc') %>%
  kable_styling(font_size = 10,
    latex_options = "HOLD_position") %>%
  pack_rows("Brachial SBP", 1, 4) %>%
  pack_rows("Central SBP", 5, 8) %>%
  pack_rows("Brachial DBP", 9, 12) %>%
  pack_rows("Central DBP", 13, 16) %>%
  add_header_above(c(" " = 4, 
  "Indoor PM" = 2, "Indoor Temp" = 2, "PM + Temp" = 2)) %>%
  add_header_above(c(" " = 2, 
    "Adjusted Total Effect\\\\textsuperscript{a}" = 2,
    "CDE Mediated By:\\\\textsuperscript{b}" = 6),
    escape = F) %>%
    footnote(
    general = "\\\\small{Note: Results combined across 30 multiply-imputed datasets. ATT = Average Treatment Effect on the Treated, CDE = Controlled Direct Effect, DBP = Diastolic blood pressure, SBP = Systolic blood pressure.}",
    alphabet = c("\\\\small{Adjusted for age, sex, waist circumference, smoking, alcohol consumption, and use of blood pressure medication.}", "\\\\small{Mediators were set to the mean value for untreated participants at baseline.}"), 
    general_title = "", threeparttable = T, escape = F)
```

```{r, echo=F, eval = F}
#| label: tbl-bp-het
#| tbl-cap: "Heterogenous treatment effects for the controlled direct effect of the CBHP policy on blood pressure, holding indoor PM~2.5~ and indoor temperature constant."

options(knitr.kable.NA = " ")
temp_table <- read_xlsx(here("data-clean",
  "adjusted_CT_results_table.xlsx")) %>%
  select(bp, parameter, `Adjusted DiD`) %>%
  rename(attci = `Adjusted DiD`) %>%
  mutate(cohort = rep(c(2019,2019,2020,2021),
                      times = 4),
         time = rep(c(2019,2021,2021,2021),
                    times = 4)) %>%
  separate_wider_delim(attci, delim = "(", 
    names = c("att", "attci"), cols_remove = TRUE) %>% 
  mutate(attci = paste("(", attci, sep="")) %>% 
  select(bp, att, attci, cohort, time) %>%
  relocate(bp, cohort, time)


mhet_stats <- read_xlsx(here("data-clean",
  "heterogeneity_test_results.xlsx")) %>%
  filter(Model == "Adjusted DiD") %>%
  rename(bp = `BP measure`,
         test = `Test statistic`,
         pval = `P-value`) %>%
  mutate(test = sprintf("%.1f", test),
         pval = sprintf("%.3f", pval),
         cohort = 2021,
         time = 2021) %>%
  select(bp, cohort, time, test, pval)

bp_het_table <- temp_table %>% 
  left_join(het_stats, join_by(bp, cohort, time)) %>%
  select(-bp)
  
kable(bp_het_table,
  col.names =c("Cohort", "Time", "ATT", "(95%CI)",
   "F-Statistic", "p-value"), 
   "latex", booktabs = T,
  linesep = "", align = 'llcccc') %>%
  column_spec(1:2, width = "2cm") %>%
  kable_styling(full_width = F) %>%
  pack_rows("Brachial SBP", 1, 4) %>%
  pack_rows("Central SBP", 5, 8) %>%
  pack_rows("Brachial DBP", 9, 12) %>%
  pack_rows("Central DBP", 13, 16) %>%
  add_header_above(c(" " = 2, 
    "Adjusted DiD\\\\textsuperscript{a}" = 2,
    "Heterogeneity tests\\\\textsuperscript{b}" = 2),
    escape = F) %>%
  footnote(
    general = "\\\\small{Note: ATT = Average Treatment Effect on the Treated, DiD = Difference-in-Differences, CDE = Controlled Direct Effect.}",
    alphabet = c("\\\\small{Adjusted for age, sex, waist circumference, smoking, alcohol consumption, and use of blood pressure medication.}", "\\\\small{F-statistics and p-values for joint tests of equality across cohort and time ATTs}"), 
    general_title = "", threeparttable = T, escape = F)
```

```{r, echo=F}
ctt <- read_xlsx(here("data-clean", 
  "ct_temp_table.xlsx"))

ctt_table <- ctt %>% 
  pivot_longer(!ct_labels, names_to = "outcome", 
    values_to = "est_ci", cols_vary = "slowest") %>%
  separate_wider_delim(est_ci, delim = "(", 
    names = c("att", "attci"), cols_remove = TRUE) %>% 
  mutate(attci = paste("(", attci, sep=""),
    measure = rep(c("All", "Daytime", "Heating season",
      "Daytime heating season", "All", "Heating season"),
      each = 6),
    cohort = rep(c(2019,2019,2019,2020,2020,2021), 
                 times = 6),
    time = rep(c(2019,2020,2021,2020,2021,2021), 
               times = 6)) %>%
  select(cohort, time, measure, att, attci) %>%
  relocate(measure, cohort, time)
    
kable(ctt_table, digits = 2, 
      col.names = c("", "Cohort", "Time", "ATT", "(95%CI)"),
  linesep = "", "latex", booktabs = T, align = 'lllcc') %>%
  kable_styling(font_size = 9, 
                latex_options = "HOLD_position") %>%
  collapse_rows(columns = 1, valign = "top") %>%
  pack_rows("Mean indoor temperature (°C)", 1, 24) %>%
  pack_rows("Minimum indoor temperature (°C)", 25, 36)
```

```{r, echo = F, eval=F}
ctt <- read_xlsx(here("data-clean", 
  "ct_temp_table.xlsx"))

options(knitr.kable.NA = " ")
ctt_table <- ctt %>% 
  pivot_longer(!ct_labels, names_to = "outcome", 
    values_to = "est_ci", cols_vary = "slowest") %>%
  separate_wider_delim(est_ci, delim = "(", 
    names = c("att", "attci"), cols_remove = TRUE) %>% 
  mutate(attci = paste("(", attci, sep=""),
    measure = rep(c("All", "Daytime", "Heating season",
      "Daytime heating season", "All", "Heating season"),
      each = 6),
    stat = c(rep(2, times = 24), rep(3, times = 12)),
    cohort = rep(c(2019,2019,2019,2020,2020,2021), 
                 times = 6),
    time = rep(c(2019,2020,2021,2020,2021,2021), 
               times = 6),
    att = as.numeric(att)) %>%
  select(cohort, stat, time, measure, att, attci) %>%
  relocate(measure, stat, cohort, time)

ctt_point_temp <- read_xlsx(here("data-clean",
  "unadjusted_pointtemp_results_apr3.xlsx")) %>%
  filter(type != "Overall ATT") %>%
  separate_wider_delim(att, delim = "(", 
    names = c("att", "attci"), cols_remove = TRUE) %>%
  mutate(att = as.numeric(att),
         measure = "All",
         cohort = c(2019, 2019, 2020, 2021),
         time = c(2019, 2021, 2021, 2021),
         stat = 1,
         attci = paste("(", attci, sep="")) %>%
  select(stat, measure, cohort, time, att, attci) %>%
  relocate(measure, stat, cohort, time)

ctt_temp_atts <- bind_rows(ctt_point_temp, ctt_table)

ctt_het_stats <- read_xlsx(here("data-clean",
  "gt_temp_heterogeneity.xlsx"))  %>%
  rename(measure = temp_metric,
         test = f_stat,
         pval = p_value) %>%
  mutate(measure = c("All", "Daytime", "Heating season",
      "Daytime heating season", "All", "Heating season",
      "All"),
    stat = c(2,2,2,2,3,3,1),
    test = sprintf("%.1f", test),
    pval = sprintf("%.3f", pval),
    cohort = 2021,
    time = 2021) %>%
  select(measure, stat, cohort, time, test, pval)


ctt_temp_het_table <- ctt_temp_atts %>% 
  left_join(ctt_het_stats, 
    join_by(measure, stat, cohort, time)) %>%
  pivot_wider(names_from = stat, 
    values_from = c(att,attci,test,pval), 
    names_vary = "slowest") %>%
  arrange(measure, cohort, time) %>%
  select(-measure, -test_1, -test_2, -test_3)
    
kable(ctt_temp_het_table, digits = 2, 
  col.names = c("Cohort", "Time", "ATT", "(95%CI)",
    "p-value", "ATT", "(95%CI)", "p-value",
    "ATT", "(95%CI)", "p-value"), 
  "latex", booktabs = T) %>%
  kable_styling(latex_options = "HOLD_position",
    font_size = 9) %>%
  pack_rows("All times", 1, 6) %>%
  pack_rows("Daytime", 7, 12) %>%
  pack_rows("Daytime heating", 13, 18) %>%
  pack_rows("Heating season", 19, 24) %>%
  collapse_rows(columns = 1, valign = "top") %>%
  add_header_above(c(" " = 2, "Point temp (°C)" = 3,
    "Mean temp (°C)" = 3, "Min temp (°C)" = 3))
```

```{r pret-plots, echo=FALSE, out.width = "20%"}
#| fig-cap-location: top
#| label: fig-afig-pt
#| fig-cap: "Comparison of pre-interventions trends in blood pressure between waves 1 and 2 for never treated and villages treated in waves 3 and 4."
#| fig-subcap: 
#|   - "Treated in W3: Systolic"
#|   - "Treated in W3: Diastolic"
#|   - "Treated in W4: Systolic"
#|   - "Treated in W4: Diastolic"
#| layout-nrow: 4

knitr::include_graphics(here("images", 
  "never_Y3_SBP.png"))

knitr::include_graphics(here("images", 
 "never_Y3_DBP.png"))

knitr::include_graphics(here("images", 
  "never_Y4_SBP.png"))

knitr::include_graphics(here("images", 
 "never_Y4_DBP.png"))

```
